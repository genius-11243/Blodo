<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLODO - Arsany Mina Fawzy</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');

        :root {
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f2f5 0%, #d4e0ff 100%);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            /* Removed body.sidebar-open CSS */
        }

        header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: #fff;
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-content i {
            font-size: 2rem;
        }


        h1, h2, h4 {
            margin: 0;
            font-weight: 600;
        }
        
        h4 {
            font-size: 1rem;
            opacity: 0.9;
        }

        main {
            padding: 2rem 1rem;
            display: none;
            width: 100%;
            max-width: 800px;
            margin-top: 150px;
            transition: margin-left 0.3s ease-in-out;
        }

        .container {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .main-page-container {
            text-align: center;
        }

        .main-page-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .main-page-content h2 {
            font-size: 2.5rem;
            color: #dc3545;
            margin-bottom: 0.5rem;
        }

        .main-page-content p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .main-page-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.4s, box-shadow 0.4s;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15);
            outline: none;
        }

        button {
            background-color: #dc3545;
            color: #fff;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .dual-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 1rem;
        }

        .dual-buttons button {
            width: 50%;
            text-align: center;
        }

        button:hover {
            background-color: #c82333;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.5);
        }

        .welcome-page {
            text-align: center;
        }

        .question-page {
            padding: 1.5rem 0;
        }

        .question-page h2 {
            color: #007bff;
            margin-bottom: 1.5rem;
        }

        .radio-group label {
            display: inline-block;
            margin-right: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 400;
        }
        
        .thank-you-page h2 {
            color: #28a745;
        }

        .feedback-message {
            text-align: center;
            color: #dc3545;
            margin-bottom: 1rem;
            font-weight: bold;
            opacity: 0;
            animation: fadeInOut 3s forwards;
        }

        .input-group-animation {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.5s ease-in-out;
        }
        
        .faq-item {
            margin-bottom: 1.5rem;
        }

        .faq-item h3 {
            margin-top: 0;
            color: #dc3545;
        }
        
        .faq-item p {
            line-height: 1.6;
        }

        #past-donations-list {
            list-style: none;
            padding: 0;
        }

        #past-donations-list li {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* New table styles */
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word;
        }
        
        thead tr {
            background-color: #dc3545;
            color: #fff;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tbody tr:hover {
            background-color: #e9ecef;
        }


        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
        }

        .loading-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sidebar Styling */
        .sidebar-toggle {
            position: fixed;
            top: 25px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
        }

        .sidebar-toggle:hover {
            transform: scale(1.1);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: calc(-1 * var(--sidebar-width));
            width: var(--sidebar-width);
            height: 100%;
            background-color: #2c2f33;
            color: #fff;
            padding-top: 100px;
            transition: left 0.3s ease-in-out;
            z-index: 999;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar li {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #555;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .sidebar li i {
            font-size: 1.2rem;
            color: #fff;
        }
        .sidebar li:hover {
            background-color: #dc3545;
            color: #fff;
        }
        .sidebar li:hover i {
            color: #fff;
        }
        .sidebar-logo {
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        .sidebar-logo h2 {
            color: #fff;
        }
        .sidebar-logo img {
            width: 80px;
            border-radius: 50%;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <i class="fas fa-hand-holding-heart"></i>
            <h1>BLODO</h1>
        </div>
        <h4>Arsany Mina Fawzy</h4>
    </header>

    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    <aside class="sidebar" id="sidebar">
        <ul>
            <li onclick="toggleSidebar(); showSection('main-page')"><i class="fas fa-home"></i> Home</li>
            <li onclick="toggleSidebar(); startDonation()" id="donate-sidebar-link" style="display:none;"><i class="fas fa-hand-holding-heart"></i> Donate Blood</li>
            <li onclick="toggleSidebar(); startRequest()" id="request-sidebar-link" style="display:none;"><i class="fas fa-hand-holding-medical"></i> Request Blood</li>
            <li onclick="toggleSidebar(); showReportsPage()" id="reports-sidebar-link" style="display:none;"><i class="fas fa-chart-bar"></i> View Reports</li>
            <li onclick="toggleSidebar(); showAccount()" id="account-sidebar-link" style="display:none;"><i class="fas fa-user-circle"></i> Account</li>
            <li onclick="toggleSidebar(); showChangePassword()" id="change-password-sidebar-link" style="display:none;"><i class="fas fa-key"></i> Change Password</li>
            <li onclick="toggleSidebar(); showSection('help-page')"><i class="fas fa-question-circle"></i> Help</li>
            <li onclick="toggleSidebar(); logout()" id="logout-sidebar-link" style="display:none;"><i class="fas fa-sign-out-alt"></i> Log Out</li>
        </ul>
    </aside>

    <main id="main-page">
        <div class="container main-page-container">
            <div class="main-page-content">
                <h2>Give Blood. Save Lives.</h2>
                <p>Every donation makes a difference. Join the BLODO community to find nearby hospitals and schedule your blood donation easily. Your contribution can save a life.</p>
                <div class="main-page-buttons">
                    <button onclick="showSignup()">Sign Up</button>
                    <button onclick="showLogin()">Login</button>
                </div>
            </div>
        </div>
    </main>

    <main id="signup-form">
        <div class="container">
            <h2>Sign Up</h2>
            <div id="signup-feedback" class="feedback-message"></div>
            <form id="signupForm" onsubmit="signUp(event)">
                <div class="form-group">
                    <label for="signupName">Name:</label>
                    <input type="text" id="signupName" name="signupName" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email:</label>
                    <input type="email" id="signupEmail" name="signupEmail" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password:</label>
                    <input type="password" id="signupPassword" name="signupPassword" required>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="signup-btn">
                        Sign Up
                    </button>
                </div>
            </form>
            <p style="margin-top: 1.5rem; text-align: center;">Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
        </div>
    </main>

    <main id="login-form">
        <div class="container">
            <h2>Login</h2>
            <div id="login-feedback" class="feedback-message"></div>
            <form id="loginForm" onsubmit="login(event)">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" name="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" name="loginPassword" required>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="login-btn">
                        Login
                    </button>
                </div>
            </form>
            <p style="margin-top: 1.5rem; text-align: center;">Don't have an account? <a href="#" onclick="showSignup()">Sign Up</a></p>
        </div>
    </main>

    <main id="welcome-page">
        <div class="container welcome-page">
            <h2>Welcome, <span id="welcomeName"></span>!</h2>
            <p>What would you like to do today?</p>
            <div class="main-page-buttons">
                <button onclick="startDonation()">Start Donation</button>
                <button onclick="startRequest()">Request Blood</button>
            </div>
        </div>
    </main>

    <main id="account-page">
        <div class="container">
            <h2>Your Account</h2>
            <p><strong>Name:</strong> <span id="accountName"></span></p>
            <p><strong>Email:</strong> <span id="accountEmail"></span></p>
            <div class="dual-buttons">
                <button onclick="goBack()">Go Back</button>
                <button onclick="showChangePassword()">Change Password</button>
            </div>
            <button onclick="logout()" style="width: 100%; margin-top: 1rem;">Log Out</button>
        </div>
    </main>

    <main id="change-password-page">
        <div class="container">
            <h2>Change Password</h2>
            <div id="password-feedback" class="feedback-message"></div>
            <form id="changePasswordForm" onsubmit="changePassword(event)">
                <div class="form-group">
                    <label for="currentPassword">Current Password:</label>
                    <input type="password" id="currentPassword" name="currentPassword" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password:</label>
                    <input type="password" id="newPassword" name="newPassword" required>
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">Confirm New Password:</label>
                    <input type="password" id="confirmNewPassword" name="confirmNewPassword" required>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="change-password-btn">
                        Change Password
                    </button>
                </div>
            </form>
        </div>
    </main>

    <main id="help-page">
        <div class="container">
            <h2>Frequently Asked Questions</h2>
            <div class="faq-item">
                <h3>Who can donate blood?</h3>
                <p>Most healthy adults aged 18 to 65 can donate blood. You must weigh at least 50 kg (110 lbs) and be in good general health.</p>
            </div>
            <div class="faq-item">
                <h3>How often can I donate?</h3>
                <p>You can donate whole blood every 56 days (about 8 weeks). This allows your body to fully replenish its blood volume and iron stores.</p>
            </div>
            <div class="faq-item">
                <h3>What should I do before donating?</h3>
                <p>Make sure you have had a good night's sleep, eaten a healthy meal, and are well-hydrated. Avoid drinking alcohol 24 hours before your donation.</p>
            </div>
            <div class="faq-item">
                <h3>What happens during the donation process?</h3>
                <p>The entire process, from registration to post-donation rest, takes about one hour. The actual donation itself only takes about 10 minutes.</p>
            </div>
            <p>Still have questions? Contact us at <a href="mailto:arsany.mina.nile@gmail.com">arsany.mina.nile@gmail.com</a>.</p>
            <button onclick="goBack()">Go Back</button>
        </div>
    </main>

    <main id="reports-page">
        <div class="container">
            <h2>Donations and Requests Report</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <button onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <button onclick="resetData()" style="background-color: #f44336; margin-left: auto;">
                    <i class="fas fa-redo"></i> Clear All Data
                </button>
            </div>
            
            <h3>All Donations</h3>
            <div id="donations-table-container" class="table-responsive">
                <p id="no-donations-message" style="text-align: center; color: #777;">No donations have been submitted yet.</p>
            </div>
            
            <h3 style="margin-top: 2rem;">All Requests</h3>
            <div id="requests-table-container" class="table-responsive">
                <p id="no-requests-message" style="text-align: center; color: #777;">No requests have been submitted yet.</p>
            </div>
            
            <button onclick="goBack()" style="width: 100%; margin-top: 2rem;">Go Back</button>
        </div>
    </main>

    <main id="age-page">
        <div class="container">
            <div class="question-page">
                <h2>What is your age?</h2>
                <input type="number" id="age" min="18" required>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveAge()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="blood-type-page">
        <div class="container">
            <div class="question-page">
                <h2>What is your blood type?</h2>
                <div class="radio-group">
                    <label><input type="radio" name="bloodType" value="A+"> A+</label>
                    <label><input type="radio" name="bloodType" value="A-"> A-</label>
                    <label><input type="radio" name="bloodType" value="B+"> B+</label>
                    <label><input type="radio" name="bloodType" value="B-"> B-</label>
                    <label><input type="radio" name="bloodType" value="AB+"> AB+</label>
                    <label><input type="radio" name="bloodType" value="AB-"> AB-</label>
                    <label><input type="radio" name="bloodType" value="O+"> O+</label>
                    <label><input type="radio" name="bloodType" value="O-"> O-</label>
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveBloodType()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="city-page">
        <div class="container">
            <div class="question-page">
                <h2>What city do you live in?</h2>
                <select id="city">
                    <option value="">Select a city</option>
                    <option value="Cairo">Cairo</option>
                    <option value="Alexandria">Alexandria</option>
                    <option value="Giza">Giza</option>
                    <option value="Other">Other</option>
                </select>
                <div class="input-group-animation">
                    <input type="text" id="otherCity" placeholder="Enter city if 'Other' is selected">
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveCity()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="hospital-page">
        <div class="container">
            <div class="question-page">
                <h2>Which hospital do you want to donate to?</h2>
                <select id="hospital">
                    <option value="">Select a hospital</option>
                    <option value="Farid Habib">Farid Habib</option>
                    <option value="Agial Hospital">Agial Hospital</option>
                    <option value="Other">Other</option>
                </select>
                <div class="input-group-animation">
                    <input type="text" id="otherHospital" placeholder="Enter hospital if 'Other' is selected">
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveHospital()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="date-page">
        <div class="container">
            <div class="question-page">
                <h2>What is the date you want to donate?</h2>
                <input type="date" id="donationDate" required>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveDate()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="sickness-page">
        <div class="container">
            <div class="question-page">
                <h2>Do you have any sicknesses?</h2>
                <div class="form-group">
                    <textarea id="sickness" rows="4" placeholder="Enter any sicknesses or 'None'" required></textarea>
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveSickness()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="review-page">
        <div class="container">
            <h2>Review Your Answers</h2>
            <p><strong>Age:</strong> <span id="reviewAge"></span></p>
            <p><strong>Blood Type:</strong> <span id="reviewBloodType"></span></p>
            <p><strong>City:</strong> <span id="reviewCity"></span></p>
            <p><strong>Hospital:</strong> <span id="reviewHospital"></span></p>
            <p><strong>Donation Date:</strong> <span id="reviewDate"></span></p>
            <p><strong>Sicknesses:</strong> <span id="reviewSickness"></span></p>
            <div class="dual-buttons">
                <button onclick="goBack()">Go Back</button>
                <button onclick="confirmDonation()">Confirm</button>
            </div>
        </div>
    </main>

    <main id="request-blood-page">
        <div class="container">
            <h2>Request Blood</h2>
            <div class="form-group">
                <label for="requestBloodType">Blood Type Needed:</label>
                <select id="requestBloodType">
                    <option value="">Select blood type</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
            </div>
            <div class="form-group">
                <label for="requestCity">City:</label>
                <select id="requestCity">
                    <option value="">Select a city</option>
                    <option value="Cairo">Cairo</option>
                    <option value="Alexandria">Alexandria</option>
                    <option value="Giza">Giza</option>
                    <option value="Other">Other</option>
                </select>
                <div class="input-group-animation">
                    <input type="text" id="otherRequestCity" placeholder="Enter city if 'Other' is selected">
                </div>
            </div>
            <div class="form-group">
                <label for="requestDate">Date Needed:</label>
                <input type="date" id="requestDate" required>
            </div>
            <div class="form-group">
                <label for="requestReason">Reason for Request:</label>
                <textarea id="requestReason" rows="4" placeholder="e.g., Surgery, Accident, Medical Condition" required></textarea>
            </div>
            <div class="dual-buttons">
                <button onclick="goBack()">Go Back</button>
                <button onclick="submitRequest()">Submit Request</button>
            </div>
        </div>
    </main>

    <main id="thank-you-page">
        <div class="container thank-you-page">
            <h2>Thank You!</h2>
            <p>Your donation is greatly appreciated. You've made a difference!</p>
            <p>We will contact you shortly.</p>
            <button onclick="showSection('welcome-page')">Start Over</button>
        </div>
    </main>

    <main id="request-thank-you-page">
        <div class="container thank-you-page">
            <h2>Request Submitted!</h2>
            <p>Your blood request has been submitted. We will notify you when a match is found.</p>
            <button onclick="showSection('welcome-page')">Start Over</button>
        </div>
    </main>

    <script>
        // Load data from Local Storage on startup
        let user = JSON.parse(localStorage.getItem('currentUser')) || null;
        let userPassword = localStorage.getItem('userPassword') || "password123";
        let donationData = {};
        const pageHistory = [];
        let feedbackTimer = null;
        let allDonations = JSON.parse(localStorage.getItem('allDonations')) || [];
        let allRequests = JSON.parse(localStorage.getItem('allRequests')) || [];

        // Function to save all persistent data to Local Storage
        function saveData() {
            localStorage.setItem('currentUser', JSON.stringify(user));
            localStorage.setItem('userPassword', userPassword);
            localStorage.setItem('allDonations', JSON.stringify(allDonations));
            localStorage.setItem('allRequests', JSON.stringify(allRequests));
        }

        // Helper function to show a temporary message
        function showMessage(elementId, message) {
            const feedbackElement = document.getElementById(elementId);
            feedbackElement.textContent = message;
            feedbackElement.style.opacity = '1';
            clearTimeout(feedbackTimer);
            feedbackTimer = setTimeout(() => {
                feedbackElement.style.opacity = '0';
            }, 3000);
        }

        // Helper function to hide all main sections
        function hideAllSections() {
            document.querySelectorAll('main').forEach(section => {
                section.style.display = 'none';
            });
        }

        // Helper function to show a specific section and manage history
        function showSection(sectionId, addToHistory = true) {
            hideAllSections();
            if (addToHistory && pageHistory[pageHistory.length - 1] !== sectionId) {
                pageHistory.push(sectionId);
            }
            document.getElementById(sectionId).style.display = 'block';
        }

        // Helper function to navigate back
        function goBack() {
            if (pageHistory.length > 1) {
                pageHistory.pop();
                const previousPageId = pageHistory[pageHistory.length - 1];
                showSection(previousPageId, false);
            } else {
                showSection('main-page');
            }
        }

        // Toggles the sidebar open and closed (No body shift)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
            // document.body.classList.toggle('sidebar-open'); // Removed this line to fix the white space issue
        }

        // Handles the persistent login process
        function login(event) {
            event.preventDefault();
            const loginBtn = document.getElementById('login-btn');
            loginBtn.innerHTML = '<i class="fas fa-spinner loading-icon"></i> Processing...';
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (password !== userPassword) {
                showMessage('login-feedback', "Incorrect email or password.");
                loginBtn.innerHTML = 'Login';
                return;
            }

            if (!email || !password) {
                showMessage('login-feedback', "Please enter your email and password.");
                loginBtn.innerHTML = 'Login';
                return;
            }

            // Since we only check the password for the simplest persistent login:
            setTimeout(() => {
                // If a user is stored, load it, otherwise set up a new session object
                const storedUser = JSON.parse(localStorage.getItem('currentUser'));
                if (storedUser) {
                    user = storedUser;
                } else {
                    user = { name: "Test User", email: email };
                    saveData(); // Save temporary user for persistence
                }
                startSession();
                loginBtn.innerHTML = 'Login';
            }, 1000);
        }

        // Handles the persistent sign-up process
        function signUp(event) {
            event.preventDefault();
            const signupBtn = document.getElementById('signup-btn');
            signupBtn.innerHTML = '<i class="fas fa-spinner loading-icon"></i> Processing...';
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            if (!name || !email || !password) {
                showMessage('signup-feedback', "Please fill in all fields.");
                signupBtn.innerHTML = 'Sign Up';
                return;
            }

            setTimeout(() => {
                user = { name: name, email: email };
                userPassword = password;
                saveData(); // Save new user and password to local storage
                startSession();
                signupBtn.innerHTML = 'Sign Up';
            }, 1000);
        }

        // After successful login/signup, show the welcome page and update the sidebar
        function startSession() {
            if (user) {
                document.getElementById('welcomeName').textContent = user.name;
                document.getElementById('accountName').textContent = user.name;
                document.getElementById('accountEmail').textContent = user.email;

                // Show logged-in sidebar links using 'flex' for correct display
                document.getElementById('logout-sidebar-link').style.display = 'flex';
                document.getElementById('donate-sidebar-link').style.display = 'flex';
                document.getElementById('request-sidebar-link').style.display = 'flex';
                document.getElementById('reports-sidebar-link').style.display = 'flex';
                document.getElementById('account-sidebar-link').style.display = 'flex';
                document.getElementById('change-password-sidebar-link').style.display = 'flex';

                showSection('welcome-page');
            } else {
                // Hide logged-in sidebar links
                document.getElementById('logout-sidebar-link').style.display = 'none';
                document.getElementById('donate-sidebar-link').style.display = 'none';
                document.getElementById('request-sidebar-link').style.display = 'none';
                document.getElementById('reports-sidebar-link').style.display = 'none';
                document.getElementById('account-sidebar-link').style.display = 'none';
                document.getElementById('change-password-sidebar-link').style.display = 'none';
                showSection('main-page');
            }
        }
        
        // Donation Flow Functions
        function startDonation() {
            if (user) {
                donationData = { name: user.name, email: user.email };
                showSection('age-page');
            } else {
                alert("Please log in to start a donation.");
                showSection('login-form');
            }
        }

        function saveAge() {
            const age = document.getElementById('age').value;
            if (!age || age < 18) {
                alert("Please enter a valid age (18 or older).");
                return;
            }
            donationData.age = age;
            showSection('blood-type-page');
        }

        function saveBloodType() {
            const bloodType = document.querySelector('input[name="bloodType"]:checked');
            if (!bloodType) {
                alert("Please select your blood type.");
                return;
            }
            donationData.bloodType = bloodType.value;
            showSection('city-page');
        }

        function saveCity() {
            const city = document.getElementById('city').value;
            const otherCity = document.getElementById('otherCity').value;

            if (city === "" && otherCity.trim() === "") {
                alert("Please select or enter your city.");
                return;
            }
            donationData.city = (city === 'Other' ? otherCity.trim() : city);
            showSection('hospital-page');
        }

        function saveHospital() {
            const hospital = document.getElementById('hospital').value;
            const otherHospital = document.getElementById('otherHospital').value;

            if (hospital === "" && otherHospital.trim() === "") {
                alert("Please select or enter your hospital.");
                return;
            }
            donationData.hospital = (hospital === 'Other' ? otherHospital.trim() : hospital);
            showSection('date-page');
        }
        
        function saveDate() {
            const date = document.getElementById('donationDate').value;
            if (!date) {
                alert("Please select a donation date.");
                return;
            }
            donationData.date = date;
            showSection('sickness-page');
        }

        function saveSickness() {
            const sickness = document.getElementById('sickness').value.trim();
            if (sickness === "") {
                alert("Please enter any sicknesses, or 'None' if you have none.");
                return;
            }
            donationData.sickness = sickness;
            showReviewPage();
        }

        function showReviewPage() {
            document.getElementById('reviewAge').textContent = donationData.age;
            document.getElementById('reviewBloodType').textContent = donationData.bloodType;
            document.getElementById('reviewCity').textContent = donationData.city;
            document.getElementById('reviewHospital').textContent = donationData.hospital;
            document.getElementById('reviewDate').textContent = donationData.date;
            document.getElementById('reviewSickness').textContent = donationData.sickness;
            showSection('review-page');
        }

        // Confirms donation and saves to Local Storage
        function confirmDonation() {
            allDonations.push(donationData);
            localStorage.setItem('allDonations', JSON.stringify(allDonations));
            showSection('thank-you-page');
        }
        
        // Request Blood Flow
        function startRequest() {
            if (user) {
                showSection('request-blood-page');
            } else {
                alert("Please log in to request blood.");
                showSection('login-form');
            }
        }

        // Submits request and saves to Local Storage
        function submitRequest() {
            const bloodType = document.getElementById('requestBloodType').value;
            const city = document.getElementById('requestCity').value;
            const otherCity = document.getElementById('otherRequestCity').value;
            const date = document.getElementById('requestDate').value;
            const reason = document.getElementById('requestReason').value.trim();

            if (!bloodType) {
                alert("Please select a blood type.");
                return;
            }
            if (city === "" && otherCity.trim() === "") {
                alert("Please select or enter a city.");
                return;
            }
            if (!date) {
                alert("Please select a date.");
                return;
            }
            if (reason === "") {
                alert("Please enter a reason for the request.");
                return;
            }

            const requestData = {
                name: user.name,
                email: user.email,
                bloodType: bloodType,
                city: (city === 'Other' ? otherCity.trim() : city),
                date: date,
                reason: reason
            };
            
            allRequests.push(requestData);
            localStorage.setItem('allRequests', JSON.stringify(allRequests));
            showSection('request-thank-you-page');
        }
        
        // View Reports Functionality
        function showReportsPage() {
            if (!user) {
                alert("Please log in to view reports.");
                showSection('login-form');
                return;
            }
            showSection('reports-page');
            renderDonationsTable();
            renderRequestsTable();
        }

        function renderDonationsTable() {
            const container = document.getElementById('donations-table-container');
            if (allDonations.length === 0) {
                container.innerHTML = '<p id="no-donations-message" style="text-align: center; color: #777;">No donations have been submitted yet.</p>';
                return;
            }
            
            let tableHTML = '<table><thead><tr><th>Name</th><th>Email</th><th>Age</th><th>Blood Type</th><th>City</th><th>Hospital</th><th>Date</th><th>Sicknesses</th></tr></thead><tbody>';
            allDonations.forEach(donation => {
                tableHTML += `<tr>
                    <td>${donation.name}</td>
                    <td>${donation.email}</td>
                    <td>${donation.age}</td>
                    <td>${donation.bloodType}</td>
                    <td>${donation.city}</td>
                    <td>${donation.hospital}</td>
                    <td>${donation.date}</td>
                    <td>${donation.sickness}</td>
                </tr>`;
            });
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function renderRequestsTable() {
            const container = document.getElementById('requests-table-container');
            if (allRequests.length === 0) {
                container.innerHTML = '<p id="no-requests-message" style="text-align: center; color: #777;">No requests have been submitted yet.</p>';
                return;
            }

            let tableHTML = '<table><thead><tr><th>Name</th><th>Email</th><th>Blood Type</th><th>City</th><th>Date</th><th>Reason</th></tr></thead><tbody>';
            allRequests.forEach(request => {
                tableHTML += `<tr>
                    <td>${request.name}</td>
                    <td>${request.email}</td>
                    <td>${request.bloodType}</td>
                    <td>${request.city}</td>
                    <td>${request.date}</td>
                    <td>${request.reason}</td>
                </tr>`;
            });
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }
        
        function exportToExcel() {
            const donationsCsv = convertToCsv(allDonations, ['name', 'email', 'age', 'bloodType', 'city', 'hospital', 'date', 'sickness']);
            const requestsCsv = convertToCsv(allRequests, ['name', 'email', 'bloodType', 'city', 'date', 'reason']);
            
            let combinedCsv = '';
            
            if (donationsCsv) {
                combinedCsv += 'Donations\n';
                combinedCsv += donationsCsv;
            }
            
            if (requestsCsv) {
                if (donationsCsv) {
                    combinedCsv += '\n\n';
                }
                combinedCsv += 'Requests\n';
                combinedCsv += requestsCsv;
            }
            
            if (!donationsCsv && !requestsCsv) {
                alert("There is no data to export.");
                return;
            }
            
            // Add UTF-8 BOM to ensure correct display in Excel
            const bom = '\uFEFF';
            const finalCsv = bom + combinedCsv;
            
            const blob = new Blob([finalCsv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "BLODO_Report.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function convertToCsv(data, headers) {
            if (data.length === 0) return '';
            
            let csv = headers.join(',') + '\n';
            data.forEach(item => {
                const row = headers.map(header => {
                    let value = item[header] || '';
                    value = String(value).replace(/"/g, '""');
                    if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                        value = `"${value}"`;
                    }
                    return value;
                });
                csv += row.join(',') + '\n';
            });
            return csv;
        }
        
        // Clears all data from the app and Local Storage
        function resetData() {
            if (confirm("Are you sure you want to clear all data? This action cannot be undone.")) {
                allDonations = [];
                allRequests = [];
                localStorage.removeItem('allDonations');
                localStorage.removeItem('allRequests');
                renderDonationsTable();
                renderRequestsTable();
                alert("All data has been cleared.");
            }
        }

        function showLogin() {
            showSection('login-form');
        }

        function showSignup() {
            showSection('signup-form');
        }

        function showAccount() {
            if (user) {
                showSection('account-page');
            } else {
                alert("Please log in to view your account.");
                showSection('login-form');
            }
        }
        
        function showChangePassword() {
            if (user) {
                showSection('change-password-page');
            } else {
                alert("Please log in to change your password.");
                showSection('login-form');
            }
        }

        // Updates the persistent password
        function changePassword(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;

            if (currentPassword !== userPassword) {
                showMessage('password-feedback', "Current password is incorrect.");
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showMessage('password-feedback', "New passwords do not match.");
                return;
            }

            userPassword = newPassword;
            localStorage.setItem('userPassword', userPassword); // Save new password
            showMessage('password-feedback', "Password changed successfully!");
        }

        // Clears the user session from memory and Local Storage
        function logout() {
            user = null;
            localStorage.removeItem('currentUser'); // Remove session from storage
            alert("You have been logged out.");
            startSession();
        }

        // Event listeners for "Other" input animation
        document.addEventListener('DOMContentLoaded', function() {
            const citySelect = document.getElementById('city');
            const otherCityInput = document.getElementById('otherCity').parentElement;
            if (citySelect) {
                citySelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        otherCityInput.style.maxHeight = otherCityInput.scrollHeight + "px";
                    } else {
                        otherCityInput.style.maxHeight = '0';
                    }
                });
            }

            const hospitalSelect = document.getElementById('hospital');
            const otherHospitalInput = document.getElementById('otherHospital').parentElement;
            if (hospitalSelect) {
                hospitalSelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        otherHospitalInput.style.maxHeight = otherHospitalInput.scrollHeight + "px";
                    } else {
                        otherHospitalInput.style.maxHeight = '0';
                    }
                });
            }

            const requestCitySelect = document.getElementById('requestCity');
            const otherRequestCityInput = document.getElementById('otherRequestCity').parentElement;
            if (requestCitySelect) {
                requestCitySelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        otherRequestCityInput.style.maxHeight = otherRequestCityInput.scrollHeight + "px";
                    } else {
                        otherRequestCityInput.style.maxHeight = '0';
                    }
                });
            }

            // Start the session based on whether a user is loaded from local storage
            startSession();
        });
    </script>
</body>
</html>
