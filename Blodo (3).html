<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLODO - Arsany Mina Fawzy</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');

        :root {
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f2f5 0%, #d4e0ff 100%);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: #fff;
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Approximate height of the header */
            min-height: 100px;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-content i {
            font-size: 2rem;
        }


        h1, h2, h4 {
            margin: 0;
            font-weight: 600;
        }
        
        h4 {
            font-size: 1rem;
            opacity: 0.9;
        }

        main {
            padding: 2rem 1rem;
            display: none;
            width: 100%;
            max-width: 800px;
            margin-top: 150px;
            transition: margin-left 0.3s ease-in-out;
        }

        .container {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        /* NEW: Profile Picture Styles */
        .profile-pic-container {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #eee;
        }
        .profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #dc3545;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        /* NEW: Chatbot Styles */
        .bot-message, .user-message {
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 0.95rem;
        }
        .bot-message {
            background-color: #e9ecef; /* Light gray */
            color: #333;
            margin-right: auto;
            border-top-left-radius: 0;
        }
        .user-message {
            background-color: #dc3545; /* Red */
            color: #fff;
            margin-left: auto;
            border-top-right-radius: 0;
            text-align: right;
        }
        .chatbot-page #chat-window {
            height: 50vh; /* Make the chat window taller */
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }

        /* NEW: Floating Chatbot Button */
        #chatbot-float-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background-color: #007bff; /* Blue color */
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 2rem;
            z-index: 1002; /* Higher than sidebar toggle */
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.5);
            transition: transform 0.3s ease-in-out, background-color 0.3s;
        }
        
        #chatbot-float-btn:hover {
            background-color: #0056b3;
            transform: scale(1.1) translateY(-3px);
        }


        .main-page-container {
            text-align: center;
        }

        .main-page-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .main-page-content h2 {
            font-size: 2.5rem;
            color: #dc3545;
            margin-bottom: 0.5rem;
        }

        .main-page-content p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .main-page-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.4s, box-shadow 0.4s;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15);
            outline: none;
        }
        
        /* PASSWORD VISIBILITY STYLES */
        .password-container {
            position: relative;
        }
        .password-container input {
            padding-right: 40px !important; /* Make space for the icon */
        }
        .toggle-password {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 1rem;
            transition: color 0.2s;
            z-index: 10;
        }
        .toggle-password:hover {
            color: #dc3545;
        }

        button {
            background-color: #dc3545;
            color: #fff;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .dual-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 1rem;
        }

        .dual-buttons button {
            width: 50%;
            text-align: center;
        }

        button:hover {
            background-color: #c82333;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.5);
        }
        
        /* Override for the blue chatbot button hover */
        #chatbot-float-btn:hover {
            background-color: #0056b3;
            transform: scale(1.1) translateY(-3px);
        }

        .welcome-page {
            text-align: center;
        }

        .main-page-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .main-page-content h2 {
            font-size: 2.5rem;
            color: #dc3545;
            margin-bottom: 0.5rem;
        }

        .main-page-content p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .main-page-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.4s, box-shadow 0.4s;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15);
            outline: none;
        }
        
        /* PASSWORD VISIBILITY STYLES */
        .password-container {
            position: relative;
        }
        .password-container input {
            padding-right: 40px !important; /* Make space for the icon */
        }
        .toggle-password {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 1rem;
            transition: color 0.2s;
            z-index: 10;
        }
        .toggle-password:hover {
            color: #dc3545;
        }

        button {
            background-color: #dc3545;
            color: #fff;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .dual-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 1rem;
        }

        .dual-buttons button {
            width: 50%;
            text-align: center;
        }

        button:hover {
            background-color: #c82333;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.5);
        }
        
        /* Override for the blue chatbot button hover */
        #chatbot-float-btn:hover {
            background-color: #0056b3;
            transform: scale(1.1) translateY(-3px);
        }

        .welcome-page {
            text-align: center;
        }
        
        /* NEW: Reminder Banner Style */
        .reminder-banner {
            background-color: #ffc107;
            color: #333;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            animation: pulse 1.5s infinite;
        }

        /* NEW: Pulse animation for the reminder banner */
        @keyframes pulse {
            0% { box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(255, 193, 7, 0.8); }
            100% { box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4); }
        }

        .question-page {
            padding: 1.5rem 0;
        }

        .question-page h2 {
            color: #007bff;
            margin-bottom: 1.5rem;
        }

        .radio-group label {
            display: inline-block;
            margin-right: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 400;
        }
        
        .thank-you-page h2 {
            color: #28a745;
        }
        
        /* NEW: Confirmation Page Styling */
        #confirm-attendance-page h2 {
            color: #dc3545;
        }
        #confirm-attendance-page p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }
        #confirm-attendance-page strong {
            color: #007bff;
        }

        /* NEW: Style for the Donation Centers list */
        #centers-list .review-card {
            border: 2px solid #ddd;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            border-radius: 10px;
        }


        .feedback-message {
            text-align: center;
            /* Default to error color, but will be set by JS */
            color: #dc3545; 
            margin-bottom: 1rem;
            font-weight: bold;
            /* Start invisible to allow the fadeInOut animation to work */
            opacity: 0; 
            min-height: 1.5rem; /* Reserve space to prevent layout shift */
        }
        
        /* The animation should only be applied by JS on success/failure */
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        .input-group-animation {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.5s ease-in-out;
        }
        
        .faq-item {
            margin-bottom: 1.5rem;
        }

        .faq-item h3 {
            margin-top: 0;
            color: #dc3545;
        }
        
        .faq-item p {
            line-height: 1.6;
        }

        /* New table styles */
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word;
        }
        
        thead tr {
            background-color: #dc3545;
            color: #fff;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tbody tr:hover {
            background-color: #e9ecef;
        }
        
        /* Awards & Badges Page Styles */
        .awards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 2rem;
            text-align: center;
        }
        
        .badge-card {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #ddd;
            transition: transform 0.3s;
        }
        
        .badge-card.unlocked {
            border-color: gold;
            background: linear-gradient(145deg, #fffbe0, #fff);
        }

        .badge-icon {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 10px;
        }
        
        .badge-card.unlocked .badge-icon {
            color: gold;
        }
        
        .badge-name {
            font-weight: 700;
            color: #333;
        }


        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .loading-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sidebar Toggle Styling (Left Button) */
        .sidebar-toggle {
            position: fixed;
            top: 25px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
        }

        /* New style for the persistent Home button (Right Button) */
        .home-button-toggle {
            position: fixed;
            top: 25px;
            right: 20px; /* Position on the right side */
            width: 50px;
            height: 50px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            z-index: 1001; /* Ensure it's above the header */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
        }
        
        .sidebar-toggle:hover, .home-button-toggle:hover {
            transform: scale(1.1);
        }

        .sidebar {
            position: fixed;
            /* FIX 1: Shift sidebar below the header */
            top: 100px; 
            left: calc(-1 * var(--sidebar-width));
            width: var(--sidebar-width);
            height: calc(100vh - 100px); /* Fill remaining viewport height */
            background-color: #2c2f33;
            color: #fff;
            padding-top: 0;
            transition: left 0.3s ease-in-out;
            z-index: 999;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar li {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #555;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        /* Make sure logged-in LI items are still displayed as flex when shown */
        .sidebar li[style*="display: flex"] {
            display: flex !important;
        }
        .sidebar li i {
            font-size: 1.2rem;
            color: #fff;
        }
        .sidebar li:hover {
            background-color: #dc3545;
            color: #fff;
        }
        .sidebar li:hover i {
            color: #fff;
        }
        
        /* --- REVIEW STAR STYLING --- */
        .rating-stars {
            font-size: 2rem;
            cursor: pointer;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: center;
        }
        .rating-stars .fa-star {
            color: #ccc;
            transition: color 0.2s;
        }
        .rating-stars .fa-star.checked,
        .review-card .card-rating .fa-star.checked,
        .rating-stars .fa-star:hover,
        .rating-stars .fa-star:hover ~ .fa-star {
            color: gold;
        }
        /* --- END: REVIEW STAR STYLING --- */
        
        /* --- REVIEW HISTORY CARD STYLING --- */
        .reviews-list-container {
            max-height: 500px; /* Limit height of the review list */
            overflow-y: auto; /* Enable scrolling */
            padding-right: 15px; /* Space for scrollbar */
        }
        
        .review-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .review-card p {
            margin: 0.5rem 0;
        }
        .review-card strong {
            color: #dc3545;
        }
        .review-card .card-rating i {
            color: #ccc; /* Resetting star color for card */
        }
        .review-card .card-rating .fa-star.checked {
            color: gold; /* Only checked stars are gold */
        }
        
        /* Edit button on review card */
        .review-card .edit-btn {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        .review-card .edit-btn:hover {
            background-color: #0056b3;
            transform: none; /* Override general button hover transform */
            box-shadow: none;
        }
        
        /* --- Sticker Selector --- */
        .sticker-option {
            cursor: pointer;
            transition: transform 0.2s;
            opacity: 0.8;
            padding: 5px; /* Increase hit area */
        }
        .sticker-option:hover {
            transform: scale(1.3);
            opacity: 1;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <i class="fas fa-hand-holding-heart"></i>
            <h1>BLODO</h1>
        </div>
        <h4>Arsany Mina Fawzy</h4>
    </header>

    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    
    <button class="home-button-toggle" onclick="goToHome()">
        <i class="fas fa-home"></i>
    </button>
    
    <button id="chatbot-float-btn" onclick="showSection('chatbot-page')">
        <i class="fas fa-question"></i>
    </button>
    
    <aside class="sidebar" id="sidebar">
        <ul>
            <li onclick="toggleSidebar(); goToHome()"><i class="fas fa-home"></i> Home</li> 
            <li onclick="toggleSidebar(); startDonation()" id="donate-sidebar-link" style="display:none;"><i class="fas fa-hand-holding-heart"></i> Donate Blood</li>
            <li onclick="toggleSidebar(); startRequest()" id="request-sidebar-link" style="display:none;"><i class="fas fa-hand-holding-medical"></i> Request Blood</li>
            <li onclick="toggleSidebar(); renderDonationCenters()" id="centers-sidebar-link"><i class="fas fa-map-marker-alt"></i> Find Donation Centers</li>
            <li onclick="toggleSidebar(); showReportsPage()" id="reports-sidebar-link" style="display:none;"><i class="fas fa-chart-bar"></i> View Reports</li>
            <li onclick="toggleSidebar(); showAwardsBadges()" id="awards-sidebar-link" style="display:none;"><i class="fas fa-trophy"></i> Awards & Badges</li>
            <li onclick="toggleSidebar(); showAccount()" id="account-sidebar-link" style="display:none;"><i class="fas fa-user-circle"></i> Account</li>
            <li onclick="toggleSidebar(); showChangePassword()" id="change-password-sidebar-link" style="display:none;"><i class="fas fa-key"></i> Change Password</li>
            <li onclick="toggleSidebar(); showReviewsHistoryPage()"><i class="fas fa-comments" id="reviews-history-sidebar-link"></i> View Reviews</li>
            <li onclick="toggleSidebar(); showReviewForm()" id="review-sidebar-link" style="display:none;"><i class="fas fa-star"></i> Submit Review</li>
            <li onclick="toggleSidebar(); showSection('chatbot-page'); pageHistory.length = 0;"><i class="fas fa-question-circle"></i> Help</li>
            <li onclick="toggleSidebar(); logout()" id="logout-sidebar-link" style="display:none;"><i class="fas fa-sign-out-alt"></i> Log Out</li>
        </ul>
    </aside>

    <main id="main-page">
        <div class="container main-page-container">
            <div class="main-page-content">
                <h2>Give Blood. Save Lives.</h2>
                <p>Every donation makes a difference. Join the BLODO community to find nearby hospitals and schedule your blood donation easily. Your contribution can save a life.</p>
                <div class="main-page-buttons">
                    <button onclick="showSignup()">Sign Up</button>
                    <button onclick="showLogin()">Login</button>
                </div>
            </div>
        </div>
    </main>

    <main id="signup-form">
        <div class="container">
            <h2>Sign Up</h2>
            <div id="signup-feedback" class="feedback-message"></div>
            <form id="signupForm" onsubmit="signUp(event)">
                <div class="form-group">
                    <label for="signupName">Name:</label>
                    <input type="text" id="signupName" name="signupName" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email:</label>
                    <input type="email" id="signupEmail" name="signupEmail" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password:</label>
                    <div class="password-container">
                        <input type="password" id="signupPassword" name="signupPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('signupPassword', this)"></i>
                    </div>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="signup-btn">
                        Sign Up
                    </button>
                </div>
            </form>
            <p style="margin-top: 1.5rem; text-align: center;">Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
        </div>
    </main>

    <main id="login-form">
        <div class="container">
            <h2>Login</h2>
            <div id="login-feedback" class="feedback-message"></div>
            <form id="loginForm" onsubmit="login(event)">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" name="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" name="loginPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('loginPassword', this)"></i>
                    </div>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="login-btn">
                        Login
                    </button>
                </div>
            </form>
            <p style="margin-top: 1.5rem; text-align: center;">Don't have an account? <a href="#" onclick="showSignup()">Sign Up</a></p>
        </div>
    </main>

    <main id="welcome-page">
        <div class="container welcome-page">
            
            <div id="appointment-reminder" class="reminder-banner" style="display:none;">
                <i class="fas fa-bell"></i> 
                <span id="reminder-text"></span>
            </div>

            <h2>Welcome, <span id="welcomeName"></span>!</h2>
            <p>What would you like to do today?</p>
            <div class="main-page-buttons">
                <button onclick="startDonation()">Start Donation</button>
                <button onclick="startRequest()">Request Blood</button>
            </div>
            
             <div id="upcoming-appointment-card" class="review-card" style="margin-top: 2rem; display: none;">
                <p><strong>Upcoming Donation Appointment:</strong></p>
                <p>Date: <span id="upcoming-date"></span></p>
                <p>Hospital: <span id="upcoming-hospital"></span></p>
                <p style="font-size: 0.9rem; color: #dc3545; margin-top: 10px;">To change this, simply start a new donation process which will overwrite this appointment.</p>
                <button onclick="clearUnconfirmedDonation()" style="background-color: #f44336; width: 100%; margin-top: 0.5rem;">Clear Appointment</button>
            </div>
            
        </div>
    </main>

    <main id="account-page">
        <div class="container">
            <h2>Your Account</h2>
            
            <div class="profile-pic-container">
                <img id="profile-picture-display" src="https://via.placeholder.com/100/dc3545/ffffff?text=U" alt="Profile Picture" class="profile-pic">
                <input type="file" id="profile-picture-input" accept="image/*" style="display: none;" onchange="handleProfilePictureChange(event)">
                <button onclick="document.getElementById('profile-picture-input').click()" style="width: 100%; background-color: #007bff; margin-top: 1rem; border-radius: 8px; box-shadow: none; transform: none; padding: 0.75rem 1rem;">
                    <i class="fas fa-upload"></i> Choose Picture
                </button>
                <button onclick="removeProfilePicture()" style="width: 100%; background-color: #f44336; margin-top: 0.5rem; border-radius: 8px; box-shadow: none; transform: none; padding: 0.75rem 1rem;" id="remove-profile-pic-btn">
                    <i class="fas fa-trash"></i> Remove Picture
                </button>
            </div>
            
            <p style="margin-top: 2rem;"><strong>Name:</strong> <span id="accountName"></span></p>
            <p><strong>Email:</strong> <span id="accountEmail"></span></p>
            <div class="dual-buttons">
                <button onclick="goBack()">Go Back</button>
                <button onclick="showChangePassword()">Change Password</button>
            </div>
            <button onclick="logout()" style="width: 100%; margin-top: 1rem;">Log Out</button>
        </div>
    </main>

    <main id="change-password-page">
        <div class="container">
            <h2>Change Password</h2>
            <div id="password-feedback" class="feedback-message"></div>
            <form id="changePasswordForm" onsubmit="changePassword(event)">
                <div class="form-group">
                    <label for="currentPassword">Current Password:</label>
                    <div class="password-container">
                        <input type="password" id="currentPassword" name="currentPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('currentPassword', this)"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password:</label>
                    <div class="password-container">
                        <input type="password" id="newPassword" name="newPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('newPassword', this)"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">Confirm New Password:</label>
                    <div class="password-container">
                        <input type="password" id="confirmNewPassword" name="confirmNewPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('confirmNewPassword', this)"></i>
                    </div>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="change-password-btn">
                        Change Password
                    </button>
                </div>
            </form>
        </div>
    </main>
    
    <main id="awards-badges-page">
        <div class="container">
            <h2>Your Donor Achievements</h2>
            <p>Keep track of your life-saving milestones!</p>
            <div id="awards-grid" class="awards-grid">
                </div>
            <button onclick="goBack()" style="width: 100%; margin-top: 2rem;">Go Back</button>
        </div>
    </main>

    <main id="review-form-page">
        <div class="container">
            <h2>Submit a Review</h2>
            <div id="review-feedback" class="feedback-message"></div>
            <form id="reviewForm" onsubmit="submitReview(event)">
                <div class="form-group" style="text-align: center;">
                    <label for="reviewRating">Your Rating:</label>
                    <div class="rating-stars" id="rating-stars">
                        <i class="fas fa-star" data-rating="1"></i>
                        <i class="fas fa-star" data-rating="2"></i>
                        <i class="fas fa-star" data-rating="3"></i>
                        <i class="fas fa-star" data-rating="4"></i>
                        <i class="fas fa-star" data-rating="5"></i>
                    </div>
                    <input type="hidden" id="reviewRating" name="reviewRating" value="0" required>
                </div>
                
                <div class="form-group">
                    <label>Add a Sticker (Optional - click to prepend to comment):</label>
                    <div id="sticker-selector" style="display: flex; gap: 15px; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem;">
                        <span class="sticker-option" data-sticker="❤️" title="Love It" onclick="addSticker(this)">❤️</span>
                        <span class="sticker-option" data-sticker="👍" title="Thumbs Up" onclick="addSticker(this)">👍</span>
                        <span class="sticker-option" data-sticker="🌟" title="Five Stars" onclick="addSticker(this)">🌟</span>
                        <span class="sticker-option" data-sticker="😊" title="Happy" onclick="addSticker(this)">😊</span>
                        <span class="sticker-option" data-sticker="🩸" title="Blood Drop" onclick="addSticker(this)">🩸</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="reviewComment">Comments / Suggestions:</label>
                    <textarea id="reviewComment" rows="5" placeholder="Share your experience with BLODO..." required></textarea>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit">Submit Review</button>
                </div>
            </form>
        </div>
    </main>
    
    <main id="reviews-history-page">
        <div class="container">
            <h2>Community Reviews</h2>
            <p>See what others are saying about the BLODO service. Your review will be marked with **(You)** and have an **Edit button**.</p>
            <div id="reviews-list-container" class="reviews-list-container" style="margin-top: 1.5rem;">
                <p id="no-reviews-message" style="text-align: center; color: #777;">No reviews have been submitted yet.</p>
            </div>
            <button onclick="goBack()" style="width: 100%; margin-top: 1.5rem;">Go Back</button>
        </div>
    </main>

    <main id="help-page">
        <div class="container">
            <h2>Frequently Asked Questions</h2>
            <div class="faq-item">
                <h3>Who can donate blood?</h3>
                <p>Most healthy adults aged 18 to 65 can donate blood. You must weigh at least 50 kg (110 lbs) and be in good general health.</p>
            </div>
            <div class="faq-item">
                <h3>How often can I donate?</h3>
                <p>You can donate whole blood every 56 days (about 8 weeks). This allows your body to fully replenish its blood volume and iron stores.</p>
            </div>
            <div class="faq-item">
                <h3>What should I do before donating?</h3>
                <p>Make sure you have had a good night's sleep, eaten a healthy meal, and are well-hydrated. Avoid drinking alcohol 24 hours before your donation.</p>
            </div>
            <div class="faq-item">
                <h3>What happens during the donation process?</h3>
                <p>The entire process, from registration to post-donation rest, takes about one hour. The actual donation itself only takes about 10 minutes.</p>
            </div>
            <p>Still have questions? Contact us at <a href="mailto:arsany.mina.nile@gmail.com">arsany.mina.nile@gmail.com</a>.</p>
            <button onclick="goBack()">Go Back</button>
        </div>
    </main>

    <main id="chatbot-page" class="chatbot-page">
        <div class="container">
            <h2>Advanced BLODO Chatbot <i class="fas fa-robot"></i></h2>
            <div id="chat-window" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 1rem; background-color: #f8f9fa;">
                <p class="bot-message">Hello! I'm your **Advanced BLODO Chatbot**. I can answer questions about blood donation, hospitals, and your account statistics. How can I help you today? Try asking about **your stats** or **hospital supply**.</p>
            </div>
            <div id="chat-input-container" style="display: flex; gap: 10px;">
                <input type="text" id="chat-input" placeholder="Ask me anything..." style="flex-grow: 1;">
                <button onclick="sendMessage()" style="padding: 0.75rem 1rem; border-radius: 8px;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <button onclick="goBack()" style="width: 100%; margin-top: 1rem;">Go Back</button>
        </div>
    </main>

    <main id="reports-page">
        <div class="container">
            <h2>Donations and Requests Report</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <button onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <button onclick="resetData()" style="background-color: #f44336; margin-left: auto;">
                    <i class="fas fa-redo"></i> Clear All Data
                </button>
            </div>
            
            <h3>All Donations</h3>
            <div id="donations-table-container" class="table-responsive">
                <p id="no-donations-message" style="text-align: center; color: #777;">No donations have been submitted yet.</p>
            </div>
            
            <h3 style="margin-top: 2rem;">All Requests</h3>
            <div id="requests-table-container" class="table-responsive">
                <p id="no-requests-message" style="text-align: center; color: #777;">No requests have been submitted yet.</p>
            </div>
            
            <button onclick="goBack()" style="width: 100%; margin-top: 2rem;">Go Back</button>
        </div>
    </main>

    <main id="age-page">
        <div class="container">
            <div class="question-page">
                <h2>What is your age?</h2>
                <input type="number" id="age" min="18" required>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveAge()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="blood-type-page">
        <div class="container">
            <div class="question-page">
                <h2>What is your blood type?</h2>
                <div class="radio-group">
                    <label><input type="radio" name="bloodType" value="A+"> A+</label>
                    <label><input type="radio" name="bloodType" value="A-"> A-</label>
                    <label><input type="radio" name="bloodType" value="B+"> B+</label>
                    <label><input type="radio" name="bloodType" value="B-"> B-</label>
                    <label><input type="radio" name="bloodType" value="AB+"> AB+</label>
                    <label><input type="radio" name="bloodType" value="AB-"> AB-</label>
                    <label><input type="radio" name="bloodType" value="O+"> O+</label>
                    <label><input type="radio" name="bloodType" value="O-"> O-</label>
                </div>
                <div class="dual-buttons">
                    <button onclick="goToPreviousFlowStep()">Go Back</button>
                    <button onclick="saveBloodType()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="city-page">
        <div class="container">
            <div class="question-page">
                <h2>What city do you live in?</h2>
                <select id="city">
                    <option value="">Select a city</option>
                    <option value="Cairo">Cairo</option>
                    <option value="Alexandria">Alexandria</option>
                    <option value="Giza">Giza</option>
                    <option value="Other">Other</option>
                </select>
                <div class="input-group-animation">
                    <input type="text" id="otherCity" placeholder="Enter city if 'Other' is selected">
                </div>
                <div class="dual-buttons">
                    <button onclick="goToPreviousFlowStep()">Go Back</button>
                    <button onclick="saveCity()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="hospital-page">
        <div class="container">
            <div class="question-page">
                <h2>Which hospital do you want to donate to?</h2>
                <select id="hospital">
                    <option value="">Select a hospital</option>
                    </select>
                <div class="input-group-animation">
                    <input type="text" id="otherHospital" placeholder="Enter hospital if 'Other' is selected">
                </div>
                <div class="dual-buttons">
                    <button onclick="goToPreviousFlowStep()">Go Back</button>
                    <button onclick="saveHospital()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="date-page">
        <div class="container">
            <div class="question-page">
                <h2>What is the date you want to donate?</h2>
                <input type="date" id="donationDate" required>
                <div class="dual-buttons">
                    <button onclick="goToPreviousFlowStep()">Go Back</button>
                    <button onclick="saveDate()">Next</button>
                </div>
            </div>
        </div>
    </main>
    
    <main id="donation-warning-page">
        <div class="container">
            <div class="question-page">
                <h2 style="color: #ffc107;">⚠️ Warning: Short Interval Donation</h2>
                <p>According to standard guidelines, you should wait at least <strong>56 days</strong> between whole blood donations.</p>
                <p>Your last recorded donation was on <strong id="lastDonationDateDisplay"></strong>, and the next recommended date is <strong id="nextRecommendedDateDisplay"></strong>.</p>
                <p>The date you selected, <strong id="selectedDonationDateDisplay"></strong>, is less than 56 days after your last donation.</p>
                <p><strong>Are you sure you want to proceed?</strong> Skipping this warning may make you ineligible at the donation center.</p>
                <div class="dual-buttons">
                    <button onclick="goToPreviousFlowStep()">Go Back & Change Date</button>
                    <button onclick="skipWarning()" style="background-color: #ffc107; color: #333; box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);">Skip Warning & Proceed</button>
                </div>
            </div>
        </div>
    </main>
    <main id="sickness-page">
        <div class="container">
            <div class="question-page">
                <h2>Do you have any sicknesses?</h2>
                <div class="form-group">
                    <textarea id="sickness" rows="4" placeholder="Enter any sicknesses or 'None'" required></textarea>
                </div>
                <div class="dual-buttons">
                    <button onclick="goToPreviousFlowStep()">Go Back</button>
                    <button onclick="saveSickness()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="review-page">
        <div class="container">
            <h2>Review Your Answers</h2>
            <p><strong>Age:</strong> <span id="reviewAge"></span></p>
            <p><strong>Blood Type:</strong> <span id="reviewBloodType"></span></p>
            <p><strong>City:</strong> <span id="reviewCity"></span></p>
            <p><strong>Hospital:</strong> <span id="reviewHospital"></span></p>
            <p><strong>Donation Date:</strong> <span id="reviewDate"></span></p>
            <p><strong>Sicknesses:</strong> <span id="reviewSickness"></span></p>
            <div class="dual-buttons">
                <button onclick="goToPreviousFlowStep()">Go Back</button>
                <button onclick="confirmDonation()">Confirm Appointment</button>
            </div>
        </div>
    </main>

    <main id="request-blood-page">
        <div class="container">
            <h2>Request Blood</h2>
            <div class="form-group">
                <label for="requestBloodType">Blood Type Needed:</label>
                <select id="requestBloodType">
                    <option value="">Select blood type</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
            </div>
            <div class="form-group">
                <label for="requestCity">City:</label>
                <select id="requestCity">
                    <option value="">Select a city</option>
                    <option value="Cairo">Cairo</option>
                    <option value="Alexandria">Alexandria</option>
                    <option value="Giza">Giza</option>
                    <option value="Other">Other</option>
                </select>
                <div class="input-group-animation">
                    <input type="text" id="otherRequestCity" placeholder="Enter city if 'Other' is selected">
                </div>
            </div>
            <div class="form-group">
                <label for="requestDate">Date Needed:</label>
                <input type="date" id="requestDate" required>
            </div>
            <div class="form-group">
                <label for="requestReason">Reason for Request:</label>
                <textarea id="requestReason" rows="4" placeholder="e.g., Surgery, Accident, Medical Condition" required></textarea>
            </div>
            <div class="dual-buttons">
                <button onclick="goBack()">Go Back</button>
                <button onclick="submitRequest()">Submit Request</button>
            </div>
        </div>
    </main>
    
    <main id="donation-centers-page">
        <div class="container">
            <h2>Local Donation Centers and Supply Needs</h2>
            <p>Below is a list of known donation centers and their current estimated blood supply needs. **The list and needs update daily.** Contact the center directly to confirm your appointment.</p>
            
            <div style="margin-bottom: 1.5rem;">
                <input type="text" id="center-search-input" placeholder="Search by name, city, or need level..." onkeyup="filterCenters()">
            </div>
            
            <div id="centers-list">
            </div>
            
            <button onclick="goBack()" style="width: 100%; margin-top: 2rem;">Go Back</button>
        </div>
    </main>

    <main id="confirm-attendance-page">
        <div class="container">
            <h2><i class="fas fa-question-circle" style="color: #dc3545;"></i> Did You Attend?</h2>
            <p>We see your scheduled appointment for **<strong id="unconfirmed-date-display"></strong>** at **<strong id="unconfirmed-hospital-display"></strong>** has passed. Can you confirm if you attended your donation appointment?</p>
            <p>Your honest response helps us keep your donor records and badge progress accurate.</p>
            <div class="dual-buttons">
                <button onclick="confirmAttendance(true)" style="background-color: #28a745;">
                    <i class="fas fa-check-circle"></i> Yes, I went!
                </button>
                <button onclick="confirmAttendance(false)" style="background-color: #f44336;">
                    <i class="fas fa-times-circle"></i> No, I missed it.
                </button>
            </div>
        </div>
    </main>

    <main id="thank-you-page">
        <div class="container thank-you-page">
            <h2>Appointment Confirmed!</h2>
            <p>Your appointment for **<span id="confirmed-date"></span>** is now recorded as a **pending donation**. We will ask you to confirm your attendance on your next visit after the scheduled date.</p>
            <button onclick="goToHome()">Return Home</button>
        </div>
    </main>

    <main id="request-thank-you-page">
        <div class="container thank-you-page">
            <h2>Request Submitted!</h2>
            <p>Your blood request has been submitted. We will notify you when a match is found.</p>
            <button onclick="goToHome()">Start Over</button>
        </div>
    </main>

    <main id="review-thank-you-page">
        <div class="container thank-you-page">
            <h2>Review Updated!</h2>
            <p>Thank you for your valuable feedback. It helps us improve BLODO!</p>
            <p>You can see your review and others on the "View Reviews" page.</p>
            <button onclick="showReviewsHistoryPage()">View Reviews</button>
        </div>
    </main>

    <script>
        // Load data from Local Storage on startup
        let user = JSON.parse(localStorage.getItem('currentUser')) || null;
        let userPassword = localStorage.getItem('userPassword') || "password123";
        let donationData = {};
        const pageHistory = [];
        let feedbackTimer = null;
        let allDonations = JSON.parse(localStorage.getItem('allDonations')) || [];
        let allRequests = JSON.parse(localStorage.getItem('allRequests')) || [];
        // NEW: unconfirmedDonation tracks the ID and details of the most recent donation that needs confirmation
        let unconfirmedDonation = JSON.parse(localStorage.getItem('unconfirmedDonation')) || null;
        let isLoggedIn = user !== null;
        let allReviews = JSON.parse(localStorage.getItem('allReviews')) || [];
        
        // --- Daily Randomization Logic ---
        // Comprehensive list of all possible donation centers
        const ALL_HOSPITALS_DATA = [
            { name: 'Farid Habib Hospital', city: 'Giza', contact: '02-1234-5678', address: '15 El-Gomhoria St, Dokki' },
            { name: 'Agial Hospital', city: 'Cairo', contact: '02-9876-5432', address: '7 Ahmed Orabi St, Maadi' },
            { name: 'National Blood Bank', city: 'Alexandria', contact: '03-1122-3344', address: '42 Corniche Rd, Roshdy' },
            { name: 'El Salam International Hospital', city: 'Giza', contact: '02-2468-1357', address: '22 Mohy El Din Abu El Ezz St, Mohandessin' },
            { name: 'Dar El Fouad Hospital', city: 'Cairo', contact: '02-5555-4444', address: 'Street 9, District 5, New Cairo' },
            { name: 'Misr International Hospital', city: 'Giza', contact: '02-7777-1111', address: '6 October City, Central Spine' },
            { name: 'Cleopatra Hospital', city: 'Cairo', contact: '02-8888-2222', address: 'El Hegaz Street, Heliopolis' },
            { name: 'Andalusia Smouha Hospital', city: 'Alexandria', contact: '03-9999-3333', address: 'Smouha District, Fountain Square' },
            { name: 'Specialist Hospital Mansoura', city: 'Mansoura', contact: '050-1234-9876', address: 'El Geish Street, Mansoura' },
            { name: 'Al Mokhtabar Lab', city: 'Tanta', contact: '040-5678-0123', address: 'El Bahr Street, Tanta' }
        ];

        // A simple seedable PRNG function (Mulberry32) to ensure daily consistency
        function mulberry32(a) {
            return function() {
                var t = a += 0x6d2b79f5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        // Function to generate the daily list of active hospitals and their needs
        function generateDailyHospitalData() {
            const today = new Date();
            // Create a seed based on the date (YYYYMMDD)
            const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
            const random = mulberry32(seed);

            // 1. Shuffle and select a subset (e.g., 6 hospitals each day)
            const shuffledHospitals = [...ALL_HOSPITALS_DATA].sort(() => random() - 0.5);
            const dailyHospitals = shuffledHospitals.slice(0, 6);

            // 2. Assign random but consistent need levels for the day
            const needLevels = ['Critical', 'Urgent', 'Good Supply'];
            
            return dailyHospitals.map(hospital => {
                const needIndex = Math.floor(random() * needLevels.length);
                const need_level = needLevels[needIndex];
                return { ...hospital, need_level: need_level };
            });
        }

        // Initialize the daily hospital list once at script start
        let HOSPITAL_LOCATIONS = generateDailyHospitalData();
        
        // --- Awards Data (unchanged) ---
        const AWARDS = [
            { id: 'first-timer', name: 'First Timer', description: 'Complete your first donation.', icon: 'fas fa-medal', requiredDonations: 1 },
            { id: 'triple-donor', name: 'Triple Donor', description: 'Complete 3 donations.', icon: 'fas fa-star', requiredDonations: 3 },
            { id: 'super-saver', name: 'Super Saver', description: 'Complete 5 donations.', icon: 'fas fa-trophy', requiredDonations: 5 },
            { id: 'marathon-donor', name: 'Marathon Donor', description: 'Complete 10 total donations.', icon: 'fas fa-running', requiredDonations: 10 },
            { id: 'universal-donor', name: 'Universal Donor', description: 'Be a universally required O- blood type.', icon: 'fas fa-globe', requiredDonations: 0, isBloodType: true },
            { id: 'local-hero', name: 'Local Hero', description: 'Complete 3 donations in your registered city.', icon: 'fas fa-city', requiredDonations: 3, isLocal: true },
            { id: 'initial-hero-gift', name: 'Initial Hero Gift', description: 'Complete the first three donations and get a discount!', icon: 'fas fa-gift', requiredDonations: 3 },
        ];


        // --- Helper Functions ---
        
        function showFeedback(elementId, message, isError = true) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.color = isError ? '#dc3545' : '#28a745';
            element.style.opacity = '1';
            element.style.animation = 'fadeInOut 5s forwards'; // Apply animation
            
            if (feedbackTimer) {
                clearTimeout(feedbackTimer);
            }

            // Manually clear the animation class after it finishes 
            feedbackTimer = setTimeout(() => {
                element.style.animation = ''; // Remove animation after it plays
            }, 5000); 
        }
        
        function togglePasswordVisibility(id, iconElement) {
            const input = document.getElementById(id);
            if (input.type === "password") {
                input.type = "text";
                iconElement.classList.remove('fa-eye');
                iconElement.classList.add('fa-eye-slash');
            } else {
                input.type = "password";
                iconElement.classList.remove('fa-eye-slash');
                iconElement.classList.add('fa-eye');
            }
        }


        function formatNeedLevel(level) {
            let color = '';
            switch (level) {
                case 'Critical': color = '#dc3545'; break;
                case 'Urgent': color = '#ffc107'; break;
                case 'Good Supply': color = '#28a745'; break;
                default: color = '#6c757d';
            }
            return `<span style="font-weight: 700; color: ${color};">${level}</span>`;
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function showSection(id) {
            // Push current page to history before showing new one (unless it's the home page and history is empty)
            const visiblePage = document.querySelector('main[style*="display: block"]');
            if (visiblePage && visiblePage.id !== id) {
                // Ensure we don't double-push the same page
                if (pageHistory[pageHistory.length - 1] !== visiblePage.id) {
                    pageHistory.push(visiblePage.id);
                }
            }
            
            document.querySelectorAll('main').forEach(main => {
                main.style.display = 'none';
            });
            const newPage = document.getElementById(id);
            if (newPage) {
                newPage.style.display = 'block';
                // Remove all previous animations before applying a new one
                // newPage.classList.remove('container-animation'); 
                // void newPage.offsetWidth; // Trigger reflow
                // newPage.classList.add('container-animation'); // Removed to avoid potential visual glitches in a contained environment
            }
            
            if (id === 'welcome-page') {
                updateWelcomePage();
            } else if (id === 'reports-page') {
                renderReports();
            } else if (id === 'awards-badges-page') {
                renderAwardsBadges();
            } else if (id === 'reviews-history-page') {
                renderReviewsHistory();
            } else if (id === 'account-page') {
                showAccount();
            }
        }
        
        function goBack() {
            if (pageHistory.length > 0) {
                const previousPageId = pageHistory.pop();
                // Pop the flow step if returning to a flow page from a general page
                if (donationFlow.includes(previousPageId)) {
                    currentFlowIndex = donationFlow.indexOf(previousPageId);
                }
                showSection(previousPageId);
            } else {
                // If on a login/signup form, go to main. If already logged in, go to welcome.
                if (isLoggedIn) {
                    showSection('welcome-page');
                } else {
                    showSection('main-page');
                }
            }
        }

        function showHelpPage() {
            pageHistory.length = 0; // NEW: Reset history for direct access from sidebar
            showSection('help-page');
        }

        function showChatbotPage() {
            pageHistory.length = 0; // NEW: Reset history for direct access from floating button
            showSection('chatbot-page');
        }
        
        function goBackFromChatbot() {
            goBack();
        }


        function showLogin() {
            // Standard forward push, no history clear needed here
            const currentPage = document.querySelector('main[style*="display: block"]');
            if (currentPage && currentPage.id !== 'login-form') {
                pageHistory.push(currentPage.id);
            }
            showSection('login-form');
        }

        function showSignup() {
            // Standard forward push, no history clear needed here
            const currentPage = document.querySelector('main[style*="display: block"]');
            if (currentPage && currentPage.id !== 'signup-form') {
                pageHistory.push(currentPage.id);
            }
            showSection('signup-form');
        }
        
        function goToHome() {
            pageHistory.length = 0; // *** FIX: Reset history for a clean slate when clicking Home ***
            currentFlowIndex = -1; // Also reset flow index
            if (isLoggedIn) {
                showSection('welcome-page');
            } else {
                showSection('main-page');
            }
        }
        
        // --- Authentication & User Management ---
        
        function signUp(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            // Basic validation
            if (!name || !email || !password) {
                showFeedback('signup-feedback', 'Please fill in all required fields.', true);
                return;
            }

            if (password.length < 6) {
                showFeedback('signup-feedback', 'Password must be at least 6 characters long.', true);
                return;
            }

            // Simple check to see if user exists (using email as unique key)
            if (localStorage.getItem('userEmail') === email) {
                showFeedback('signup-feedback', 'User already exists. Please login.', true);
                return;
            }

            user = { name, email, city: null, donations: [] };
            localStorage.setItem('currentUser', JSON.stringify(user));
            // In a real app, this would be hashed and stored server-side.
            localStorage.setItem('userPassword', password); 
            localStorage.setItem('userEmail', email); 
            isLoggedIn = true;
            
            updateHeaderLinks(true);

            // FIX: Use showFeedback and a slight delay before redirecting
            showFeedback('signup-feedback', '✅ Sign Up successful! Redirecting...', false);
            setTimeout(() => goToHome(), 1000); // Wait 1 second before redirection
        }

        function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            // Basic validation
            if (!email || !password) {
                showFeedback('login-feedback', 'Please fill in all required fields.', true);
                return;
            }

            // Simple validation
            if (localStorage.getItem('userEmail') !== email || localStorage.getItem('userPassword') !== password) {
                showFeedback('login-feedback', 'Invalid email or password.', true);
                return;
            }
            
            // Reload the user data from storage
            user = JSON.parse(localStorage.getItem('currentUser'));
            isLoggedIn = true;
            
            updateHeaderLinks(true);
            
            // FIX: Use showFeedback and a slight delay before redirecting
            showFeedback('login-feedback', '✅ Login successful! Redirecting...', false);
            setTimeout(() => goToHome(), 1000); // Wait 1 second before redirection
        }

        function logout() {
            user = null;
            isLoggedIn = false;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('donationInProgress');
            localStorage.removeItem('unconfirmedDonation'); // Clear unconfirmed donation on logout
            updateHeaderLinks(false);
            goToHome(); // Use goToHome which clears history
            showFeedback('login-feedback', 'Logged out successfully.', false);
        }
        
        function showAccount() {
            if (!isLoggedIn) return goToHome();
            pageHistory.length = 0; // *** FIX: Reset history for sidebar jump ***
            document.getElementById('accountName').textContent = user.name;
            document.getElementById('accountEmail').textContent = user.email;
            
            // NEW: Load Profile Picture
            const picDisplay = document.getElementById('profile-picture-display');
            const removeBtn = document.getElementById('remove-profile-pic-btn');
            if (user.profilePicUrl) {
                picDisplay.src = user.profilePicUrl;
                removeBtn.style.display = 'block';
            } else {
                // Default image with the user's initial
                const initial = user.name ? user.name.charAt(0).toUpperCase() : 'U';
                picDisplay.src = `https://via.placeholder.com/100/dc3545/ffffff?text=${initial}`;
                removeBtn.style.display = 'none';
            }
            showSection('account-page');
        }
        
        function showChangePassword() {
            if (!isLoggedIn) return goToHome();
            pageHistory.length = 0; // *** FIX: Reset history for sidebar jump ***
            document.getElementById('changePasswordForm').reset();
            showSection('change-password-page');
        }
        
        function changePassword(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const feedback = document.getElementById('password-feedback');

            if (currentPassword !== localStorage.getItem('userPassword')) {
                showFeedback('password-feedback', 'Current password is incorrect.', true);
                return;
            }

            if (newPassword.length < 6) {
                showFeedback('password-feedback', 'New password must be at least 6 characters long.', true);
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showFeedback('password-feedback', 'New passwords do not match.', true);
                return;
            }

            localStorage.setItem('userPassword', newPassword);
            showFeedback('password-feedback', 'Password changed successfully!', false);
            document.getElementById('changePasswordForm').reset();
            
            // Optionally redirect after a brief delay
            setTimeout(() => goBack(), 1000); 
        }
        
        // NEW: Profile Picture Handlers
        function handleProfilePictureChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    user.profilePicUrl = e.target.result;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showAccount(); // Re-render the account page
                };
                reader.readAsDataURL(file);
            }
        }

        function removeProfilePicture() {
            if (user && user.profilePicUrl) {
                delete user.profilePicUrl;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showAccount();
            }
        }


        // --- Donation Flow Logic ---

        // Map page IDs to a sequence
        const donationFlow = ['age-page', 'blood-type-page', 'city-page', 'hospital-page', 'date-page', 'sickness-page', 'review-page'];
        let currentFlowIndex = -1;
        let donationInProgress = JSON.parse(localStorage.getItem('donationInProgress')) || null;

        function startDonation() {
            if (!isLoggedIn) return showSection('main-page');
            
            pageHistory.length = 0; // *** FIX: Clear history when starting a flow from the sidebar/home ***
            currentFlowIndex = -1; // Reset flow index on start
            
            // If the user has an unconfirmed donation in the past, show confirmation page first
            if (unconfirmedDonation && new Date(unconfirmedDonation.date) < new Date()) {
                document.getElementById('unconfirmed-date-display').textContent = formatDate(unconfirmedDonation.date);
                document.getElementById('unconfirmed-hospital-display').textContent = unconfirmedDonation.hospital;
                return showSection('confirm-attendance-page');
            }

            // Start a new flow, clearing old data
            donationInProgress = { age: '', bloodType: '', city: '', hospital: '', date: '', sickness: '' };
            localStorage.setItem('donationInProgress', JSON.stringify(donationInProgress));
            currentFlowIndex = 0;
            showSection(donationFlow[currentFlowIndex]);
        }
        
        function startRequest() {
            if (!isLoggedIn) return showSection('main-page');
            pageHistory.length = 0; // *** FIX: Clear history when starting a request from the sidebar/home ***
            currentFlowIndex = -1; // Reset flow index
            showSection('request-blood-page');
        }


        function goToNextDonationStep() {
            currentFlowIndex++;
            if (currentFlowIndex < donationFlow.length) {
                if (donationFlow[currentFlowIndex] === 'review-page') {
                    reviewDonation();
                }
                showSection(donationFlow[currentFlowIndex]);
            } else {
                // Should not happen if review is the last step
                goToHome(); 
            }
        }
        
        // NEW: Dedicated function for stepping back in the donation flow
        function goToPreviousFlowStep() {
            if (currentFlowIndex > 0) {
                currentFlowIndex--;
                showSection(donationFlow[currentFlowIndex]);
            } else {
                // If on the first step of the flow, use the global back function (which goes to welcome)
                goBack();
            }
        }

        function saveAge() {
            const age = document.getElementById('age').value;
            if (!age || age < 18 || age > 65) {
                alert('You must be between 18 and 65 to donate.');
                return;
            }
            donationInProgress.age = age;
            localStorage.setItem('donationInProgress', JSON.stringify(donationInProgress));
            goToNextDonationStep();
        }

        function saveBloodType() {
            const bloodType = document.querySelector('input[name="bloodType"]:checked');
            if (!bloodType) {
                alert('Please select your blood type.');
                return;
            }
            donationInProgress.bloodType = bloodType.value;
            localStorage.setItem('donationInProgress', JSON.stringify(donationInProgress));
            goToNextDonationStep();
        }
        
        function saveCity() {
            let city = document.getElementById('city').value;
            if (city === 'Other') {
                city = document.getElementById('otherCity').value.trim();
            }
            if (!city) {
                alert('Please select or enter your city.');
                return;
            }
            donationInProgress.city = city;
            
            // Update user's city if it's not set
            if (!user.city) {
                user.city = city;
                localStorage.setItem('currentUser', JSON.stringify(user));
            }

            localStorage.setItem('donationInProgress', JSON.stringify(donationInProgress));
            
            // Populate hospitals for the next step
            populateHospitalList(city);
            goToNextDonationStep();
        }
        
        function populateHospitalList(city) {
            const hospitalSelect = document.getElementById('hospital');
            hospitalSelect.innerHTML = '<option value="">Select a hospital</option>';
            
            // Filter hospitals by city or include all if city is 'Other'
            const cityHospitals = HOSPITAL_LOCATIONS.filter(h => h.city === city || city === 'Other');
            
            cityHospitals.forEach(hospital => {
                const option = document.createElement('option');
                option.value = hospital.name;
                option.textContent = `${hospital.name} (${hospital.city}) - Need: ${hospital.need_level}`;
                hospitalSelect.appendChild(option);
            });
            
            const otherOption = document.createElement('option');
            otherOption.value = 'Other';
            otherOption.textContent = 'Other (Enter manually)';
            hospitalSelect.appendChild(otherOption);
            
            // Reset the 'Other' input visibility
            document.getElementById('otherHospital').value = '';
            document.getElementById('otherHospital').parentElement.style.maxHeight = '0';
        }

        function saveHospital() {
            let hospital = document.getElementById('hospital').value;
            if (hospital === 'Other') {
                hospital = document.getElementById('otherHospital').value.trim();
            }
            if (!hospital) {
                alert('Please select or enter a hospital.');
                return;
            }
            donationInProgress.hospital = hospital;
            localStorage.setItem('donationInProgress', JSON.stringify(donationInProgress));
            goToNextDonationStep();
        }

        function saveDate() {
            const dateInput = document.getElementById('donationDate').value;
            if (!dateInput) {
                alert('Please select a date.');
                return;
            }
            
            const selectedDate = new Date(dateInput);
            const today = new Date();
            // Reset time part for accurate comparison
            selectedDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);

            if (selectedDate < today) {
                alert('The donation date cannot be in the past.');
                return;
            }
            
            donationInProgress.date = dateInput;
            localStorage.setItem('donationInProgress', JSON.stringify(donationInProgress));
            
            // Check for 56-day rule
            const donations = allDonations.filter(d => d.userEmail === user.email && d.status === 'Completed');
            if (donations.length > 0) {
                const lastDonation = new Date(donations.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date);
                const daysSinceLast = dateDifferenceInDays(lastDonation, selectedDate);
                
                if (daysSinceLast < 56) {
                    const nextRecommendedDate = new Date(lastDonation);
                    nextRecommendedDate.setDate(lastDonation.getDate() + 56);
                    
                    document.getElementById('lastDonationDateDisplay').textContent = formatDate(lastDonation);
                    document.getElementById('selectedDonationDateDisplay').textContent = formatDate(selectedDate);
                    document.getElementById('nextRecommendedDateDisplay').textContent = formatDate(nextRecommendedDate);
                    
                    showSection('donation-warning-page');
                    return;
                }
            }

            // Proceed normally
            goToNextDonationStep();
        }
        
        function skipWarning() {
            // User chose to proceed despite the warning
            goToNextDonationStep(); 
        }

        function saveSickness() {
            const sickness = document.getElementById('sickness').value.trim();
            if (!sickness) {
                 alert('Please enter any sicknesses or type "None".');
                return;
            }
            donationInProgress.sickness = sickness;
            localStorage.setItem('donationInProgress', JSON.stringify(donationInProgress));
            goToNextDonationStep();
        }

        function reviewDonation() {
            document.getElementById('reviewAge').textContent = donationInProgress.age;
            document.getElementById('reviewBloodType').textContent = donationInProgress.bloodType;
            document.getElementById('reviewCity').textContent = donationInProgress.city;
            document.getElementById('reviewHospital').textContent = donationInProgress.hospital;
            document.getElementById('reviewDate').textContent = formatDate(donationInProgress.date);
            document.getElementById('reviewSickness').textContent = donationInProgress.sickness;
        }

        function confirmDonation() {
            // Create a new donation record
            const newDonation = {
                id: Date.now(),
                userEmail: user.email,
                userName: user.name,
                ...donationInProgress,
                submissionDate: new Date().toISOString().split('T')[0],
                status: 'Pending' // Initial status is pending
            };

            // Save the donation to the master list
            allDonations.push(newDonation);
            localStorage.setItem('allDonations', JSON.stringify(allDonations));
            
            // Set this as the unconfirmed donation to prompt for attendance later
            unconfirmedDonation = { 
                id: newDonation.id, 
                date: newDonation.date, 
                hospital: newDonation.hospital,
                userEmail: user.email
            };
            localStorage.setItem('unconfirmedDonation', JSON.stringify(unconfirmedDonation));

            // Clear the in-progress state
            donationInProgress = null;
            localStorage.removeItem('donationInProgress');
            currentFlowIndex = -1; // Reset flow index

            // Show thank you page
            document.getElementById('confirmed-date').textContent = formatDate(newDonation.date);
            showSection('thank-you-page');
        }
        
        function confirmAttendance(attended) {
            if (!unconfirmedDonation || unconfirmedDonation.userEmail !== user.email) {
                // Safety check
                clearUnconfirmedDonation();
                return goToHome();
            }

            const donationIndex = allDonations.findIndex(d => d.id === unconfirmedDonation.id);

            if (donationIndex !== -1) {
                if (attended) {
                    allDonations[donationIndex].status = 'Completed';
                    
                    // Increment user's donation count for badges
                    if (!user.donationsCount) user.donationsCount = 0;
                    user.donationsCount++;
                } else {
                    allDonations[donationIndex].status = 'Missed';
                }
                
                localStorage.setItem('allDonations', JSON.stringify(allDonations));
                localStorage.setItem('currentUser', JSON.stringify(user)); // Save updated user info
            }

            // Clear the temporary unconfirmed flag
            clearUnconfirmedDonation();
            
            // Reroute home
            goToHome();
            alert(attended ? "Attendance confirmed! Thank you for donating." : "Appointment marked as missed.");
        }
        
        function clearUnconfirmedDonation() {
            unconfirmedDonation = null;
            localStorage.removeItem('unconfirmedDonation');
            updateWelcomePage(); // Refresh welcome page to hide card/reminder
        }

        // --- Blood Request Logic ---

        function submitRequest() {
            const bloodType = document.getElementById('requestBloodType').value;
            let city = document.getElementById('requestCity').value;
            if (city === 'Other') {
                city = document.getElementById('otherRequestCity').value.trim();
            }
            const date = document.getElementById('requestDate').value;
            const reason = document.getElementById('requestReason').value;

            if (!bloodType || !city || !date || !reason) {
                alert('Please fill out all fields.');
                return;
            }

            const newRequest = {
                id: Date.now(),
                userEmail: user.email,
                userName: user.name,
                bloodType,
                city,
                date: new Date(date).toISOString().split('T')[0],
                reason,
                submissionDate: new Date().toISOString().split('T')[0]
            };

            allRequests.push(newRequest);
            localStorage.setItem('allRequests', JSON.stringify(allRequests));
            
            // Show thank you page
            showSection('request-thank-you-page');
        }

        // --- Donation Centers Logic ---
        
        function renderDonationCenters() {
            pageHistory.length = 0; // *** FIX: Reset history for sidebar jump ***
            showSection('donation-centers-page');
            filterCenters(); // Call filter function which also renders
        }

        function filterCenters() {
            const searchInput = document.getElementById('center-search-input').value.toLowerCase();
            const centersList = document.getElementById('centers-list');
            centersList.innerHTML = ''; // Clear previous list

            let filteredCenters = HOSPITAL_LOCATIONS.filter(center => 
                center.name.toLowerCase().includes(searchInput) ||
                center.city.toLowerCase().includes(searchInput) ||
                center.need_level.toLowerCase().includes(searchInput)
            );

            if (filteredCenters.length === 0) {
                centersList.innerHTML = '<p style="text-align: center; color: #777;">No centers found matching your search criteria.</p>';
                return;
            }

            filteredCenters.forEach(center => {
                const card = document.createElement('div');
                card.className = 'review-card'; // Reusing style for consistency
                card.innerHTML = `
                    <h3>${center.name} (${center.city})</h3>
                    <p><strong>Contact:</strong> ${center.contact}</p>
                    <p><strong>Address:</strong> ${center.address}</p>
                    <p><strong>Current Blood Need:</strong> ${formatNeedLevel(center.need_level)}</p>
                `;
                centersList.appendChild(card);
            });
        }
        
        // --- Awards & Badges Logic ---

        function showAwardsBadges() {
            if (!isLoggedIn) return goToHome();
            pageHistory.length = 0; // *** FIX: Reset history for sidebar jump ***
            showSection('awards-badges-page');
        }
        
        function renderAwardsBadges() {
            const grid = document.getElementById('awards-grid');
            grid.innerHTML = '';
            
            const completedDonations = allDonations.filter(d => d.userEmail === user.email && d.status === 'Completed').length;
            const localDonations = allDonations.filter(d => d.userEmail === user.email && d.status === 'Completed' && d.city === user.city).length;

            AWARDS.forEach(award => {
                let unlocked = false;

                if (award.isBloodType) {
                    unlocked = user.bloodType === 'O-';
                } else if (award.isLocal) {
                    unlocked = localDonations >= award.requiredDonations;
                } else {
                    unlocked = completedDonations >= award.requiredDonations;
                }

                const card = document.createElement('div');
                card.className = `badge-card ${unlocked ? 'unlocked' : ''}`;
                card.title = unlocked ? `${award.description}` : `Required: ${award.description}`;
                card.innerHTML = `
                    <i class="${award.icon} badge-icon"></i>
                    <div class="badge-name">${award.name}</div>
                    <small style="color: ${unlocked ? '#dc3545' : '#777'}; display: block; margin-top: 5px;">${unlocked ? 'UNLOCKED' : `${award.requiredDonations > 0 ? `${award.requiredDonations} donations` : 'Special requirement'}`}</small>
                `;
                grid.appendChild(card);
            });
        }
        
        // --- Reviews Logic ---

        let editingReviewId = null;

        function showReviewForm(reviewId = null) {
            if (!isLoggedIn) return goToHome();
            pageHistory.length = 0; // *** FIX: Reset history for sidebar jump ***
            editingReviewId = reviewId;
            const review = allReviews.find(r => r.id === reviewId && r.userName === user.name);
            const form = document.getElementById('reviewForm');
            
            form.reset();
            setRating(0, false); // Clear stars

            if (review) {
                document.querySelector('#review-form-page h2').textContent = 'Edit Your Review';
                document.getElementById('reviewComment').value = review.comment;
                setRating(review.rating, false);
            } else {
                document.querySelector('#review-form-page h2').textContent = 'Submit a Review';
            }
            showSection('review-form-page');
        }
        
        function showReviewsHistoryPage() {
            pageHistory.length = 0; // *** FIX: Reset history for sidebar jump ***
            showSection('reviews-history-page');
        }
        
        function setRating(rating, isInteractive) {
            const stars = document.querySelectorAll('#rating-stars .fa-star');
            const ratingInput = document.getElementById('reviewRating');
            
            stars.forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.classList.add('checked');
                } else {
                    star.classList.remove('checked');
                }
                if (isInteractive) {
                    star.style.color = 'gold'; // Temporary visual for hover
                }
            });
            
            // Only update the hidden input if it's not a temporary hover effect or part of form load
            if (!isInteractive) {
                ratingInput.value = rating;
            }
        }
        
        function addSticker(element) {
            const sticker = element.getAttribute('data-sticker');
            const commentBox = document.getElementById('reviewComment');
            
            // Prepend the sticker, ensuring a space
            commentBox.value = sticker + ' ' + commentBox.value;
            
            // Focus and put cursor at the end
            commentBox.focus();
            commentBox.setSelectionRange(commentBox.value.length, commentBox.value.length);
        }

        function submitReview(event) {
            event.preventDefault();
            const rating = parseInt(document.getElementById('reviewRating').value);
            const comment = document.getElementById('reviewComment').value.trim();

            if (rating === 0) {
                showFeedback('review-feedback', 'Please select a star rating.', true);
                return;
            }
            if (comment.length < 5) {
                showFeedback('review-feedback', 'Please enter a comment of at least 5 characters.', true);
                return;
            }

            if (editingReviewId) {
                // Edit existing review
                const index = allReviews.findIndex(r => r.id === editingReviewId && r.userName === user.name);
                if (index !== -1) {
                    allReviews[index].rating = rating;
                    allReviews[index].comment = comment;
                    allReviews[index].date = new Date().toISOString().split('T')[0];
                }
            } else {
                // Submit new review
                const newReview = {
                    id: Date.now(),
                    userName: user.name,
                    userEmail: user.email,
                    rating,
                    comment,
                    date: new Date().toISOString().split('T')[0]
                };
                allReviews.push(newReview);
            }

            localStorage.setItem('allReviews', JSON.stringify(allReviews));
            editingReviewId = null;
            showSection('review-thank-you-page');
        }
        
        function renderReviewsHistory() {
            const listContainer = document.getElementById('reviews-list-container');
            listContainer.innerHTML = '';
            document.getElementById('no-reviews-message').style.display = 'none';

            if (allReviews.length === 0) {
                document.getElementById('no-reviews-message').style.display = 'block';
                return;
            }
            
            // Sort reviews by date descending
            const sortedReviews = [...allReviews].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedReviews.forEach(review => {
                const isUserReview = review.userEmail === user.email;
                const card = document.createElement('div');
                card.className = 'review-card';
                
                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    starsHtml += `<i class="fas fa-star ${i <= review.rating ? 'checked' : ''}"></i>`;
                }

                const editButton = isUserReview 
                    ? `<button class="edit-btn" onclick="showReviewForm(${review.id})">Edit</button>` 
                    : '';

                card.innerHTML = `
                    <p><strong>Reviewer:</strong> ${review.userName} ${isUserReview ? '**(You)**' : ''} ${editButton}</p>
                    <p class="card-rating">${starsHtml}</p>
                    <p style="margin-top: 10px;">${review.comment}</p>
                    <small style="color: #777;">Date: ${formatDate(review.date)}</small>
                `;
                listContainer.appendChild(card);
            });
        }
        
        // Add event listeners for star rating interaction
        document.addEventListener('DOMContentLoaded', () => {
            const ratingStars = document.getElementById('rating-stars');
            if (ratingStars) {
                ratingStars.addEventListener('mouseover', function(e) {
                    if (e.target.classList.contains('fa-star')) {
                        const hoverRating = parseInt(e.target.getAttribute('data-rating'));
                        setRating(hoverRating, true);
                    }
                });

                ratingStars.addEventListener('mouseout', function() {
                    const currentRating = parseInt(document.getElementById('reviewRating').value);
                    setRating(currentRating, false);
                });

                ratingStars.addEventListener('click', function(e) {
                    if (e.target.classList.contains('fa-star')) {
                        const newRating = parseInt(e.target.getAttribute('data-rating'));
                        document.getElementById('reviewRating').value = newRating;
                        setRating(newRating, false);
                    }
                });
            }
        });


        // --- Reports Logic ---
        
        function showReportsPage() {
            if (!isLoggedIn) return goToHome();
            pageHistory.length = 0; // *** FIX: Reset history for sidebar jump ***
            showSection('reports-page');
        }

        function renderReports() {
            renderDonationsTable();
            renderRequestsTable();
        }

        function renderDonationsTable() {
            const container = document.getElementById('donations-table-container');
            const donationsForUser = allDonations.filter(d => d.userEmail === user.email);
            
            if (donationsForUser.length === 0) {
                container.innerHTML = '<p id="no-donations-message" style="text-align: center; color: #777;">No donations have been submitted yet.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Hospital</th>
                        <th>Status</th>
                        <th>Blood Type</th>
                        <th>Sicknesses</th>
                    </tr>
                </thead>
                <tbody>
                    ${donationsForUser.map(d => `
                        <tr>
                            <td>${formatDate(d.date)}</td>
                            <td>${d.hospital}</td>
                            <td>${d.status}</td>
                            <td>${d.bloodType}</td>
                            <td>${d.sickness}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            container.innerHTML = '';
            container.appendChild(table);
        }

        function renderRequestsTable() {
            const container = document.getElementById('requests-table-container');
            const requestsForUser = allRequests.filter(r => r.userEmail === user.email);
            
            if (requestsForUser.length === 0) {
                container.innerHTML = '<p id="no-requests-message" style="text-align: center; color: #777;">No requests have been submitted yet.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Date Needed</th>
                        <th>Blood Type</th>
                        <th>City</th>
                        <th>Reason</th>
                        <th>Submitted On</th>
                    </tr>
                </thead>
                <tbody>
                    ${requestsForUser.map(r => `
                        <tr>
                            <td>${formatDate(r.date)}</td>
                            <td>${r.bloodType}</td>
                            <td>${r.city}</td>
                            <td>${r.reason}</td>
                            <td>${formatDate(r.submissionDate)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            container.innerHTML = '';
            container.appendChild(table);
        }

        function exportToExcel() {
            let csv = "Type,Date,Details\n";
            
            allDonations.filter(d => d.userEmail === user.email).forEach(d => {
                csv += `Donation,${formatDate(d.date)},Hospital: ${d.hospital}, Status: ${d.status}, Type: ${d.bloodType}\n`;
            });
            
            allRequests.filter(r => r.userEmail === user.email).forEach(r => {
                csv += `Request,${formatDate(r.date)},City: ${r.city}, Type: ${r.bloodType}, Reason: ${r.reason}\n`;
            });

            if (csv === "Type,Date,Details\n") {
                alert("No data to export.");
                return;
            }

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "BLODO_Report_" + new Date().toISOString().split('T')[0] + ".csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                alert("Data exported successfully!");
            }
        }

        function resetData() {
            if (confirm("Are you sure you want to permanently delete ALL your donation and request data? This cannot be undone.")) {
                allDonations = [];
                allRequests = [];
                user.donationsCount = 0; // Reset user's count
                unconfirmedDonation = null;
                localStorage.setItem('allDonations', JSON.stringify(allDonations));
                localStorage.setItem('allRequests', JSON.stringify(allRequests));
                localStorage.setItem('currentUser', JSON.stringify(user));
                localStorage.removeItem('unconfirmedDonation');
                
                renderReports();
                alert("All data cleared successfully.");
            }
        }

        // --- Utility and Initialization ---
        
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const date = dateString instanceof Date ? dateString : new Date(dateString);
            return date.toLocaleDateString('en-US', options);
        }
        
        function dateDifferenceInDays(date1, date2) {
            const d1 = date1 instanceof Date ? date1 : new Date(date1);
            const d2 = date2 instanceof Date ? date2 : new Date(date2);
            const diffTime = Math.abs(d2.getTime() - d1.getTime());
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function updateWelcomePage() {
            document.getElementById('welcomeName').textContent = user.name;
            
            const reminderBanner = document.getElementById('appointment-reminder');
            const appointmentCard = document.getElementById('upcoming-appointment-card');
            
            if (unconfirmedDonation && unconfirmedDonation.userEmail === user.email) {
                const appointmentDate = new Date(unconfirmedDonation.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (appointmentDate < today) {
                    // Appointment has passed, show confirmation reminder
                    document.getElementById('reminder-text').textContent = `Please confirm if you attended your donation on ${formatDate(unconfirmedDonation.date)}.`;
                    reminderBanner.style.backgroundColor = '#f44336'; // Red for passed date action
                    reminderBanner.style.color = '#fff';
                    appointmentCard.style.display = 'none';
                    showSection('confirm-attendance-page'); // Force confirmation
                    return;

                } else {
                    // Appointment is upcoming
                    document.getElementById('reminder-text').textContent = `You have an appointment on ${formatDate(unconfirmedDonation.date)}.`;
                    reminderBanner.style.backgroundColor = '#ffc107'; // Yellow for upcoming reminder
                    reminderBanner.style.color = '#333';
                    
                    document.getElementById('upcoming-date').textContent = formatDate(unconfirmedDonation.date);
                    document.getElementById('upcoming-hospital').textContent = unconfirmedDonation.hospital;
                    appointmentCard.style.display = 'block';
                }
                
                reminderBanner.style.display = 'flex';
            } else {
                // No pending unconfirmed donation
                reminderBanner.style.display = 'none';
                appointmentCard.style.display = 'none';
            }
        }

        function updateHeaderLinks(loggedIn) {
            // NOTE: 'centers-sidebar-link' is removed from this list as it is now always visible
            const loggedInLinks = [
                'donate-sidebar-link', 'request-sidebar-link', 
                'reports-sidebar-link', 'awards-sidebar-link', 'account-sidebar-link', 
                'change-password-sidebar-link', 'review-sidebar-link', 'logout-sidebar-link'
            ];

            loggedInLinks.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // Use flex display for the li elements to ensure correct visibility
                    element.style.display = loggedIn ? 'flex' : 'none'; 
                }
            });
        }

        function startSession() {
            if (isLoggedIn) {
                // Ensure correct user data is loaded if only a minimal current user object exists
                if (!user.donationsCount) {
                    user = JSON.parse(localStorage.getItem('currentUser'));
                }
                updateHeaderLinks(true);
                goToHome();
            } else {
                updateHeaderLinks(false);
                showSection('main-page');
            }
        }
        
        // --- NEW: Advanced Chatbot Logic ---

        function getBotResponse(message) {
            const msg = message.toLowerCase();

            if (msg.includes('stats') || msg.includes('donations count')) {
                const completedDonations = allDonations.filter(d => d.userEmail === user.email && d.status === 'Completed').length;
                const totalRequests = allRequests.filter(r => r.userEmail === user.email).length;
                
                let response = `Your Donor Statistics:\n- **Completed Donations:** ${completedDonations}\n- **Total Blood Requests:** ${totalRequests}`;
                
                if (user.bloodType) {
                    response += `\n- **Your Blood Type:** ${user.bloodType}`;
                }
                return response;
            }

            if (msg.includes('hospital supply') || msg.includes('needs')) {
                const criticalHospitals = HOSPITAL_LOCATIONS.filter(h => h.need_level === 'Critical');
                if (criticalHospitals.length > 0) {
                    return `⚠️ **Critical Supply Alert:** The following centers urgently need donations: ${criticalHospitals.map(h => h.name).join(', ')}. Please consider donating there!`;
                } else {
                    return `Good news! No centers are currently reporting a Critical blood supply need today. However, many still need donations. Check the "Find Donation Centers" page for details.`;
                }
            }
            
            if (msg.includes('hello') || msg.includes('hi')) {
                return "Hello! I'm here to help. Try asking about your stats or hospital supply.";
            }
            
            if (msg.includes('help')) {
                return "I can answer questions about your **stats**, **hospital supply**, and general **donation info**. Try a specific query!";
            }

            if (msg.includes('donation info') || msg.includes('who can donate')) {
                return "Most healthy adults aged 18 to 65 can donate blood. You must weigh at least 50 kg (110 lbs) and be in good general health.";
            }

            return "I'm sorry, I don't have enough information to answer that specific question. Please try asking about your **stats** or **hospital supply**!";
        }

        function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const chatWindow = document.getElementById('chat-window');
            const messageText = chatInput.value.trim();

            if (messageText === "") return;

            // 1. Display user message
            const userMessageDiv = document.createElement('p');
            userMessageDiv.className = 'user-message';
            userMessageDiv.textContent = messageText;
            chatWindow.appendChild(userMessageDiv);
            chatInput.value = '';

            // 2. Display thinking indicator (optional but good UX)
            const thinkingDiv = document.createElement('p');
            thinkingDiv.className = 'bot-message';
            thinkingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Thinking...';
            chatWindow.appendChild(thinkingDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;


            // 3. Get bot response after a short delay
            setTimeout(() => {
                // Remove thinking indicator
                chatWindow.removeChild(thinkingDiv);

                const botResponseText = getBotResponse(messageText);
                const botMessageDiv = document.createElement('p');
                botMessageDiv.className = 'bot-message';
                // Using innerHTML to support bold markdown in the response
                botMessageDiv.innerHTML = botResponseText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>'); 
                chatWindow.appendChild(botMessageDiv);
                
                // Scroll to the bottom
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }, 750); 
        }
        
        // Add event listener to send message on 'Enter' key press
        document.addEventListener('keypress', function(e) {
            const chatInput = document.getElementById('chat-input');
            const chatbotPage = document.getElementById('chatbot-page');
            
            // Send message if Enter is pressed and we are on the chatbot page
            if (e.key === 'Enter' && chatInput && chatbotPage && chatbotPage.style.display === 'block') {
                e.preventDefault(); // Prevent default action (like form submission)
                sendMessage();
            }
        });


        // --- Event Listeners and Initial Setup ---
        
        document.addEventListener('DOMContentLoaded', function() {
            // Logic to handle show/hide of 'Other' city/hospital inputs
            const citySelect = document.getElementById('city');
            const otherCityInput = document.getElementById('otherCity').parentElement;
            if (citySelect) {
                citySelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        // Set max height dynamically to trigger the CSS transition
                        otherCityInput.style.maxHeight = otherCityInput.scrollHeight + "px";
                    } else {
                        otherCityInput.style.maxHeight = '0';
                    }
                });
            }

            const hospitalSelect = document.getElementById('hospital');
            const otherHospitalInput = document.getElementById('otherHospital').parentElement;
            if (hospitalSelect) {
                hospitalSelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        otherHospitalInput.style.maxHeight = otherHospitalInput.scrollHeight + "px";
                    } else {
                        otherHospitalInput.style.maxHeight = '0';
                    }
                });
            }

            const requestCitySelect = document.getElementById('requestCity');
            const otherRequestCityInput = document.getElementById('otherRequestCity').parentElement;
            if (requestCitySelect) {
                requestCitySelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        otherRequestCityInput.style.maxHeight = otherRequestCityInput.scrollHeight + "px";
                    } else {
                        otherRequestCityInput.style.maxHeight = '0';
                    }
                });
            }

            // Start the session based on whether a user is loaded from local storage
            startSession();
        });
    </script>
</body>
</html>
