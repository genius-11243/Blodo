<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLODO - Arsany Mina Fawzy</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');

        :root {
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f2f5 0%, #d4e0ff 100%);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: #fff;
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Approximate height of the header */
            min-height: 100px;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-content i {
            font-size: 2rem;
        }


        h1, h2, h4 {
            margin: 0;
            font-weight: 600;
        }
        
        h4 {
            font-size: 1rem;
            opacity: 0.9;
        }

        main {
            padding: 2rem 1rem;
            display: none;
            width: 100%;
            max-width: 800px;
            margin-top: 150px;
            transition: margin-left 0.3s ease-in-out;
        }

        .container {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .main-page-container {
            text-align: center;
        }

        .main-page-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .main-page-content h2 {
            font-size: 2.5rem;
            color: #dc3545;
            margin-bottom: 0.5rem;
        }

        .main-page-content p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .main-page-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.4s, box-shadow 0.4s;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15);
            outline: none;
        }
        
        /* PASSWORD VISIBILITY STYLES */
        .password-container {
            position: relative;
        }
        .password-container input {
            padding-right: 40px !important; /* Make space for the icon */
        }
        .toggle-password {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 1rem;
            transition: color 0.2s;
            z-index: 10;
        }
        .toggle-password:hover {
            color: #dc3545;
        }

        button {
            background-color: #dc3545;
            color: #fff;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .dual-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 1rem;
        }

        .dual-buttons button {
            width: 50%;
            text-align: center;
        }

        button:hover {
            background-color: #c82333;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.5);
        }

        .welcome-page {
            text-align: center;
        }
        
        /* NEW: Reminder Banner Style */
        .reminder-banner {
            background-color: #ffc107;
            color: #333;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            animation: pulse 1.5s infinite;
        }

        /* NEW: Pulse animation for the reminder banner */
        @keyframes pulse {
            0% { box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(255, 193, 7, 0.8); }
            100% { box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4); }
        }

        .question-page {
            padding: 1.5rem 0;
        }

        .question-page h2 {
            color: #007bff;
            margin-bottom: 1.5rem;
        }

        .radio-group label {
            display: inline-block;
            margin-right: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 400;
        }
        
        .thank-you-page h2 {
            color: #28a745;
        }
        
        /* NEW: Confirmation Page Styling */
        #confirm-attendance-page h2 {
            color: #dc3545;
        }
        #confirm-attendance-page p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }
        #confirm-attendance-page strong {
            color: #007bff;
        }

        /* NEW: Style for the Donation Centers list */
        #centers-list .review-card {
            border: 2px solid #ddd;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            border-radius: 10px;
        }


        .feedback-message {
            text-align: center;
            color: #dc3545;
            margin-bottom: 1rem;
            font-weight: bold;
            opacity: 0;
            animation: fadeInOut 3s forwards;
        }

        .input-group-animation {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.5s ease-in-out;
        }
        
        .faq-item {
            margin-bottom: 1.5rem;
        }

        .faq-item h3 {
            margin-top: 0;
            color: #dc3545;
        }
        
        .faq-item p {
            line-height: 1.6;
        }

        /* New table styles */
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word;
        }
        
        thead tr {
            background-color: #dc3545;
            color: #fff;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tbody tr:hover {
            background-color: #e9ecef;
        }
        
        /* Awards & Badges Page Styles */
        .awards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 2rem;
            text-align: center;
        }
        
        .badge-card {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #ddd;
            transition: transform 0.3s;
        }
        
        .badge-card.unlocked {
            border-color: gold;
            background: linear-gradient(145deg, #fffbe0, #fff);
        }

        .badge-icon {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 10px;
        }
        
        .badge-card.unlocked .badge-icon {
            color: gold;
        }
        
        .badge-name {
            font-weight: 700;
            color: #333;
        }


        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
        }

        .loading-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sidebar Toggle Styling (Left Button) */
        .sidebar-toggle {
            position: fixed;
            top: 25px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
        }

        /* New style for the persistent Home button (Right Button) */
        .home-button-toggle {
            position: fixed;
            top: 25px;
            right: 20px; /* Position on the right side */
            width: 50px;
            height: 50px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            z-index: 1001; /* Ensure it's above the header */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
        }
        
        .sidebar-toggle:hover, .home-button-toggle:hover {
            transform: scale(1.1);
        }

        .sidebar {
            position: fixed;
            /* FIX 1: Shift sidebar below the header */
            top: 100px; 
            left: calc(-1 * var(--sidebar-width));
            width: var(--sidebar-width);
            height: calc(100vh - 100px); /* Fill remaining viewport height */
            background-color: #2c2f33;
            color: #fff;
            padding-top: 0;
            transition: left 0.3s ease-in-out;
            z-index: 999;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar li {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #555;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .sidebar li i {
            font-size: 1.2rem;
            color: #fff;
        }
        .sidebar li:hover {
            background-color: #dc3545;
            color: #fff;
        }
        .sidebar li:hover i {
            color: #fff;
        }
        
        /* --- REVIEW STAR STYLING --- */
        .rating-stars {
            font-size: 2rem;
            cursor: pointer;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: center;
        }
        .rating-stars .fa-star {
            color: #ccc;
            transition: color 0.2s;
        }
        .rating-stars .fa-star.checked,
        .review-card .card-rating .fa-star.checked,
        .rating-stars .fa-star:hover,
        .rating-stars .fa-star:hover ~ .fa-star {
            color: gold;
        }
        /* --- END: REVIEW STAR STYLING --- */
        
        /* --- REVIEW HISTORY CARD STYLING --- */
        .reviews-list-container {
            max-height: 500px; /* Limit height of the review list */
            overflow-y: auto; /* Enable scrolling */
            padding-right: 15px; /* Space for scrollbar */
        }
        
        .review-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .review-card p {
            margin: 0.5rem 0;
        }
        .review-card strong {
            color: #dc3545;
        }
        .review-card .card-rating i {
            color: #ccc; /* Resetting star color for card */
        }
        .review-card .card-rating .fa-star.checked {
            color: gold; /* Only checked stars are gold */
        }
        
        /* Edit button on review card */
        .review-card .edit-btn {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        .review-card .edit-btn:hover {
            background-color: #0056b3;
            transform: none; /* Override general button hover transform */
            box-shadow: none;
        }
        
        /* --- Sticker Selector --- */
        .sticker-option {
            cursor: pointer;
            transition: transform 0.2s;
            opacity: 0.8;
            padding: 5px; /* Increase hit area */
        }
        .sticker-option:hover {
            transform: scale(1.3);
            opacity: 1;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <i class="fas fa-hand-holding-heart"></i>
            <h1>BLODO</h1>
        </div>
        <h4>Arsany Mina Fawzy</h4>
    </header>

    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    
    <button class="home-button-toggle" onclick="goToHome()">
        <i class="fas fa-home"></i>
    </button>
    
    <aside class="sidebar" id="sidebar">
        <ul>
            <li onclick="toggleSidebar(); goToHome()"><i class="fas fa-home"></i> Home</li> 
            <li onclick="toggleSidebar(); startDonation()" id="donate-sidebar-link" style="display:none;"><i class="fas fa-hand-holding-heart"></i> Donate Blood</li>
            <li onclick="toggleSidebar(); startRequest()" id="request-sidebar-link" style="display:none;"><i class="fas fa-hand-holding-medical"></i> Request Blood</li>
            <li onclick="toggleSidebar(); renderDonationCenters()" id="centers-sidebar-link" style="display:none;"><i class="fas fa-map-marker-alt"></i> Find Donation Centers</li>
            <li onclick="toggleSidebar(); showReportsPage()" id="reports-sidebar-link" style="display:none;"><i class="fas fa-chart-bar"></i> View Reports</li>
            <li onclick="toggleSidebar(); showAwardsBadges()" id="awards-sidebar-link" style="display:none;"><i class="fas fa-trophy"></i> Awards & Badges</li>
            <li onclick="toggleSidebar(); showAccount()" id="account-sidebar-link" style="display:none;"><i class="fas fa-user-circle"></i> Account</li>
            <li onclick="toggleSidebar(); showChangePassword()" id="change-password-sidebar-link" style="display:none;"><i class="fas fa-key"></i> Change Password</li>
            <li onclick="toggleSidebar(); showReviewsHistoryPage()"><i class="fas fa-comments" id="reviews-history-sidebar-link"></i> View Reviews</li>
            <li onclick="toggleSidebar(); showReviewForm()" id="review-sidebar-link" style="display:none;"><i class="fas fa-star"></i> Submit Review</li>
            <li onclick="toggleSidebar(); showSection('help-page')"><i class="fas fa-question-circle"></i> Help</li>
            <li onclick="toggleSidebar(); logout()" id="logout-sidebar-link" style="display:none;"><i class="fas fa-sign-out-alt"></i> Log Out</li>
        </ul>
    </aside>

    <main id="main-page">
        <div class="container main-page-container">
            <div class="main-page-content">
                <h2>Give Blood. Save Lives.</h2>
                <p>Every donation makes a difference. Join the BLODO community to find nearby hospitals and schedule your blood donation easily. Your contribution can save a life.</p>
                <div class="main-page-buttons">
                    <button onclick="showSignup()">Sign Up</button>
                    <button onclick="showLogin()">Login</button>
                </div>
            </div>
        </div>
    </main>

    <main id="signup-form">
        <div class="container">
            <h2>Sign Up</h2>
            <div id="signup-feedback" class="feedback-message"></div>
            <form id="signupForm" onsubmit="signUp(event)">
                <div class="form-group">
                    <label for="signupName">Name:</label>
                    <input type="text" id="signupName" name="signupName" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email:</label>
                    <input type="email" id="signupEmail" name="signupEmail" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password:</label>
                    <div class="password-container">
                        <input type="password" id="signupPassword" name="signupPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('signupPassword', this)"></i>
                    </div>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="signup-btn">
                        Sign Up
                    </button>
                </div>
            </form>
            <p style="margin-top: 1.5rem; text-align: center;">Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
        </div>
    </main>

    <main id="login-form">
        <div class="container">
            <h2>Login</h2>
            <div id="login-feedback" class="feedback-message"></div>
            <form id="loginForm" onsubmit="login(event)">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" name="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" name="loginPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('loginPassword', this)"></i>
                    </div>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="login-btn">
                        Login
                    </button>
                </div>
            </form>
            <p style="margin-top: 1.5rem; text-align: center;">Don't have an account? <a href="#" onclick="showSignup()">Sign Up</a></p>
        </div>
    </main>

    <main id="welcome-page">
        <div class="container welcome-page">
            
            <div id="appointment-reminder" class="reminder-banner" style="display:none;">
                <i class="fas fa-bell"></i> 
                <span id="reminder-text"></span>
            </div>

            <h2>Welcome, <span id="welcomeName"></span>!</h2>
            <p>What would you like to do today?</p>
            <div class="main-page-buttons">
                <button onclick="startDonation()">Start Donation</button>
                <button onclick="startRequest()">Request Blood</button>
            </div>
            
             <div id="upcoming-appointment-card" class="review-card" style="margin-top: 2rem; display: none;">
                <p><strong>Upcoming Donation Appointment:</strong></p>
                <p>Date: <span id="upcoming-date"></span></p>
                <p>Hospital: <span id="upcoming-hospital"></span></p>
                <p style="font-size: 0.9rem; color: #dc3545; margin-top: 10px;">To change this, simply start a new donation process which will overwrite this appointment.</p>
                <button onclick="clearUnconfirmedDonation()" style="background-color: #f44336; width: 100%; margin-top: 0.5rem;">Clear Appointment</button>
            </div>
            
        </div>
    </main>

    <main id="account-page">
        <div class="container">
            <h2>Your Account</h2>
            <p><strong>Name:</strong> <span id="accountName"></span></p>
            <p><strong>Email:</strong> <span id="accountEmail"></span></p>
            <div class="dual-buttons">
                <button onclick="goBack()">Go Back</button>
                <button onclick="showChangePassword()">Change Password</button>
            </div>
            <button onclick="logout()" style="width: 100%; margin-top: 1rem;">Log Out</button>
        </div>
    </main>

    <main id="change-password-page">
        <div class="container">
            <h2>Change Password</h2>
            <div id="password-feedback" class="feedback-message"></div>
            <form id="changePasswordForm" onsubmit="changePassword(event)">
                <div class="form-group">
                    <label for="currentPassword">Current Password:</label>
                    <div class="password-container">
                        <input type="password" id="currentPassword" name="currentPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('currentPassword', this)"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password:</label>
                    <div class="password-container">
                        <input type="password" id="newPassword" name="newPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('newPassword', this)"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">Confirm New Password:</label>
                    <div class="password-container">
                        <input type="password" id="confirmNewPassword" name="confirmNewPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('confirmNewPassword', this)"></i>
                    </div>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="change-password-btn">
                        Change Password
                    </button>
                </div>
            </form>
        </div>
    </main>
    
    <main id="awards-badges-page">
        <div class="container">
            <h2>Your Donor Achievements</h2>
            <p>Keep track of your life-saving milestones!</p>
            <div id="awards-grid" class="awards-grid">
                </div>
            <button onclick="goBack()" style="width: 100%; margin-top: 2rem;">Go Back</button>
        </div>
    </main>

    <main id="review-form-page">
        <div class="container">
            <h2>Submit a Review</h2>
            <div id="review-feedback" class="feedback-message"></div>
            <form id="reviewForm" onsubmit="submitReview(event)">
                <div class="form-group" style="text-align: center;">
                    <label for="reviewRating">Your Rating:</label>
                    <div class="rating-stars" id="rating-stars">
                        <i class="fas fa-star" data-rating="1"></i>
                        <i class="fas fa-star" data-rating="2"></i>
                        <i class="fas fa-star" data-rating="3"></i>
                        <i class="fas fa-star" data-rating="4"></i>
                        <i class="fas fa-star" data-rating="5"></i>
                    </div>
                    <input type="hidden" id="reviewRating" name="reviewRating" value="0" required>
                </div>
                
                <div class="form-group">
                    <label>Add a Sticker (Optional - click to prepend to comment):</label>
                    <div id="sticker-selector" style="display: flex; gap: 15px; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem;">
                        <span class="sticker-option" data-sticker="❤️" title="Love It" onclick="addSticker(this)">❤️</span>
                        <span class="sticker-option" data-sticker="👍" title="Thumbs Up" onclick="addSticker(this)">👍</span>
                        <span class="sticker-option" data-sticker="🌟" title="Five Stars" onclick="addSticker(this)">🌟</span>
                        <span class="sticker-option" data-sticker="😊" title="Happy" onclick="addSticker(this)">😊</span>
                        <span class="sticker-option" data-sticker="🩸" title="Blood Drop" onclick="addSticker(this)">🩸</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="reviewComment">Comments / Suggestions:</label>
                    <textarea id="reviewComment" rows="5" placeholder="Share your experience with BLODO..." required></textarea>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit">Submit Review</button>
                </div>
            </form>
        </div>
    </main>
    
    <main id="reviews-history-page">
        <div class="container">
            <h2>Community Reviews</h2>
            <p>See what others are saying about the BLODO service. Your review will be marked with **(You)** and have an **Edit button**.</p>
            <div id="reviews-list-container" class="reviews-list-container" style="margin-top: 1.5rem;">
                <p id="no-reviews-message" style="text-align: center; color: #777;">No reviews have been submitted yet.</p>
            </div>
            <button onclick="goBack()" style="width: 100%; margin-top: 1.5rem;">Go Back</button>
        </div>
    </main>

    <main id="help-page">
        <div class="container">
            <h2>Frequently Asked Questions</h2>
            <div class="faq-item">
                <h3>Who can donate blood?</h3>
                <p>Most healthy adults aged 18 to 65 can donate blood. You must weigh at least 50 kg (110 lbs) and be in good general health.</p>
            </div>
            <div class="faq-item">
                <h3>How often can I donate?</h3>
                <p>You can donate whole blood every 56 days (about 8 weeks). This allows your body to fully replenish its blood volume and iron stores.</p>
            </div>
            <div class="faq-item">
                <h3>What should I do before donating?</h3>
                <p>Make sure you have had a good night's sleep, eaten a healthy meal, and are well-hydrated. Avoid drinking alcohol 24 hours before your donation.</p>
            </div>
            <div class="faq-item">
                <h3>What happens during the donation process?</h3>
                <p>The entire process, from registration to post-donation rest, takes about one hour. The actual donation itself only takes about 10 minutes.</p>
            </div>
            <p>Still have questions? Contact us at <a href="mailto:arsany.mina.nile@gmail.com">arsany.mina.nile@gmail.com</a>.</p>
            <button onclick="goBack()">Go Back</button>
        </div>
    </main>

    <main id="reports-page">
        <div class="container">
            <h2>Donations and Requests Report</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <button onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <button onclick="resetData()" style="background-color: #f44336; margin-left: auto;">
                    <i class="fas fa-redo"></i> Clear All Data
                </button>
            </div>
            
            <h3>All Donations</h3>
            <div id="donations-table-container" class="table-responsive">
                <p id="no-donations-message" style="text-align: center; color: #777;">No donations have been submitted yet.</p>
            </div>
            
            <h3 style="margin-top: 2rem;">All Requests</h3>
            <div id="requests-table-container" class="table-responsive">
                <p id="no-requests-message" style="text-align: center; color: #777;">No requests have been submitted yet.</p>
            </div>
            
            <button onclick="goBack()" style="width: 100%; margin-top: 2rem;">Go Back</button>
        </div>
    </main>

    <main id="age-page">
        <div class="container">
            <div class="question-page">
                <h2>What is your age?</h2>
                <input type="number" id="age" min="18" required>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveAge()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="blood-type-page">
        <div class="container">
            <div class="question-page">
                <h2>What is your blood type?</h2>
                <div class="radio-group">
                    <label><input type="radio" name="bloodType" value="A+"> A+</label>
                    <label><input type="radio" name="bloodType" value="A-"> A-</label>
                    <label><input type="radio" name="bloodType" value="B+"> B+</label>
                    <label><input type="radio" name="bloodType" value="B-"> B-</label>
                    <label><input type="radio" name="bloodType" value="AB+"> AB+</label>
                    <label><input type="radio" name="bloodType" value="AB-"> AB-</label>
                    <label><input type="radio" name="bloodType" value="O+"> O+</label>
                    <label><input type="radio" name="bloodType" value="O-"> O-</label>
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveBloodType()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="city-page">
        <div class="container">
            <div class="question-page">
                <h2>What city do you live in?</h2>
                <select id="city">
                    <option value="">Select a city</option>
                    <option value="Cairo">Cairo</option>
                    <option value="Alexandria">Alexandria</option>
                    <option value="Giza">Giza</option>
                    <option value="Other">Other</option>
                </select>
                <div class="input-group-animation">
                    <input type="text" id="otherCity" placeholder="Enter city if 'Other' is selected">
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveCity()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="hospital-page">
        <div class="container">
            <div class="question-page">
                <h2>Which hospital do you want to donate to?</h2>
                <select id="hospital">
                    <option value="">Select a hospital</option>
                    </select>
                <div class="input-group-animation">
                    <input type="text" id="otherHospital" placeholder="Enter hospital if 'Other' is selected">
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveHospital()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="date-page">
        <div class="container">
            <div class="question-page">
                <h2>What is the date you want to donate?</h2>
                <input type="date" id="donationDate" required>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveDate()">Next</button>
                </div>
            </div>
        </div>
    </main>
    
    <main id="donation-warning-page">
        <div class="container">
            <div class="question-page">
                <h2 style="color: #ffc107;">⚠️ Warning: Short Interval Donation</h2>
                <p>According to standard guidelines, you should wait at least <strong>56 days</strong> between whole blood donations.</p>
                <p>Your last recorded donation was on <strong id="lastDonationDateDisplay"></strong>, and the next recommended date is <strong id="nextRecommendedDateDisplay"></strong>.</p>
                <p>The date you selected, <strong id="selectedDonationDateDisplay"></strong>, is less than 56 days after your last donation.</p>
                <p><strong>Are you sure you want to proceed?</strong> Skipping this warning may make you ineligible at the donation center.</p>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back & Change Date</button>
                    <button onclick="skipWarning()" style="background-color: #ffc107; color: #333; box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);">Skip Warning & Proceed</button>
                </div>
            </div>
        </div>
    </main>
    <main id="sickness-page">
        <div class="container">
            <div class="question-page">
                <h2>Do you have any sicknesses?</h2>
                <div class="form-group">
                    <textarea id="sickness" rows="4" placeholder="Enter any sicknesses or 'None'" required></textarea>
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveSickness()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="review-page">
        <div class="container">
            <h2>Review Your Answers</h2>
            <p><strong>Age:</strong> <span id="reviewAge"></span></p>
            <p><strong>Blood Type:</strong> <span id="reviewBloodType"></span></p>
            <p><strong>City:</strong> <span id="reviewCity"></span></p>
            <p><strong>Hospital:</strong> <span id="reviewHospital"></span></p>
            <p><strong>Donation Date:</strong> <span id="reviewDate"></span></p>
            <p><strong>Sicknesses:</strong> <span id="reviewSickness"></span></p>
            <div class="dual-buttons">
                <button onclick="goBack()">Go Back</button>
                <button onclick="confirmDonation()">Confirm Appointment</button>
            </div>
        </div>
    </main>

    <main id="request-blood-page">
        <div class="container">
            <h2>Request Blood</h2>
            <div class="form-group">
                <label for="requestBloodType">Blood Type Needed:</label>
                <select id="requestBloodType">
                    <option value="">Select blood type</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
            </div>
            <div class="form-group">
                <label for="requestCity">City:</label>
                <select id="requestCity">
                    <option value="">Select a city</option>
                    <option value="Cairo">Cairo</option>
                    <option value="Alexandria">Alexandria</option>
                    <option value="Giza">Giza</option>
                    <option value="Other">Other</option>
                </select>
                <div class="input-group-animation">
                    <input type="text" id="otherRequestCity" placeholder="Enter city if 'Other' is selected">
                </div>
            </div>
            <div class="form-group">
                <label for="requestDate">Date Needed:</label>
                <input type="date" id="requestDate" required>
            </div>
            <div class="form-group">
                <label for="requestReason">Reason for Request:</label>
                <textarea id="requestReason" rows="4" placeholder="e.g., Surgery, Accident, Medical Condition" required></textarea>
            </div>
            <div class="dual-buttons">
                <button onclick="goBack()">Go Back</button>
                <button onclick="submitRequest()">Submit Request</button>
            </div>
        </div>
    </main>
    
    <main id="donation-centers-page">
        <div class="container">
            <h2>Local Donation Centers and Supply Needs</h2>
            <p>Below is a list of known donation centers and their current estimated blood supply needs. **The list and needs update daily.** Contact the center directly to confirm your appointment.</p>
            <div id="centers-list">
                </div>
            <button onclick="goBack()" style="width: 100%; margin-top: 2rem;">Go Back</button>
        </div>
    </main>

    <main id="confirm-attendance-page">
        <div class="container">
            <h2><i class="fas fa-question-circle" style="color: #dc3545;"></i> Did You Attend?</h2>
            <p>We see your scheduled appointment for **<strong id="unconfirmed-date-display"></strong>** at **<strong id="unconfirmed-hospital-display"></strong>** has passed. Can you confirm if you attended your donation appointment?</p>
            <p>Your honest response helps us keep your donor records and badge progress accurate.</p>
            <div class="dual-buttons">
                <button onclick="confirmAttendance(true)" style="background-color: #28a745;">
                    <i class="fas fa-check-circle"></i> Yes, I went!
                </button>
                <button onclick="confirmAttendance(false)" style="background-color: #f44336;">
                    <i class="fas fa-times-circle"></i> No, I missed it.
                </button>
            </div>
        </div>
    </main>

    <main id="thank-you-page">
        <div class="container thank-you-page">
            <h2>Appointment Confirmed!</h2>
            <p>Your appointment for **<span id="confirmed-date"></span>** is now recorded as a **pending donation**. We will ask you to confirm your attendance on your next visit after the scheduled date.</p>
            <button onclick="goToHome()">Return Home</button>
        </div>
    </main>

    <main id="request-thank-you-page">
        <div class="container thank-you-page">
            <h2>Request Submitted!</h2>
            <p>Your blood request has been submitted. We will notify you when a match is found.</p>
            <button onclick="goToHome()">Start Over</button>
        </div>
    </main>

    <main id="review-thank-you-page">
        <div class="container thank-you-page">
            <h2>Review Updated!</h2>
            <p>Thank you for your valuable feedback. It helps us improve BLODO!</p>
            <p>You can see your review and others on the "View Reviews" page.</p>
            <button onclick="showReviewsHistoryPage()">View Reviews</button>
        </div>
    </main>

    <script>
        // Load data from Local Storage on startup
        let user = JSON.parse(localStorage.getItem('currentUser')) || null;
        let userPassword = localStorage.getItem('userPassword') || "password123";
        let donationData = {};
        const pageHistory = [];
        let feedbackTimer = null;
        let allDonations = JSON.parse(localStorage.getItem('allDonations')) || [];
        let allRequests = JSON.parse(localStorage.getItem('allRequests')) || [];
        // NEW: unconfirmedDonation tracks the ID and details of the most recent donation that needs confirmation
        let unconfirmedDonation = JSON.parse(localStorage.getItem('unconfirmedDonation')) || null;
        let isLoggedIn = user !== null;
        let allReviews = JSON.parse(localStorage.getItem('allReviews')) || [];

        // --- Daily Randomization Logic ---
        
        // Comprehensive list of all possible donation centers
        const ALL_HOSPITALS_DATA = [
            { name: 'Farid Habib Hospital', city: 'Giza', contact: '02-1234-5678', address: '15 El-Gomhoria St, Dokki' },
            { name: 'Agial Hospital', city: 'Cairo', contact: '02-9876-5432', address: '7 Ahmed Orabi St, Maadi' },
            { name: 'National Blood Bank', city: 'Alexandria', contact: '03-1122-3344', address: '42 Corniche Rd, Roshdy' },
            { name: 'El Salam International Hospital', city: 'Giza', contact: '02-2468-1357', address: '22 Mohy El Din Abu El Ezz St, Mohandessin' },
            { name: 'Dar El Fouad Hospital', city: 'Cairo', contact: '02-5555-4444', address: 'Street 9, District 5, New Cairo' },
            { name: 'Misr International Hospital', city: 'Giza', contact: '02-7777-1111', address: '6 October City, Central Spine' },
            { name: 'Cleopatra Hospital', city: 'Cairo', contact: '02-8888-2222', address: 'El Hegaz Street, Heliopolis' },
            { name: 'Andalusia Smouha Hospital', city: 'Alexandria', contact: '03-9999-3333', address: 'Smouha District, Fountain Square' },
            { name: 'Specialist Hospital Mansoura', city: 'Mansoura', contact: '050-1234-9876', address: 'El Geish Street, Mansoura' },
            { name: 'Al Mokhtabar Lab', city: 'Tanta', contact: '040-5678-0123', address: 'El Bahr Street, Tanta' }
        ];

        // A simple seedable PRNG function (Mulberry32) to ensure daily consistency
        function mulberry32(a) {
            return function() {
              var t = a += 0x6d2b79f5;
              t = Math.imul(t ^ t >>> 15, t | 1);
              t ^= t + Math.imul(t ^ t >>> 7, t | 61);
              return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }

        // Function to generate the daily list of active hospitals and their needs
        function generateDailyHospitalData() {
            const today = new Date();
            // Create a seed based on the date (YYYYMMDD)
            const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
            const random = mulberry32(seed);

            // 1. Shuffle and select a subset (e.g., 6 hospitals each day)
            const shuffledHospitals = [...ALL_HOSPITALS_DATA].sort(() => random() - 0.5);
            const dailyHospitals = shuffledHospitals.slice(0, 6); 

            // 2. Assign random but consistent need levels for the day
            const needLevels = ['Critical', 'Urgent', 'Good Supply'];
            
            return dailyHospitals.map(hospital => {
                const needIndex = Math.floor(random() * needLevels.length);
                const need_level = needLevels[needIndex];

                return {
                    ...hospital,
                    need_level: need_level
                };
            });
        }
        
        // Initialize the daily hospital list once at script start
        let HOSPITAL_LOCATIONS = generateDailyHospitalData();

        // --- Awards Data (unchanged) ---
        const AWARDS = [
            { id: 'first-timer', name: 'First Timer', description: 'Complete your first donation.', icon: 'fas fa-medal', requiredDonations: 1 },
            { id: 'triple-donor', name: 'Triple Donor', description: 'Complete 3 donations.', icon: 'fas fa-star', requiredDonations: 3 },
            { id: 'super-saver', name: 'Super Saver', description: 'Complete 5 donations.', icon: 'fas fa-trophy', requiredDonations: 5 },
            { id: 'marathon-donor', name: 'Marathon Donor', description: 'Complete 10 total donations.', icon: 'fas fa-running', requiredDonations: 10 },
            { id: 'universal-donor', name: 'Universal Donor', description: 'Be a universally required O- blood type.', icon: 'fas fa-globe', requiredDonations: 0, isBloodType: true },
            { id: 'local-hero', name: 'Local Hero', description: 'Complete 3 donations in your registered city.', icon: 'fas fa-city', requiredDonations: 3, isLocal: true },
            { id: 'initial-hero-gift', name: 'Initial Hero Gift', description: 'Complete the first three donations and get a discount!', icon: 'fas fa-gift', requiredDonations: 3, isInitial: true },
            { id: 'annual-champion', name: 'Annual Champion', description: 'Complete 6 donations in one year.', icon: 'fas fa-calendar-check', requiredDonations: 6, isAnnual: true }
        ];

        // --- Massive Social Proof Injection (160 UNIQUE Reviews) (unchanged, truncated for brevity) ---
        const NUM_DUMMY_REVIEWS = 160; 
        if (allReviews.filter(r => r.isDummy).length < NUM_DUMMY_REVIEWS) {
            const names = ["Alex K.", "Dana S.", "Chris B.", "Jordan W.", "Taylor R.", "Sam M.", "Robin L.", "Casey J.", "Jamie T.", "Riley A.", "Morgan C.", "Avery E.", "Skylar F.", "Quinn G.", "Peyton H.", "Jesse I.", "Drew N.", "Kai Z.", "Reese X.", "Rowan V.", "Liam G.", "Noah P.", "Oliver J.", "Elijah S.", "William A.", "James B.", "Benjamin C.", "Lucas D.", "Henry F.", "Alexander H.", "Mia T.", "Charlotte V.", "Amelia W.", "Evelyn X.", "Harper Y.", "Sofia Z.", "Abigail A.", "Emily B.", "Elizabeth C.", "Mila D."];
            const baseComments = [ 
                "The process was absolutely seamless. I was in and out quickly and felt like I made a real difference.", 
                "Highly efficient platform for finding donation centers. I appreciate the clear instructions and organization.", 
                "Making a donation appointment was so easy with this app. The user experience is fantastic!", 
                "A vital service for the community. I encourage everyone to use BLODO for their next blood donation.", 
                "The scheduling feature is a game-changer. It removes all the unnecessary hassle and paperwork.", 
                "I am very impressed with the dedication of the team behind this platform and their commitment to health.", 
                "This application makes giving back simpler than ever before. It's a true community helper.", 
                "Quick registration and very helpful during a time of urgent need for my family.", 
                "Excellent way to connect hospitals with willing donors. Five stars for effectiveness!", 
                "I felt motivated to donate because the platform made it so accessible and easy to understand.", 
                "A well-designed and necessary tool. Keep helping people save lives!", 
                "Found a nearby hospital immediately. The location filtering feature is spot on and accurate.", 
                "I had a fantastic experience. The follow-up information and thank you note were very useful.", 
                "Reliable and trustworthy. It's great to see technology used for such a good cause in our region.", 
                "Truly an indispensable resource for managing blood requests and helping those who need it most.", 
                "So grateful for this platform. I wish I had known about it sooner. It's a lifesaver!", 
                "Used it to find blood for my uncle; the match was incredibly fast. Thank Thank you, BLODO.", 
                "A five-star experience from browsing to final confirmation. Professional and caring.", 
                "Simple, modern, and effective. This is exactly what the public needs for donation.", 
                "Definitely recommend BLODO to friends and family. A great example of tech for good." 
            ];
            const adjectives = ["incredibly easy", "surprisingly smooth", "remarkably fast", "totally reliable", "very user-friendly", "highly commendable", "extremely straightforward", "perfectly designed", "absolutely essential", "painless and quick", "a massive relief", "exceptionally well-done"];
            const subjects = ["the scheduling tool", "the hospital search", "the quick match function", "the clear guidance", "the overall process", "the immediate confirmation", "the simple interface", "the clear mission"];
            const closings = [". Will definitely use again.", ". Keep up the great work!", ". Truly a lifesaver.", ". Highly recommended.", ". Fantastic service.", ". So happy I found this app.", ". A huge positive difference.", ". Great example of tech for good."];

            const generateDate = (index) => {
                const day = (index % 30) + 1;
                const month = ((index % 12) + 1) % 12 + 1;
                const year = (month > 6) ? 2024 : 2025;
                return `${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}/${year}`;
            };

            const newReviews = [];
            const existingEmails = new Set(allReviews.map(r => r.email));

            for (let i = 0; i < NUM_DUMMY_REVIEWS; i++) {
                const baseName = names[i % names.length];
                const uniqueNum = (i + 1) * 13 + (Math.floor(Math.random() * 99) + 1);
                const reviewerName = baseName.split(' ')[0] + ' ' + (baseName.split(' ')[1] || 'L.') + uniqueNum.toString().slice(-3);
                let email = `${reviewerName.replace(/[^a-zA-Z0-9]/g, '').toLowerCase()}@dummy.com`;
                
                const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
                const subject = subjects[Math.floor(Math.random() * subjects.length)];
                const closing = closings[Math.floor(Math.random() * closings.length)];
                let comment;
                if (i < baseComments.length) {
                    comment = baseComments[i];
                } else {
                    comment = `The ${subject} is ${adjective}${closing}`;
                }
                
                const stickers = ["❤️", "👍", "🌟", "😊", "🩸"];
                if (Math.random() < 0.3) {
                    comment = stickers[Math.floor(Math.random() * stickers.length)] + " " + comment;
                }

                let rating;
                const r = Math.random();
                if (r < 0.6) {
                    rating = 5;
                } else if (r < 0.9) {
                    rating = 4;
                } else if (r < 0.95) {
                    rating = 3;
                } else {
                    rating = Math.floor(Math.random() * 2) + 1;
                }

                if (!existingEmails.has(email)) {
                    newReviews.push({
                        id: Date.now() + i,
                        email: email,
                        name: reviewerName,
                        rating: rating,
                        comment: comment,
                        date: generateDate(i),
                        isDummy: true
                    });
                    existingEmails.add(email);
                }
            }

            allReviews = newReviews.concat(allReviews);
            localStorage.setItem('allReviews', JSON.stringify(allReviews));
        }

        // --- Core Functions ---

        /**
         * Checks the current year and resets annual donation counts if a new year has started.
         * This function should be called at login and upon confirming a donation.
         */
        function checkAndResetAnnualBadges() {
            if (!user) return;

            const currentYear = new Date().getFullYear();

            // Initialize or reset if the year has changed
            if (user.last_reset_year === undefined || user.last_reset_year < currentYear) {
                user.annual_donations_count = 0;
                user.last_reset_year = currentYear;
                saveUser();
                console.log(`Annual donation count reset for ${currentYear}.`);
            }
        }


        function startSession() {
            // Get all sections and hide them
            document.querySelectorAll('main').forEach(section => {
                section.style.display = 'none';
            });

            // Handle user session
            if (isLoggedIn) {
                // Run the annual badge check at session start
                checkAndResetAnnualBadges();
                
                document.getElementById('welcomeName').textContent = user.name.split(' ')[0];
                document.getElementById('donate-sidebar-link').style.display = 'flex';
                document.getElementById('request-sidebar-link').style.display = 'flex';
                document.getElementById('reports-sidebar-link').style.display = 'flex';
                document.getElementById('awards-sidebar-link').style.display = 'flex';
                document.getElementById('account-sidebar-link').style.display = 'flex';
                document.getElementById('change-password-sidebar-link').style.display = 'flex';
                document.getElementById('logout-sidebar-link').style.display = 'flex';
                document.getElementById('review-sidebar-link').style.display = 'flex';
                document.getElementById('centers-sidebar-link').style.display = 'flex'; // NEW: Show centers link

                // Check for unconfirmed donation upon login
                if (unconfirmedDonation && new Date(unconfirmedDonation.date) < new Date()) {
                    // Appointment is in the past and unconfirmed
                    document.getElementById('unconfirmed-date-display').textContent = unconfirmedDonation.date;
                    document.getElementById('unconfirmed-hospital-display').textContent = unconfirmedDonation.hospital;
                    showSection('confirm-attendance-page');
                } else if (unconfirmedDonation) {
                    // Upcoming appointment
                    document.getElementById('upcoming-date').textContent = unconfirmedDonation.date;
                    document.getElementById('upcoming-hospital').textContent = unconfirmedDonation.hospital;
                    document.getElementById('upcoming-appointment-card').style.display = 'block';
                    
                    // Show reminder banner
                    document.getElementById('reminder-text').textContent = `Reminder: Your appointment is on ${unconfirmedDonation.date} at ${unconfirmedDonation.hospital}.`;
                    document.getElementById('appointment-reminder').style.display = 'flex';

                    showSection('welcome-page');
                } else {
                    // No unconfirmed/upcoming donation
                    document.getElementById('upcoming-appointment-card').style.display = 'none';
                    document.getElementById('appointment-reminder').style.display = 'none';
                    showSection('welcome-page');
                }

            } else {
                // Logged out state
                document.getElementById('donate-sidebar-link').style.display = 'none';
                document.getElementById('request-sidebar-link').style.display = 'none';
                document.getElementById('reports-sidebar-link').style.display = 'none';
                document.getElementById('awards-sidebar-link').style.display = 'none';
                document.getElementById('account-sidebar-link').style.display = 'none';
                document.getElementById('change-password-sidebar-link').style.display = 'none';
                document.getElementById('logout-sidebar-link').style.display = 'none';
                document.getElementById('review-sidebar-link').style.display = 'none';
                document.getElementById('centers-sidebar-link').style.display = 'none'; // NEW: Hide centers link

                showSection('main-page');
            }
        }

        function showSection(id) {
            // Push current page to history if it's not the same as the last one
            const currentSection = document.querySelector('main:not([style*="display: none"])');
            if (currentSection && currentSection.id !== id) {
                // Do not push thank you pages to history
                if (!currentSection.id.includes('-thank-you-') && currentSection.id !== 'confirm-attendance-page') {
                     pageHistory.push(currentSection.id);
                }
            }

            document.querySelectorAll('main').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(id).style.display = 'block';

            // Special logic for specific pages
            if (id === 'account-page' && user) {
                document.getElementById('accountName').textContent = user.name;
                document.getElementById('accountEmail').textContent = user.email;
            } else if (id === 'reviews-history-page') {
                renderReviewsHistory();
            } else if (id === 'awards-badges-page') {
                renderAwardsBadges();
            } else if (id === 'reports-page') {
                renderReports();
            } else if (id === 'hospital-page') {
                // IMPORTANT: Populate the list of daily hospitals when the page is shown
                populateHospitalSelect();
            }
        }
        
        // This function handles going back one page in history
        function goBack() {
            // Special handling for the donation process to ensure clean exit
            if (document.querySelector('#donation-warning-page').style.display === 'block') {
                // From warning page, go back to date page
                showSection('date-page');
                return;
            } else if (pageHistory.length > 0) {
                const prevId = pageHistory.pop();
                // Ensure the previous page is not a thank-you page after popping
                document.querySelectorAll('main').forEach(section => {
                    section.style.display = 'none';
                });
                document.getElementById(prevId).style.display = 'block';
            } else {
                // If history is empty, go to home or main page
                goToHome();
            }
        }

        function goToHome() {
            // Clear history and show the appropriate home page
            pageHistory.length = 0;
            if (isLoggedIn) {
                startSession(); // This handles unconfirmed appointments
            } else {
                showSection('main-page');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        function togglePasswordVisibility(inputId, icon) {
            const input = document.getElementById(inputId);
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = "password";
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function showFeedback(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.color = isError ? '#dc3545' : '#28a745';
            element.style.opacity = '1';

            if (feedbackTimer) {
                clearTimeout(feedbackTimer);
            }

            feedbackTimer = setTimeout(() => {
                element.style.opacity = '0';
            }, 3000);
        }

        function saveUser() {
            localStorage.setItem('currentUser', JSON.stringify(user));
            localStorage.setItem(`user-${user.email}`, JSON.stringify(user));
        }

        function signUp(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const feedback = 'signup-feedback';
            const button = document.getElementById('signup-btn');
            
            button.innerHTML = '<i class="fas fa-spinner loading-icon"></i> Signing Up...';
            button.disabled = true;

            // Simple validation and user creation simulation
            if (localStorage.getItem(`user-${email}`)) {
                setTimeout(() => {
                    showFeedback(feedback, 'Error: An account with this email already exists.', true);
                    button.innerHTML = 'Sign Up';
                    button.disabled = false;
                }, 1000);
                return;
            }

            setTimeout(() => {
                user = {
                    id: Date.now(),
                    name: name,
                    email: email,
                    // Store password for demo only
                    password: password, 
                    total_donations: 0,
                    // NEW: Fields for annual badge and initial reward tracking
                    annual_donations_count: 0,
                    last_reset_year: new Date().getFullYear(),
                    initial_reward_given: false
                };
                isLoggedIn = true;
                saveUser();
                localStorage.setItem(`userPassword-${email}`, password); // Storing the password for login check
                
                button.innerHTML = 'Sign Up';
                button.disabled = false;
                showFeedback(feedback, 'Success! Account created.');
                
                // Immediately start the donation process for the new user
                startDonation();
            }, 1500);
        }

        function login(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const feedback = 'login-feedback';
            const button = document.getElementById('login-btn');

            button.innerHTML = '<i class="fas fa-spinner loading-icon"></i> Logging In...';
            button.disabled = true;

            setTimeout(() => {
                const storedUser = localStorage.getItem(`user-${email}`);
                const storedPassword = localStorage.getItem(`userPassword-${email}`);

                if (storedUser && storedPassword === password) {
                    user = JSON.parse(storedUser);
                    isLoggedIn = true;
                    showFeedback(feedback, 'Success! Logged in.');
                    
                    button.innerHTML = 'Login';
                    button.disabled = false;
                    
                    startSession(); // Go to welcome page
                } else {
                    showFeedback(feedback, 'Error: Invalid email or password.', true);
                    button.innerHTML = 'Login';
                    button.disabled = false;
                }
            }, 1500);
        }

        function logout() {
            if (user) {
                // Save current user state before logging out (in case they have badges/stats)
                saveUser(); 
                user = null;
                isLoggedIn = false;
                // Clear session-specific data if needed, but keep global data.
            }
            // Clear history and start session to go to the main page
            pageHistory.length = 0;
            startSession();
        }

        function changePassword(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const feedback = 'password-feedback';
            const button = document.getElementById('change-password-btn');

            button.innerHTML = '<i class="fas fa-spinner loading-icon"></i> Changing...';
            button.disabled = true;

            setTimeout(() => {
                const storedPassword = localStorage.getItem(`userPassword-${user.email}`);

                if (currentPassword !== storedPassword) {
                    showFeedback(feedback, 'Error: Current password is incorrect.', true);
                } else if (newPassword.length < 6) {
                    showFeedback(feedback, 'Error: New password must be at least 6 characters.', true);
                } else if (newPassword !== confirmNewPassword) {
                    showFeedback(feedback, 'Error: New passwords do not match.', true);
                } else {
                    // Update password in local storage
                    localStorage.setItem(`userPassword-${user.email}`, newPassword);
                    // Update password in the user object (for demo purposes)
                    user.password = newPassword; 
                    saveUser();
                    showFeedback(feedback, 'Success! Your password has been changed.');
                    // Go back to the account page after a short delay
                    setTimeout(showAccount, 1500);
                }
                button.innerHTML = 'Change Password';
                button.disabled = false;
            }, 1500);
        }

        function showLogin() {
            document.getElementById('loginForm').reset();
            showSection('login-form');
        }

        function showSignup() {
            document.getElementById('signupForm').reset();
            showSection('signup-form');
        }

        function showAccount() {
            showSection('account-page');
        }

        function showChangePassword() {
            document.getElementById('changePasswordForm').reset();
            showSection('change-password-page');
        }

        function startDonation() {
            // Clear previous donation data
            donationData = {};
            // Start the donation process
            showSection('age-page');
        }

        function startRequest() {
            document.getElementById('requestBloodType').value = '';
            document.getElementById('requestCity').value = '';
            document.getElementById('requestDate').value = '';
            document.getElementById('requestReason').value = '';
            // Ensure the dynamic 'Other City' input is hidden
            const otherRequestCityInput = document.getElementById('otherRequestCity').parentElement;
            otherRequestCityInput.style.maxHeight = '0';
            
            showSection('request-blood-page');
        }
        
        function saveAge() {
            const age = document.getElementById('age').value;
            if (parseInt(age) < 18 || !age) {
                alert("You must be 18 or older to donate blood.");
                return;
            }
            donationData.age = age;
            showSection('blood-type-page');
        }

        function saveBloodType() {
            const bloodType = document.querySelector('input[name="bloodType"]:checked');
            if (!bloodType) {
                alert("Please select your blood type.");
                return;
            }
            donationData.bloodType = bloodType.value;
            showSection('city-page');
        }

        function saveCity() {
            let city = document.getElementById('city').value;
            if (city === 'Other') {
                city = document.getElementById('otherCity').value;
            }
            if (!city) {
                alert("Please select a city or enter a custom city.");
                return;
            }
            donationData.city = city;
            showSection('hospital-page');
        }
        
        // New function to dynamically populate the hospital dropdown based on daily data
        function populateHospitalSelect() {
            const hospitalSelect = document.getElementById('hospital');
            hospitalSelect.innerHTML = '<option value="">Select a hospital</option>';
            
            // Filter the daily list to only show hospitals in the user's selected city
            const filteredHospitals = HOSPITAL_LOCATIONS.filter(h => h.city === donationData.city);
            
            filteredHospitals.forEach(hospital => {
                const option = document.createElement('option');
                option.value = hospital.name;
                option.textContent = hospital.name;
                hospitalSelect.appendChild(option);
            });
            
            // Add the 'Other' option
            const otherOption = document.createElement('option');
            otherOption.value = 'Other';
            otherOption.textContent = 'Other';
            hospitalSelect.appendChild(otherOption);
        }

        function saveHospital() {
            let hospital = document.getElementById('hospital').value;
            if (hospital === 'Other') {
                hospital = document.getElementById('otherHospital').value;
            }
            if (!hospital) {
                alert("Please select a hospital or enter a custom hospital.");
                return;
            }
            donationData.hospital = hospital;
            showSection('date-page');
        }

        function saveDate() {
            const dateInput = document.getElementById('donationDate');
            const donationDate = dateInput.value;
            
            if (!donationDate) {
                alert("Please select a donation date.");
                return;
            }
            
            const selectedDate = new Date(donationDate);
            const today = new Date();
            today.setHours(0,0,0,0); // Normalize 'today' to the start of the day
            
            if (selectedDate < today) {
                alert("The donation date cannot be in the past.");
                return;
            }
            
            // Check for 56-day rule
            const allConfirmedDonations = allDonations.filter(d => d.email === user.email && d.confirmed === true);
            if (allConfirmedDonations.length > 0) {
                // Find the latest confirmed donation date
                const lastDonationDateStr = allConfirmedDonations.reduce((latest, current) => {
                    return (new Date(current.date) > new Date(latest.date)) ? current : latest;
                }).date;
                const lastDonationDate = new Date(lastDonationDateStr);

                // Calculate the 56-day interval
                const nextRecommendedDate = new Date(lastDonationDate);
                nextRecommendedDate.setDate(lastDonationDate.getDate() + 56);
                nextRecommendedDate.setHours(0,0,0,0);

                if (selectedDate < nextRecommendedDate) {
                    // Show warning page
                    document.getElementById('lastDonationDateDisplay').textContent = lastDonationDateStr;
                    document.getElementById('nextRecommendedDateDisplay').textContent = nextRecommendedDate.toLocaleDateString();
                    document.getElementById('selectedDonationDateDisplay').textContent = donationDate;
                    showSection('donation-warning-page');
                    
                    // We need to keep track of the selected date for when the user skips the warning
                    donationData.date = donationDate;
                    return; 
                }
            }

            // If no warning needed (or they are a first-time donor)
            donationData.date = donationDate;
            showSection('sickness-page');
        }
        
        function skipWarning() {
            // The date is already stored in donationData from saveDate()
            showSection('sickness-page');
        }

        function saveSickness() {
            const sickness = document.getElementById('sickness').value;
            if (!sickness) {
                alert("Please enter any sicknesses or 'None'.");
                return;
            }
            donationData.sickness = sickness;
            
            // Display review data
            document.getElementById('reviewAge').textContent = donationData.age;
            document.getElementById('reviewBloodType').textContent = donationData.bloodType;
            document.getElementById('reviewCity').textContent = donationData.city;
            document.getElementById('reviewHospital').textContent = donationData.hospital;
            document.getElementById('reviewDate').textContent = donationData.date;
            document.getElementById('reviewSickness').textContent = donationData.sickness;
            
            showSection('review-page');
        }

        function confirmDonation() {
            const newDonation = {
                id: Date.now(),
                email: user.email,
                name: user.name,
                bloodType: donationData.bloodType,
                city: donationData.city,
                hospital: donationData.hospital,
                date: donationData.date,
                sickness: donationData.sickness,
                confirmed: false // Default to unconfirmed until user verifies attendance
            };
            
            // Store the ID of this donation as the one awaiting confirmation
            unconfirmedDonation = {
                id: newDonation.id,
                date: newDonation.date,
                hospital: newDonation.hospital
            };
            
            // Clear the old unconfirmed donation from the full list if it exists and wasn't confirmed/missed
            allDonations = allDonations.filter(d => d.confirmed !== false && d.email === user.email);
            
            // Add the new donation to the main list
            allDonations.push(newDonation);

            // Save all updated data
            localStorage.setItem('allDonations', JSON.stringify(allDonations));
            localStorage.setItem('unconfirmedDonation', JSON.stringify(unconfirmedDonation));

            // Show thank you page
            document.getElementById('confirmed-date').textContent = newDonation.date;
            showSection('thank-you-page');
        }
        
        function clearUnconfirmedDonation() {
            if (unconfirmedDonation) {
                const donationToClear = allDonations.find(d => d.id === unconfirmedDonation.id);
                if (donationToClear) {
                    // Remove the pending/unconfirmed entry from the master list
                    allDonations = allDonations.filter(d => d.id !== unconfirmedDonation.id);
                    localStorage.setItem('allDonations', JSON.stringify(allDonations));
                    
                    // Clear the upcoming appointment card
                    document.getElementById('upcoming-appointment-card').style.display = 'none';
                    document.getElementById('appointment-reminder').style.display = 'none';
                }
                
                // Clear the unconfirmed tracker
                unconfirmedDonation = null;
                localStorage.removeItem('unconfirmedDonation');
                
                alert('Your upcoming appointment has been cleared.');
                startSession(); // Refresh to ensure correct display
            }
        }
        
        function confirmAttendance(attended) {
            if (!unconfirmedDonation) return;

            const donationIndex = allDonations.findIndex(d => d.id === unconfirmedDonation.id);

            if (donationIndex !== -1) {
                allDonations[donationIndex].confirmed = attended;

                if (attended) {
                    // Update user's stats only if confirmed
                    user.total_donations += 1;
                    user.annual_donations_count += 1; // Increment annual count
                    saveUser();
                    
                    // Award check (no arguments needed now)
                    checkAwards();

                    // NEW: Check for the initial reward after the confirmation
                    if (user.total_donations === 3 && user.initial_reward_given === false) {
                        issueInitialReward();
                    }
                    
                    alert("Thank you! Your donation has been successfully recorded.");
                } else {
                    alert("Your appointment has been marked as missed. You can schedule a new one at any time.");
                }
                
                // Save updated allDonations array
                localStorage.setItem('allDonations', JSON.stringify(allDonations));
            } else {
                alert("Error: Could not find the pending donation record.");
            }
            
            // Clear the unconfirmed tracker
            unconfirmedDonation = null;
            localStorage.removeItem('unconfirmedDonation');
            
            startSession(); // Go back to welcome page
        }
        
        // NEW: Function to issue the initial reward
        function issueInitialReward() {
            if (user && user.initial_reward_given === false) {
                user.initial_reward_given = true;
                saveUser();
                
                // Notify the user
                alert("🎉 CONGRATULATIONS! 🎉\n\nYou have completed your third donation and earned the Initial Hero Gift!\n\nUse code **BLODO-HERO-10** for a 10% discount on health products at our partner store!");
                
                // Re-render badges to show the new one is unlocked
                renderAwardsBadges();
            }
        }
        
        // REFACTORED: checkAwards now calculates donations internally and handles custom logic
        function checkAwards() {
            // Get all confirmed donations for the current user
            const userDonations = allDonations.filter(d => d.email === user.email && d.confirmed === true);
            const totalDonations = userDonations.length;
            const unlockedBadges = user.unlocked_badges || [];
            
            // Data needed for conditional checks
            let userBloodType = '';
            let userCity = '';
            if (userDonations.length > 0) {
                // Get the data from the most recent confirmed donation
                const latestDonation = userDonations.reduce((latest, current) => {
                    return (new Date(current.date) > new Date(latest.date)) ? current : latest;
                });
                userBloodType = latestDonation.bloodType;
                userCity = latestDonation.city;
            }

            AWARDS.forEach(award => {
                if (unlockedBadges.includes(award.id)) return; // Skip if already unlocked

                let conditionMet = false;

                // 1. Total Donation Count Badges (First Timer, Triple, Super Saver, Marathon, Initial Hero Gift)
                if (award.requiredDonations > 0 && !award.isAnnual && !award.isLocal && !award.isBloodType) {
                    if (totalDonations >= award.requiredDonations) {
                        conditionMet = true;
                    }
                } 
                // 2. Annual Badge (Annual Champion)
                else if (award.isAnnual) {
                    if (user.annual_donations_count >= award.requiredDonations) {
                        conditionMet = true;
                    }
                }
                // 3. Universal Donor Badge (O- blood type check)
                else if (award.isBloodType && award.id === 'universal-donor') {
                    if (userBloodType === 'O-') {
                        conditionMet = true;
                    }
                }
                // 4. Local Hero Badge (3 donations in registered city)
                else if (award.isLocal) {
                    // Count donations in the user's city
                    const cityDonations = userDonations.filter(d => d.city === userCity);
                    if (cityDonations.length >= award.requiredDonations) {
                        conditionMet = true;
                    }
                }

                // If condition is met, unlock and alert
                if (conditionMet) {
                    unlockedBadges.push(award.id);
                    alert(`Congratulations! You unlocked the ${award.name} badge!`);
                }
            });

            user.unlocked_badges = unlockedBadges;
            saveUser();
        }

        // FIX: Ensure this function is explicitly defined for the sidebar link
        function showAwardsBadges() {
            showSection('awards-badges-page');
            renderAwardsBadges();
        }

        function renderAwardsBadges() {
            const grid = document.getElementById('awards-grid');
            grid.innerHTML = '';
            
            const allBadges = AWARDS;
            const unlockedIds = user.unlocked_badges || [];
            
            // Remove previous banner if one exists
            const existingBanner = grid.previousElementSibling;
            if (existingBanner && existingBanner.classList.contains('reminder-banner')) {
                 existingBanner.remove();
            }

            // Add initial gift message if earned
            if (user.initial_reward_given) {
                grid.insertAdjacentHTML('beforebegin', '<div class="reminder-banner" style="background-color: gold; color: #333; margin-bottom: 2rem;"><i class="fas fa-gift"></i> **Your Gift Code: BLODO-HERO-10**</div>');
            }


            allBadges.forEach(award => {
                const isUnlocked = unlockedIds.includes(award.id);
                const badgeCard = document.createElement('div');
                badgeCard.className = `badge-card ${isUnlocked ? 'unlocked' : ''}`;
                
                let progress = '';
                if (award.isAnnual) {
                    progress = `(${user.annual_donations_count}/${award.requiredDonations} this year)`;
                } else if (award.isBloodType) {
                    progress = 'Required: O- Blood';
                } else if (award.isLocal) {
                    const userDonations = allDonations.filter(d => d.email === user.email && d.confirmed === true);
                    let userCity = userDonations.length > 0 ? userDonations[userDonations.length - 1].city : 'N/A';
                    const cityDonationsCount = userDonations.filter(d => d.city === userCity).length;
                    progress = `(${cityDonationsCount}/${award.requiredDonations} in ${userCity})`;
                } else if (award.requiredDonations > 0) {
                    progress = `(${user.total_donations}/${award.requiredDonations})`;
                }
                
                const progressText = `<p style="font-size: 0.8rem; color: #555;">${isUnlocked ? 'UNLOCKED' : progress}</p>`;

                badgeCard.innerHTML = `
                    <i class="${award.icon} badge-icon"></i>
                    <div class="badge-name">${award.name}</div>
                    <p style="font-size: 0.9rem; margin-top: 5px;">${award.description}</p>
                    ${progressText}
                `;
                
                grid.appendChild(badgeCard);
            });
        }


        function submitRequest() {
            const bloodType = document.getElementById('requestBloodType').value;
            let city = document.getElementById('requestCity').value;
            if (city === 'Other') {
                city = document.getElementById('otherRequestCity').value;
            }
            const date = document.getElementById('requestDate').value;
            const reason = document.getElementById('requestReason').value;

            if (!bloodType || !city || !date || !reason) {
                alert("Please fill in all request fields.");
                return;
            }

            const newRequest = {
                id: Date.now(),
                requesterEmail: user.email,
                bloodType: bloodType,
                city: city,
                dateNeeded: date,
                reason: reason
            };

            allRequests.push(newRequest);
            localStorage.setItem('allRequests', JSON.stringify(allRequests));

            showSection('request-thank-you-page');
        }
        
        function renderReports() {
            // Donations Table
            const donationsContainer = document.getElementById('donations-table-container');
            const confirmedDonations = allDonations.filter(d => d.confirmed === true);
            
            if (confirmedDonations.length === 0) {
                donationsContainer.innerHTML = '<p id="no-donations-message" style="text-align: center; color: #777;">No donations have been submitted yet.</p>';
            } else {
                let tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Blood Type</th>
                                <th>City</th>
                                <th>Hospital</th>
                                <th>Date</th>
                                <th>Sickness</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                confirmedDonations.forEach(d => {
                    const status = d.confirmed === true ? 'Completed' : (d.confirmed === false ? 'Missed' : 'Pending');
                    const statusColor = d.confirmed === true ? '#28a745' : (d.confirmed === false ? '#f44336' : '#ffc107');
                    
                    tableHTML += `
                        <tr>
                            <td>${d.name}</td>
                            <td>${d.bloodType}</td>
                            <td>${d.city}</td>
                            <td>${d.hospital}</td>
                            <td>${d.date}</td>
                            <td>${d.sickness}</td>
                            <td style="color: ${statusColor}; font-weight: 600;">${status}</td>
                        </tr>
                    `;
                });
                tableHTML += '</tbody></table>';
                donationsContainer.innerHTML = tableHTML;
            }

            // Requests Table
            const requestsContainer = document.getElementById('requests-table-container');
            if (allRequests.length === 0) {
                requestsContainer.innerHTML = '<p id="no-requests-message" style="text-align: center; color: #777;">No requests have been submitted yet.</p>';
            } else {
                let tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Blood Type</th>
                                <th>City</th>
                                <th>Date Needed</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                allRequests.forEach(r => {
                    tableHTML += `
                        <tr>
                            <td>${r.bloodType}</td>
                            <td>${r.city}</td>
                            <td>${r.dateNeeded}</td>
                            <td>${r.reason}</td>
                        </tr>
                    `;
                });
                tableHTML += '</tbody></table>';
                requestsContainer.innerHTML = tableHTML;
            }
        }
        
        function exportToExcel() {
            if (allDonations.length === 0 && allRequests.length === 0) {
                alert("There is no data to export.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // --- Donations CSV ---
            csvContent += "--- Donations Report ---\n";
            if (allDonations.length > 0) {
                const donationHeaders = ["Name", "Email", "Blood Type", "City", "Hospital", "Date", "Sickness", "Status"];
                csvContent += donationHeaders.join(",") + "\n";
                allDonations.forEach(d => {
                    const status = d.confirmed === true ? 'Completed' : (d.confirmed === false ? 'Missed' : 'Pending');
                    const row = [d.name, d.email, d.bloodType, d.city, d.hospital, d.date, d.sickness, status];
                    csvContent += row.join(",") + "\n";
                });
            } else {
                csvContent += "No Donation Records\n";
            }

            // --- Requests CSV ---
            csvContent += "\n--- Requests Report ---\n";
            if (allRequests.length > 0) {
                const requestHeaders = ["Requester Email", "Blood Type", "City", "Date Needed", "Reason"];
                csvContent += requestHeaders.join(",") + "\n";
                allRequests.forEach(r => {
                    // Sanitize reason field for CSV by enclosing in quotes if it contains commas
                    const reason = r.reason.includes(',') ? `"${r.reason.replace(/"/g, '""')}"` : r.reason;
                    const row = [r.requesterEmail, r.bloodType, r.city, r.dateNeeded, reason];
                    csvContent += row.join(",") + "\n";
                });
            } else {
                csvContent += "No Request Records\n";
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "BLODO_Report_" + new Date().toISOString().slice(0, 10) + ".csv");
            document.body.appendChild(link); // Required for Firefox
            link.click();
            document.body.removeChild(link);
            
            alert("Data exported successfully!");
        }
        
        function resetData() {
            if (confirm("WARNING: This will clear ALL donation, request, and review data for all users. Are you sure?")) {
                localStorage.clear();
                // Re-initialize variables to empty state
                user = null;
                isLoggedIn = false;
                donationData = {};
                pageHistory.length = 0;
                allDonations = [];
                allRequests = [];
                unconfirmedDonation = null;
                allReviews = [];
                // Re-inject dummy reviews
                location.reload(); 
            }
        }
        
        // Review functions
        let currentEditingReviewId = null;

        function submitReview(event) {
            event.preventDefault();
            const rating = parseInt(document.getElementById('reviewRating').value);
            const comment = document.getElementById('reviewComment').value.trim();
            const feedback = 'review-feedback';

            if (rating === 0) {
                showFeedback(feedback, 'Please select a star rating.', true);
                return;
            }

            if (currentEditingReviewId !== null) {
                // Editing existing review
                const reviewIndex = allReviews.findIndex(r => r.id === currentEditingReviewId);
                if (reviewIndex !== -1) {
                    allReviews[reviewIndex].rating = rating;
                    allReviews[reviewIndex].comment = comment;
                    allReviews[reviewIndex].date = new Date().toLocaleDateString('en-US');
                    allReviews[reviewIndex].isDummy = false; // Mark as real user data
                    localStorage.setItem('allReviews', JSON.stringify(allReviews));
                    showSection('review-thank-you-page');
                } else {
                    showFeedback(feedback, 'Error: Could not find review to edit.', true);
                }
            } else {
                // New review
                if (allReviews.some(r => r.email === user.email && r.isDummy === false)) {
                    showFeedback(feedback, 'You have already submitted a review. Please use the View Reviews page to edit it.', true);
                    return;
                }

                const newReview = {
                    id: Date.now(),
                    email: user.email,
                    name: user.name,
                    rating: rating,
                    comment: comment,
                    date: new Date().toLocaleDateString('en-US'),
                    isDummy: false
                };

                // Remove any dummy review by the same user email before adding the real one
                allReviews = allReviews.filter(r => r.email !== user.email || r.isDummy === false);
                
                allReviews.unshift(newReview);
                localStorage.setItem('allReviews', JSON.stringify(allReviews));
                
                showSection('review-thank-you-page');
            }
            
            // Reset state
            currentEditingReviewId = null;
        }
        
        function showReviewForm() {
            // Reset for a new submission
            currentEditingReviewId = null;
            document.getElementById('reviewForm').reset();
            document.getElementById('reviewRating').value = 0;
            document.querySelectorAll('#rating-stars .fa-star').forEach(star => {
                star.classList.remove('checked');
            });

            // If the user already has a real review, make them edit it
            const existingReview = allReviews.find(r => r.email === user.email && r.isDummy === false);
            if (existingReview) {
                editReview(existingReview.id);
            } else {
                showSection('review-form-page');
            }
        }
        
        function editReview(reviewId) {
            const reviewToEdit = allReviews.find(r => r.id === reviewId);
            if (reviewToEdit && reviewToEdit.email === user.email) {
                currentEditingReviewId = reviewId;
                
                // Populate form
                document.getElementById('reviewComment').value = reviewToEdit.comment;
                document.getElementById('reviewRating').value = reviewToEdit.rating;
                
                // Set star rating visually
                document.querySelectorAll('#rating-stars .fa-star').forEach(star => {
                    const ratingValue = parseInt(star.getAttribute('data-rating'));
                    if (ratingValue <= reviewToEdit.rating) {
                        star.classList.add('checked');
                    } else {
                        star.classList.remove('checked');
                    }
                });
                
                showSection('review-form-page');
            }
        }

        function renderReviewsHistory() {
            const listContainer = document.getElementById('reviews-list-container');
            const reviewsToShow = allReviews.sort((a, b) => b.id - a.id); // Sort by newest first
            listContainer.innerHTML = '';
            
            if (reviewsToShow.length === 0) {
                 document.getElementById('no-reviews-message').style.display = 'block';
                 return;
            } else {
                document.getElementById('no-reviews-message').style.display = 'none';
            }

            reviewsToShow.forEach(review => {
                const isUserReview = user && review.email === user.email;
                
                const reviewCard = document.createElement('div');
                reviewCard.className = 'review-card';
                
                const stars = Array(5).fill().map((_, i) => 
                    `<i class="fas fa-star ${i < review.rating ? 'checked' : ''}"></i>`
                ).join('');
                
                let editButton = '';
                if (isUserReview) {
                    editButton = `<button class="edit-btn" onclick="editReview(${review.id})">Edit</button>`;
                }

                reviewCard.innerHTML = `
                    <h4 style="margin-top: 0; color: #555;">${review.name} ${isUserReview ? '**(You)**' : ''} ${editButton}</h4>
                    <p class="card-rating" style="margin-bottom: 5px; font-size: 1.2rem;">${stars}</p>
                    <p style="font-size: 1.1rem; line-height: 1.4;">${review.comment}</p>
                    <p style="font-size: 0.85rem; color: #999; text-align: right; margin-top: 10px;">Submitted: ${review.date}</p>
                `;
                listContainer.appendChild(reviewCard);
            });
        }
        
        function addSticker(stickerElement) {
            const sticker = stickerElement.getAttribute('data-sticker');
            const commentInput = document.getElementById('reviewComment');
            
            let currentText = commentInput.value.trim();
            
            // Check if the comment already starts with this sticker
            if (currentText.startsWith(sticker)) {
                commentInput.value = currentText; // Do nothing
            } else if (currentText.startsWith("❤️") || currentText.startsWith("👍") || currentText.startsWith("🌟") || currentText.startsWith("😊") || currentText.startsWith("🩸")) {
                // If a different sticker is already present, replace it
                const parts = currentText.split(' ');
                parts[0] = sticker;
                commentInput.value = parts.join(' ');
            } else if (currentText === "") {
                // If empty, just add the sticker
                 commentInput.value = sticker + " ";
            } else {
                // Prepend the sticker
                commentInput.value = sticker + " " + currentText;
            }
            commentInput.focus();
        }

        // NEW: Function to display the centers as a text list instead of a map
        function renderDonationCenters() {
            const listContainer = document.getElementById('centers-list');
            if (!listContainer) return;
            listContainer.innerHTML = ''; // Clear previous content

            // Regenerate the list to ensure the current day's data is shown
            HOSPITAL_LOCATIONS = generateDailyHospitalData();

            HOSPITAL_LOCATIONS.forEach(center => {
                let color, urgencyText;
                switch (center.need_level) {
                    case 'Critical':
                        color = '#dc3545'; // Red
                        urgencyText = 'Critical Shortage';
                        break;
                    case 'Urgent':
                        color = '#ffc107'; // Yellow/Orange
                        urgencyText = 'Urgent Need';
                        break;
                    case 'Good Supply':
                    default:
                        color = '#28a745'; // Green
                        urgencyText = 'Good Supply';
                        break;
                }

                const centerCard = document.createElement('div');
                centerCard.className = 'review-card'; // Reusing a similar card style
                centerCard.innerHTML = `
                    <h3 style="margin-top:0; color: #007bff;">${center.name}</h3>
                    <p><strong>City:</strong> ${center.city}</p>
                    <p><strong>Address:</strong> ${center.address}</p>
                    <p><strong>Contact:</strong> ${center.contact}</p>
                    <p><strong>Supply Need:</strong> <span style="color: ${color}; font-weight: 700;">${urgencyText}</span></p>
                `;
                listContainer.appendChild(centerCard);
            });

            // Make sure to show the correct page
            showSection('donation-centers-page');
        }


        // --- Event Listeners and Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Star rating handler
            document.querySelectorAll('#rating-stars .fa-star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    document.getElementById('reviewRating').value = rating;
                    document.querySelectorAll('#rating-stars .fa-star').forEach(s => {
                        const sRating = parseInt(s.getAttribute('data-rating'));
                        if (sRating <= rating) {
                            s.classList.add('checked');
                        } else {
                            s.classList.remove('checked');
                        }
                    });
                });
            });

            // Dynamic 'Other' input listeners
            const citySelect = document.getElementById('city');
            const otherCityInput = document.getElementById('otherCity').parentElement;
            if (citySelect) {
                citySelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        otherCityInput.style.maxHeight = otherCityInput.scrollHeight + "px";
                    } else {
                        otherCityInput.style.maxHeight = '0';
                    }
                });
            }

            const hospitalSelect = document.getElementById('hospital');
            const otherHospitalInput = document.getElementById('otherHospital').parentElement;
            if (hospitalSelect) {
                hospitalSelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        otherHospitalInput.style.maxHeight = otherHospitalInput.scrollHeight + "px";
                    } else {
                        otherHospitalInput.style.maxHeight = '0';
                    }
                });
            }

            const requestCitySelect = document.getElementById('requestCity');
            const otherRequestCityInput = document.getElementById('otherRequestCity').parentElement;
            if (requestCitySelect) {
                requestCitySelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        otherRequestCityInput.style.maxHeight = otherRequestCityInput.scrollHeight + "px";
                    } else {
                        otherRequestCityInput.style.maxHeight = '0';
                    }
                });
            }

            // Start the session based on whether a user is loaded from local storage
            startSession();
        });
    </script>
</body>
</html>
