<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLODO - Arsany Mina Fawzy</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');

        :root {
            --sidebar-width: 250px;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f0f2f5 0%, #d4e0ff 100%);
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        header {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: #fff;
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* Approximate height of the header */
            min-height: 100px;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-content i {
            font-size: 2rem;
        }


        h1, h2, h4 {
            margin: 0;
            font-weight: 600;
        }
        
        h4 {
            font-size: 1rem;
            opacity: 0.9;
        }

        main {
            padding: 2rem 1rem;
            display: none;
            width: 100%;
            max-width: 800px;
            margin-top: 150px;
            transition: margin-left 0.3s ease-in-out;
        }

        .container {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: slideUp 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .main-page-container {
            text-align: center;
        }

        .main-page-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .main-page-content h2 {
            font-size: 2.5rem;
            color: #dc3545;
            margin-bottom: 0.5rem;
        }

        .main-page-content p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .main-page-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.4s, box-shadow 0.4s;
            font-size: 1rem;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.15);
            outline: none;
        }
        
        /* PASSWORD VISIBILITY STYLES */
        .password-container {
            position: relative;
        }
        .password-container input {
            padding-right: 40px !important; /* Make space for the icon */
        }
        .toggle-password {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 1rem;
            transition: color 0.2s;
            z-index: 10;
        }
        .toggle-password:hover {
            color: #dc3545;
        }

        button {
            background-color: #dc3545;
            color: #fff;
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.3s;
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .dual-buttons {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 1rem;
        }

        .dual-buttons button {
            width: 50%;
            text-align: center;
        }

        button:hover {
            background-color: #c82333;
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(220, 53, 69, 0.5);
        }

        .welcome-page {
            text-align: center;
        }
        
        /* NEW: Reminder Banner Style */
        .reminder-banner {
            background-color: #ffc107;
            color: #333;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            animation: pulse 1.5s infinite;
        }

        /* NEW: Pulse animation for the reminder banner */
        @keyframes pulse {
            0% { box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(255, 193, 7, 0.8); }
            100% { box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4); }
        }

        .question-page {
            padding: 1.5rem 0;
        }

        .question-page h2 {
            color: #007bff;
            margin-bottom: 1.5rem;
        }

        .radio-group label {
            display: inline-block;
            margin-right: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 400;
        }
        
        .thank-you-page h2 {
            color: #28a745;
        }
        
        /* NEW: Confirmation Page Styling */
        #confirm-attendance-page h2 {
            color: #dc3545;
        }
        #confirm-attendance-page p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }
        #confirm-attendance-page strong {
            color: #007bff;
        }


        .feedback-message {
            text-align: center;
            color: #dc3545;
            margin-bottom: 1rem;
            font-weight: bold;
            opacity: 0;
            animation: fadeInOut 3s forwards;
        }

        .input-group-animation {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.5s ease-in-out;
        }
        
        .faq-item {
            margin-bottom: 1.5rem;
        }

        .faq-item h3 {
            margin-top: 0;
            color: #dc3545;
        }
        
        .faq-item p {
            line-height: 1.6;
        }

        /* New table styles */
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-wrap: break-word;
        }
        
        thead tr {
            background-color: #dc3545;
            color: #fff;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        
        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tbody tr:hover {
            background-color: #e9ecef;
        }
        
        /* Awards & Badges Page Styles */
        .awards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 2rem;
            text-align: center;
        }
        
        .badge-card {
            background: #fff;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #ddd;
            transition: transform 0.3s;
        }
        
        .badge-card.unlocked {
            border-color: gold;
            background: linear-gradient(145deg, #fffbe0, #fff);
        }

        .badge-icon {
            font-size: 3rem;
            color: #ccc;
            margin-bottom: 10px;
        }
        
        .badge-card.unlocked .badge-icon {
            color: gold;
        }
        
        .badge-name {
            font-weight: 700;
            color: #333;
        }


        /* Animations */
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
        }

        .loading-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sidebar Toggle Styling (Left Button) */
        .sidebar-toggle {
            position: fixed;
            top: 25px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
        }

        /* New style for the persistent Home button (Right Button) */
        .home-button-toggle {
            position: fixed;
            top: 25px;
            right: 20px; /* Position on the right side */
            width: 50px;
            height: 50px;
            background: #dc3545;
            color: #fff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.8rem;
            z-index: 1001; /* Ensure it's above the header */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
        }
        
        .sidebar-toggle:hover, .home-button-toggle:hover {
            transform: scale(1.1);
        }

        .sidebar {
            position: fixed;
            /* FIX 1: Shift sidebar below the header */
            top: 100px; 
            left: calc(-1 * var(--sidebar-width));
            width: var(--sidebar-width);
            height: calc(100vh - 100px); /* Fill remaining viewport height */
            background-color: #2c2f33;
            color: #fff;
            padding-top: 0;
            transition: left 0.3s ease-in-out;
            z-index: 999;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.2);
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .sidebar li {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #555;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .sidebar li i {
            font-size: 1.2rem;
            color: #fff;
        }
        .sidebar li:hover {
            background-color: #dc3545;
            color: #fff;
        }
        .sidebar li:hover i {
            color: #fff;
        }
        
        /* --- REVIEW STAR STYLING --- */
        .rating-stars {
            font-size: 2rem;
            cursor: pointer;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: center;
        }
        .rating-stars .fa-star {
            color: #ccc;
            transition: color 0.2s;
        }
        .rating-stars .fa-star.checked,
        .review-card .card-rating .fa-star.checked,
        .rating-stars .fa-star:hover,
        .rating-stars .fa-star:hover ~ .fa-star {
            color: gold;
        }
        /* --- END: REVIEW STAR STYLING --- */
        
        /* --- REVIEW HISTORY CARD STYLING --- */
        .reviews-list-container {
            max-height: 500px; /* Limit height of the review list */
            overflow-y: auto; /* Enable scrolling */
            padding-right: 15px; /* Space for scrollbar */
        }
        
        .review-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .review-card p {
            margin: 0.5rem 0;
        }
        .review-card strong {
            color: #dc3545;
        }
        .review-card .card-rating i {
            color: #ccc; /* Resetting star color for card */
        }
        .review-card .card-rating .fa-star.checked {
            color: gold; /* Only checked stars are gold */
        }
        
        /* Edit button on review card */
        .review-card .edit-btn {
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        .review-card .edit-btn:hover {
            background-color: #0056b3;
            transform: none; /* Override general button hover transform */
            box-shadow: none;
        }
        
        /* --- Sticker Selector --- */
        .sticker-option {
            cursor: pointer;
            transition: transform 0.2s;
            opacity: 0.8;
            padding: 5px; /* Increase hit area */
        }
        .sticker-option:hover {
            transform: scale(1.3);
            opacity: 1;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-content">
            <i class="fas fa-hand-holding-heart"></i>
            <h1>BLODO</h1>
        </div>
        <h4>Arsany Mina Fawzy</h4>
    </header>

    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    
    <button class="home-button-toggle" onclick="goToHome()">
        <i class="fas fa-home"></i>
    </button>
    
    <aside class="sidebar" id="sidebar">
        <ul>
            <li onclick="toggleSidebar(); goToHome()"><i class="fas fa-home"></i> Home</li> 
            <li onclick="toggleSidebar(); startDonation()" id="donate-sidebar-link" style="display:none;"><i class="fas fa-hand-holding-heart"></i> Donate Blood</li>
            <li onclick="toggleSidebar(); startRequest()" id="request-sidebar-link" style="display:none;"><i class="fas fa-hand-holding-medical"></i> Request Blood</li>
            <li onclick="toggleSidebar(); showReportsPage()" id="reports-sidebar-link" style="display:none;"><i class="fas fa-chart-bar"></i> View Reports</li>
            <li onclick="toggleSidebar(); showAwardsBadges()" id="awards-sidebar-link" style="display:none;"><i class="fas fa-trophy"></i> Awards & Badges</li>
            <li onclick="toggleSidebar(); showAccount()" id="account-sidebar-link" style="display:none;"><i class="fas fa-user-circle"></i> Account</li>
            <li onclick="toggleSidebar(); showChangePassword()" id="change-password-sidebar-link" style="display:none;"><i class="fas fa-key"></i> Change Password</li>
            <li onclick="toggleSidebar(); showReviewsHistoryPage()"><i class="fas fa-comments" id="reviews-history-sidebar-link"></i> View Reviews</li>
            <li onclick="toggleSidebar(); showReviewForm()" id="review-sidebar-link" style="display:none;"><i class="fas fa-star"></i> Submit Review</li>
            <li onclick="toggleSidebar(); showSection('help-page')"><i class="fas fa-question-circle"></i> Help</li>
            <li onclick="toggleSidebar(); logout()" id="logout-sidebar-link" style="display:none;"><i class="fas fa-sign-out-alt"></i> Log Out</li>
        </ul>
    </aside>

    <main id="main-page">
        <div class="container main-page-container">
            <div class="main-page-content">
                <h2>Give Blood. Save Lives.</h2>
                <p>Every donation makes a difference. Join the BLODO community to find nearby hospitals and schedule your blood donation easily. Your contribution can save a life.</p>
                <div class="main-page-buttons">
                    <button onclick="showSignup()">Sign Up</button>
                    <button onclick="showLogin()">Login</button>
                </div>
            </div>
        </div>
    </main>

    <main id="signup-form">
        <div class="container">
            <h2>Sign Up</h2>
            <div id="signup-feedback" class="feedback-message"></div>
            <form id="signupForm" onsubmit="signUp(event)">
                <div class="form-group">
                    <label for="signupName">Name:</label>
                    <input type="text" id="signupName" name="signupName" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail">Email:</label>
                    <input type="email" id="signupEmail" name="signupEmail" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword">Password:</label>
                    <div class="password-container">
                        <input type="password" id="signupPassword" name="signupPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('signupPassword', this)"></i>
                    </div>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="signup-btn">
                        Sign Up
                    </button>
                </div>
            </form>
            <p style="margin-top: 1.5rem; text-align: center;">Already have an account? <a href="#" onclick="showLogin()">Login</a></p>
        </div>
    </main>

    <main id="login-form">
        <div class="container">
            <h2>Login</h2>
            <div id="login-feedback" class="feedback-message"></div>
            <form id="loginForm" onsubmit="login(event)">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" name="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <div class="password-container">
                        <input type="password" id="loginPassword" name="loginPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('loginPassword', this)"></i>
                    </div>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="login-btn">
                        Login
                    </button>
                </div>
            </form>
            <p style="margin-top: 1.5rem; text-align: center;">Don't have an account? <a href="#" onclick="showSignup()">Sign Up</a></p>
        </div>
    </main>

    <main id="welcome-page">
        <div class="container welcome-page">
            
            <div id="appointment-reminder" class="reminder-banner" style="display:none;">
                <i class="fas fa-bell"></i> 
                <span id="reminder-text"></span>
            </div>

            <h2>Welcome, <span id="welcomeName"></span>!</h2>
            <p>What would you like to do today?</p>
            <div class="main-page-buttons">
                <button onclick="startDonation()">Start Donation</button>
                <button onclick="startRequest()">Request Blood</button>
            </div>
            
             <div id="upcoming-appointment-card" class="review-card" style="margin-top: 2rem; display: none;">
                <p><strong>Upcoming Donation Appointment:</strong></p>
                <p>Date: <span id="upcoming-date"></span></p>
                <p>Hospital: <span id="upcoming-hospital"></span></p>
                <p style="font-size: 0.9rem; color: #dc3545; margin-top: 10px;">To change this, simply start a new donation process which will overwrite this appointment.</p>
                <button onclick="clearUnconfirmedDonation()" style="background-color: #f44336; width: 100%; margin-top: 0.5rem;">Clear Appointment</button>
            </div>
            
        </div>
    </main>

    <main id="account-page">
        <div class="container">
            <h2>Your Account</h2>
            <p><strong>Name:</strong> <span id="accountName"></span></p>
            <p><strong>Email:</strong> <span id="accountEmail"></span></p>
            <div class="dual-buttons">
                <button onclick="goBack()">Go Back</button>
                <button onclick="showChangePassword()">Change Password</button>
            </div>
            <button onclick="logout()" style="width: 100%; margin-top: 1rem;">Log Out</button>
        </div>
    </main>

    <main id="change-password-page">
        <div class="container">
            <h2>Change Password</h2>
            <div id="password-feedback" class="feedback-message"></div>
            <form id="changePasswordForm" onsubmit="changePassword(event)">
                <div class="form-group">
                    <label for="currentPassword">Current Password:</label>
                    <div class="password-container">
                        <input type="password" id="currentPassword" name="currentPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('currentPassword', this)"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="newPassword">New Password:</label>
                    <div class="password-container">
                        <input type="password" id="newPassword" name="newPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('newPassword', this)"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmNewPassword">Confirm New Password:</label>
                    <div class="password-container">
                        <input type="password" id="confirmNewPassword" name="confirmNewPassword" required>
                        <i class="fas fa-eye toggle-password" onclick="togglePasswordVisibility('confirmNewPassword', this)"></i>
                    </div>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit" id="change-password-btn">
                        Change Password
                    </button>
                </div>
            </form>
        </div>
    </main>
    
    <main id="awards-badges-page">
        <div class="container">
            <h2>Your Donor Achievements</h2>
            <p>Keep track of your life-saving milestones!</p>
            <div id="awards-grid" class="awards-grid">
                </div>
            <button onclick="goBack()" style="width: 100%; margin-top: 2rem;">Go Back</button>
        </div>
    </main>

    <main id="review-form-page">
        <div class="container">
            <h2>Submit a Review</h2>
            <div id="review-feedback" class="feedback-message"></div>
            <form id="reviewForm" onsubmit="submitReview(event)">
                <div class="form-group" style="text-align: center;">
                    <label for="reviewRating">Your Rating:</label>
                    <div class="rating-stars" id="rating-stars">
                        <i class="fas fa-star" data-rating="1"></i>
                        <i class="fas fa-star" data-rating="2"></i>
                        <i class="fas fa-star" data-rating="3"></i>
                        <i class="fas fa-star" data-rating="4"></i>
                        <i class="fas fa-star" data-rating="5"></i>
                    </div>
                    <input type="hidden" id="reviewRating" name="reviewRating" value="0" required>
                </div>
                
                <div class="form-group">
                    <label>Add a Sticker (Optional - click to prepend to comment):</label>
                    <div id="sticker-selector" style="display: flex; gap: 15px; justify-content: center; font-size: 1.5rem; margin-bottom: 1rem;">
                        <span class="sticker-option" data-sticker="❤️" title="Love It" onclick="addSticker(this)">❤️</span>
                        <span class="sticker-option" data-sticker="👍" title="Thumbs Up" onclick="addSticker(this)">👍</span>
                        <span class="sticker-option" data-sticker="🌟" title="Five Stars" onclick="addSticker(this)">🌟</span>
                        <span class="sticker-option" data-sticker="😊" title="Happy" onclick="addSticker(this)">😊</span>
                        <span class="sticker-option" data-sticker="🩸" title="Blood Drop" onclick="addSticker(this)">🩸</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="reviewComment">Comments / Suggestions:</label>
                    <textarea id="reviewComment" rows="5" placeholder="Share your experience with BLODO..." required></textarea>
                </div>
                <div class="dual-buttons">
                    <button type="button" onclick="goBack()">Go Back</button>
                    <button type="submit">Submit Review</button>
                </div>
            </form>
        </div>
    </main>
    
    <main id="reviews-history-page">
        <div class="container">
            <h2>Community Reviews</h2>
            <p>See what others are saying about the BLODO service. Your review will be marked with **(You)** and have an **Edit button**.</p>
            <div id="reviews-list-container" class="reviews-list-container" style="margin-top: 1.5rem;">
                <p id="no-reviews-message" style="text-align: center; color: #777;">No reviews have been submitted yet.</p>
            </div>
            <button onclick="goBack()" style="width: 100%; margin-top: 1.5rem;">Go Back</button>
        </div>
    </main>

    <main id="help-page">
        <div class="container">
            <h2>Frequently Asked Questions</h2>
            <div class="faq-item">
                <h3>Who can donate blood?</h3>
                <p>Most healthy adults aged 18 to 65 can donate blood. You must weigh at least 50 kg (110 lbs) and be in good general health.</p>
            </div>
            <div class="faq-item">
                <h3>How often can I donate?</h3>
                <p>You can donate whole blood every 56 days (about 8 weeks). This allows your body to fully replenish its blood volume and iron stores.</p>
            </div>
            <div class="faq-item">
                <h3>What should I do before donating?</h3>
                <p>Make sure you have had a good night's sleep, eaten a healthy meal, and are well-hydrated. Avoid drinking alcohol 24 hours before your donation.</p>
            </div>
            <div class="faq-item">
                <h3>What happens during the donation process?</h3>
                <p>The entire process, from registration to post-donation rest, takes about one hour. The actual donation itself only takes about 10 minutes.</p>
            </div>
            <p>Still have questions? Contact us at <a href="mailto:arsany.mina.nile@gmail.com">arsany.mina.nile@gmail.com</a>.</p>
            <button onclick="goBack()">Go Back</button>
        </div>
    </main>

    <main id="reports-page">
        <div class="container">
            <h2>Donations and Requests Report</h2>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <button onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i> Export to Excel
                </button>
                <button onclick="resetData()" style="background-color: #f44336; margin-left: auto;">
                    <i class="fas fa-redo"></i> Clear All Data
                </button>
            </div>
            
            <h3>All Donations</h3>
            <div id="donations-table-container" class="table-responsive">
                <p id="no-donations-message" style="text-align: center; color: #777;">No donations have been submitted yet.</p>
            </div>
            
            <h3 style="margin-top: 2rem;">All Requests</h3>
            <div id="requests-table-container" class="table-responsive">
                <p id="no-requests-message" style="text-align: center; color: #777;">No requests have been submitted yet.</p>
            </div>
            
            <button onclick="goBack()" style="width: 100%; margin-top: 2rem;">Go Back</button>
        </div>
    </main>

    <main id="age-page">
        <div class="container">
            <div class="question-page">
                <h2>What is your age?</h2>
                <input type="number" id="age" min="18" required>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveAge()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="blood-type-page">
        <div class="container">
            <div class="question-page">
                <h2>What is your blood type?</h2>
                <div class="radio-group">
                    <label><input type="radio" name="bloodType" value="A+"> A+</label>
                    <label><input type="radio" name="bloodType" value="A-"> A-</label>
                    <label><input type="radio" name="bloodType" value="B+"> B+</label>
                    <label><input type="radio" name="bloodType" value="B-"> B-</label>
                    <label><input type="radio" name="bloodType" value="AB+"> AB+</label>
                    <label><input type="radio" name="bloodType" value="AB-"> AB-</label>
                    <label><input type="radio" name="bloodType" value="O+"> O+</label>
                    <label><input type="radio" name="bloodType" value="O-"> O-</label>
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveBloodType()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="city-page">
        <div class="container">
            <div class="question-page">
                <h2>What city do you live in?</h2>
                <select id="city">
                    <option value="">Select a city</option>
                    <option value="Cairo">Cairo</option>
                    <option value="Alexandria">Alexandria</option>
                    <option value="Giza">Giza</option>
                    <option value="Other">Other</option>
                </select>
                <div class="input-group-animation">
                    <input type="text" id="otherCity" placeholder="Enter city if 'Other' is selected">
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveCity()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="hospital-page">
        <div class="container">
            <div class="question-page">
                <h2>Which hospital do you want to donate to?</h2>
                <select id="hospital">
                    <option value="">Select a hospital</option>
                    <option value="Farid Habib">Farid Habib</option>
                    <option value="Agial Hospital">Agial Hospital</option>
                    <option value="Other">Other</option>
                </select>
                <div class="input-group-animation">
                    <input type="text" id="otherHospital" placeholder="Enter hospital if 'Other' is selected">
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveHospital()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="date-page">
        <div class="container">
            <div class="question-page">
                <h2>What is the date you want to donate?</h2>
                <input type="date" id="donationDate" required>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveDate()">Next</button>
                </div>
            </div>
        </div>
    </main>
    
    <main id="donation-warning-page">
        <div class="container">
            <div class="question-page">
                <h2 style="color: #ffc107;">⚠️ Warning: Short Interval Donation</h2>
                <p>According to standard guidelines, you should wait at least <strong>56 days</strong> between whole blood donations.</p>
                <p>Your last recorded donation was on <strong id="lastDonationDateDisplay"></strong>, and the next recommended date is <strong id="nextRecommendedDateDisplay"></strong>.</p>
                <p>The date you selected, <strong id="selectedDonationDateDisplay"></strong>, is less than 56 days after your last donation.</p>
                <p><strong>Are you sure you want to proceed?</strong> Skipping this warning may make you ineligible at the donation center.</p>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back & Change Date</button>
                    <button onclick="skipWarning()" style="background-color: #ffc107; color: #333; box-shadow: 0 4px 10px rgba(255, 193, 7, 0.4);">Skip Warning & Proceed</button>
                </div>
            </div>
        </div>
    </main>
    <main id="sickness-page">
        <div class="container">
            <div class="question-page">
                <h2>Do you have any sicknesses?</h2>
                <div class="form-group">
                    <textarea id="sickness" rows="4" placeholder="Enter any sicknesses or 'None'" required></textarea>
                </div>
                <div class="dual-buttons">
                    <button onclick="goBack()">Go Back</button>
                    <button onclick="saveSickness()">Next</button>
                </div>
            </div>
        </div>
    </main>

    <main id="review-page">
        <div class="container">
            <h2>Review Your Answers</h2>
            <p><strong>Age:</strong> <span id="reviewAge"></span></p>
            <p><strong>Blood Type:</strong> <span id="reviewBloodType"></span></p>
            <p><strong>City:</strong> <span id="reviewCity"></span></p>
            <p><strong>Hospital:</strong> <span id="reviewHospital"></span></p>
            <p><strong>Donation Date:</strong> <span id="reviewDate"></span></p>
            <p><strong>Sicknesses:</strong> <span id="reviewSickness"></span></p>
            <div class="dual-buttons">
                <button onclick="goBack()">Go Back</button>
                <button onclick="confirmDonation()">Confirm Appointment</button>
            </div>
        </div>
    </main>

    <main id="request-blood-page">
        <div class="container">
            <h2>Request Blood</h2>
            <div class="form-group">
                <label for="requestBloodType">Blood Type Needed:</label>
                <select id="requestBloodType">
                    <option value="">Select blood type</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
            </div>
            <div class="form-group">
                <label for="requestCity">City:</label>
                <select id="requestCity">
                    <option value="">Select a city</option>
                    <option value="Cairo">Cairo</option>
                    <option value="Alexandria">Alexandria</option>
                    <option value="Giza">Giza</option>
                    <option value="Other">Other</option>
                </select>
                <div class="input-group-animation">
                    <input type="text" id="otherRequestCity" placeholder="Enter city if 'Other' is selected">
                </div>
            </div>
            <div class="form-group">
                <label for="requestDate">Date Needed:</label>
                <input type="date" id="requestDate" required>
            </div>
            <div class="form-group">
                <label for="requestReason">Reason for Request:</label>
                <textarea id="requestReason" rows="4" placeholder="e.g., Surgery, Accident, Medical Condition" required></textarea>
            </div>
            <div class="dual-buttons">
                <button onclick="goBack()">Go Back</button>
                <button onclick="submitRequest()">Submit Request</button>
            </div>
        </div>
    </main>
    
    <main id="confirm-attendance-page">
        <div class="container">
            <h2><i class="fas fa-question-circle" style="color: #dc3545;"></i> Did You Attend?</h2>
            <p>We see your scheduled appointment for **<strong id="unconfirmed-date-display"></strong>** at **<strong id="unconfirmed-hospital-display"></strong>** has passed. Can you confirm if you attended your donation appointment?</p>
            <p>Your honest response helps us keep your donor records and badge progress accurate.</p>
            <div class="dual-buttons">
                <button onclick="confirmAttendance(true)" style="background-color: #28a745;">
                    <i class="fas fa-check-circle"></i> Yes, I went!
                </button>
                <button onclick="confirmAttendance(false)" style="background-color: #f44336;">
                    <i class="fas fa-times-circle"></i> No, I missed it.
                </button>
            </div>
        </div>
    </main>
    <main id="thank-you-page">
        <div class="container thank-you-page">
            <h2>Appointment Confirmed!</h2>
            <p>Your appointment for **<span id="confirmed-date"></span>** is now recorded as a **pending donation**. We will ask you to confirm your attendance on your next visit after the scheduled date.</p>
            <button onclick="goToHome()">Return Home</button>
        </div>
    </main>

    <main id="request-thank-you-page">
        <div class="container thank-you-page">
            <h2>Request Submitted!</h2>
            <p>Your blood request has been submitted. We will notify you when a match is found.</p>
            <button onclick="goToHome()">Start Over</button>
        </div>
    </main>
    
    <main id="review-thank-you-page">
        <div class="container thank-you-page">
            <h2>Review Updated!</h2>
            <p>Thank you for your valuable feedback. It helps us improve BLODO!</p>
            <p>You can see your review and others on the "View Reviews" page.</p>
            <button onclick="showReviewsHistoryPage()">View Reviews</button>
        </div>
    </main>

    <script>
        // Load data from Local Storage on startup
        let user = JSON.parse(localStorage.getItem('currentUser')) || null;
        let userPassword = localStorage.getItem('userPassword') || "password123";
        let donationData = {};
        const pageHistory = [];
        let feedbackTimer = null;
        let allDonations = JSON.parse(localStorage.getItem('allDonations')) || [];
        let allRequests = JSON.parse(localStorage.getItem('allRequests')) || [];
        // NEW: unconfirmedDonation tracks the ID and details of the most recent donation that needs confirmation
        let unconfirmedDonation = JSON.parse(localStorage.getItem('unconfirmedDonation')) || null; 
        
        let isLoggedIn = user !== null;
        let allReviews = JSON.parse(localStorage.getItem('allReviews')) || [];
        
        // --- Awards Data ---
        const AWARDS = [
            { id: 'first-timer', name: 'First Timer', description: 'Complete your first donation.', icon: 'fas fa-medal', requiredDonations: 1 },
            { id: 'triple-donor', name: 'Triple Donor', description: 'Complete 3 donations.', icon: 'fas fa-star', requiredDonations: 3 },
            { id: 'super-saver', name: 'Super Saver', description: 'Complete 5 donations.', icon: 'fas fa-trophy', requiredDonations: 5 },
            { id: 'annual-champion', name: 'Annual Champion', description: 'Complete 6 donations in one year.', icon: 'fas fa-calendar-check', requiredDonations: 6, customCheck: (userDonations) => {
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                return userDonations.filter(d => d.confirmed !== false && new Date(d.date) >= oneYearAgo).length >= 6;
            }}
        ];
        
        // --- Massive Social Proof Injection (160 UNIQUE Reviews) ---
        const NUM_DUMMY_REVIEWS = 160;
        
        // Only inject if the reviews array is significantly small (or empty)
        if (allReviews.filter(r => r.isDummy).length < NUM_DUMMY_REVIEWS) {
            
            // Expanded dictionaries for variety
            const names = ["Alex K.", "Dana S.", "Chris B.", "Jordan W.", "Taylor R.", "Sam M.", "Robin L.", "Casey J.", "Jamie T.", "Riley A.", "Morgan C.", "Avery E.", "Skylar F.", "Quinn G.", "Peyton H.", "Jesse I.", "Drew N.", "Kai Z.", "Reese X.", "Rowan V.", "Liam G.", "Noah P.", "Oliver J.", "Elijah S.", "William A.", "James B.", "Benjamin C.", "Lucas D.", "Henry F.", "Alexander H.", "Mia T.", "Charlotte V.", "Amelia W.", "Evelyn X.", "Harper Y.", "Sofia Z.", "Abigail A.", "Emily B.", "Elizabeth C.", "Mila D."];

            const baseComments = [
                "The process was absolutely seamless. I was in and out quickly and felt like I made a real difference.",
                "Highly efficient platform for finding donation centers. I appreciate the clear instructions and organization.",
                "Making a donation appointment was so easy with this app. The user experience is fantastic!",
                "A vital service for the community. I encourage everyone to use BLODO for their next blood donation.",
                "The scheduling feature is a game-changer. It removes all the unnecessary hassle and paperwork.",
                "I am very impressed with the dedication of the team behind this platform and their commitment to health.",
                "This application makes giving back simpler than ever before. It's a true community helper.",
                "Quick registration and very helpful during a time of urgent need for my family.",
                "Excellent way to connect hospitals with willing donors. Five stars for effectiveness!",
                "I felt motivated to donate because the platform made it so accessible and easy to understand.",
                "A well-designed and necessary tool. Keep helping people save lives!",
                "Found a nearby hospital immediately. The location filtering feature is spot on and accurate.",
                "I had a fantastic experience. The follow-up information and thank you note were very useful.",
                "Reliable and trustworthy. It's great to see technology used for such a good cause in our region.",
                "Truly an indispensable resource for managing blood requests and helping those who need it most.",
                "So grateful for this platform. I wish I had known about it sooner. It's a lifesaver!",
                "Used it to find blood for my uncle; the match was incredibly fast. Thank Thank you, BLODO.",
                "A five-star experience from browsing to final confirmation. Professional and caring.",
                "Simple, modern, and effective. This is exactly what the public needs for donation.",
                "Definitely recommend BLODO to friends and family. A great example of tech for good."
            ];
            
            const adjectives = ["incredibly easy", "surprisingly smooth", "remarkably fast", "totally reliable", "very user-friendly", "highly commendable", "extremely straightforward", "perfectly designed", "absolutely essential", "painless and quick", "a massive relief", "exceptionally well-done"];
            const subjects = ["the scheduling tool", "the hospital search", "the quick match function", "the clear guidance", "the overall process", "the immediate confirmation", "the simple interface", "the clear mission"];
            const closings = [". Will definitely use again.", ". Keep up the great work!", ". Truly a lifesaver.", ". Highly recommended.", ". Fantastic service.", ". So happy I found this app.", ". A huge positive difference.", ". Great example of tech for good."];

            // Function to generate pseudo-random dates over the last year
            const generateDate = (index) => {
                const day = (index % 30) + 1;
                // Distribute reviews over the past 12 months in a realistic spread
                const month = ((index % 12) + 1) % 12 + 1; 
                const year = (month > 6) ? 2024 : 2025; // Create a mix of last year and this year
                return `${month.toString().padStart(2, '0')}/${day.toString().padStart(2, '0')}/${year}`;
            };

            const newReviews = [];
            const existingEmails = new Set(allReviews.map(r => r.email));

            for (let i = 0; i < NUM_DUMMY_REVIEWS; i++) {
                // Ensure unique name by combining base name and a large unique number
                const baseName = names[i % names.length];
                const uniqueNum = (i + 1) * 13 + (Math.floor(Math.random() * 99) + 1);
                const reviewerName = baseName.split(' ')[0] + ' ' + (baseName.split(' ')[1] || 'L.') + uniqueNum.toString().slice(-3);
                
                // Create unique email to prevent collision
                let email = `${reviewerName.toLowerCase().replace(/[^a-z]/g, '')}@blodo.com`;
                if (existingEmails.has(email)) {
                    email = `${reviewerName.toLowerCase().replace(/[^a-z]/g, '')}${i}@blodo.com`;
                }
                
                // Construct a unique comment
                const randomBaseComment = baseComments[i % baseComments.length];
                const randomAdjective = adjectives[Math.floor(Math.random() * adjectives.length)];
                const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
                const randomClosing = closings[Math.floor(Math.random() * closings.length)];
                
                // Combine and ensure slight uniqueness
                const uniqueComment = `This platform is **${randomAdjective}** to navigate. ${randomBaseComment.slice(0, 50)}... The support for ${randomSubject} is excellent.${randomClosing} (ID: #${i+1})`;
                
                // Mostly 5 stars, some 4s for realism
                const rating = (i % 8 === 0) ? 4 : 5; 

                newReviews.push({ 
                    name: reviewerName, 
                    email: email, 
                    rating: rating, 
                    comment: uniqueComment, 
                    date: generateDate(i),
                    isDummy: true 
                });
            }
            
            // Keep any real user reviews, then add all the new unique dummy ones
            const realReviews = allReviews.filter(r => !r.isDummy);
            allReviews = realReviews.concat(newReviews);
            saveData();
        }
        // --- END: Massive Social Proof Injection ---

        // Tracks if user has completed a donation or request to enable review submission
        let hasDonatedOrRequested = localStorage.getItem('hasDonatedOrRequested') === 'true';

        // Helper function to format a date string (YYYY-MM-DD) into a readable format
        function formatReadableDate(dateString) {
            try {
                const [year, month, day] = dateString.split('-');
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            } catch (e) {
                return dateString;
            }
        }
        
        // Helper function to get today's date in YYYY-MM-DD format
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Helper to get a date string for X days ago/from now
        function getDateStringFromDate(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function to save all persistent data to Local Storage
        function saveData() {
            localStorage.setItem('currentUser', JSON.stringify(user));
            localStorage.setItem('userPassword', userPassword);
            // Only store donations that were either confirmed or are upcoming/unconfirmed
            localStorage.setItem('allDonations', JSON.stringify(allDonations.filter(d => d.confirmed !== false))); 
            localStorage.setItem('allRequests', JSON.stringify(allRequests));
            localStorage.setItem('allReviews', JSON.stringify(allReviews));
            localStorage.setItem('hasDonatedOrRequested', hasDonatedOrRequested);
            localStorage.setItem('unconfirmedDonation', JSON.stringify(unconfirmedDonation)); // NEW TRACKER
        }

        // Helper function to show a temporary message
        function showMessage(elementId, message) {
            const feedbackElement = document.getElementById(elementId);
            feedbackElement.innerHTML = message;
            feedbackElement.style.opacity = '1';
            clearTimeout(feedbackTimer);
            feedbackTimer = setTimeout(() => {
                feedbackElement.style.opacity = '0';
            }, 3000);
        }

        // Helper function to hide all main sections
        function hideAllSections() {
            document.querySelectorAll('main').forEach(section => {
                section.style.display = 'none';
            });
        }

        // Helper function to show a specific section and manage history
        function showSection(sectionId, addToHistory = true) {
            hideAllSections();
            if (addToHistory && pageHistory[pageHistory.length - 1] !== sectionId) {
                pageHistory.push(sectionId);
            }
            document.getElementById(sectionId).style.display = 'block';
        }
        
        // --- NEW/FIXED SIDEBAR NAVIGATION FUNCTIONS ---
        
        function showReportsPage() {
            // 1. Render Donations Table
            const donationsContainer = document.getElementById('donations-table-container');
            
            // Only show donations that haven't been marked as MISSED (confirmed !== false)
            const confirmedDonations = allDonations.filter(d => d.confirmed !== false);

            if (confirmedDonations.length === 0) {
                donationsContainer.innerHTML = '<p id="no-donations-message" style="text-align: center; color: #777;">No donations have been submitted yet.</p>';
            } else {
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Blood Type</th>
                                <th>Hospital</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>`;
                confirmedDonations.forEach(d => {
                    // Display status based on unconfirmedDonation state and date
                    let status = 'Confirmed';
                    if (unconfirmedDonation && d.donationId === unconfirmedDonation.id) {
                         // Check if the appointment date is today or in the future
                        if (new Date(d.date) >= new Date(getTodayDateString())) {
                            status = `<span style="color: #007bff; font-weight: 600;">Upcoming (${formatReadableDate(d.date)})</span>`;
                        } else {
                             // If it's the unconfirmed one but the date is past
                            status = `<span style="color: #ffc107; font-weight: 600;">Attendance Pending</span>`;
                        }
                    } else if (d.confirmed === true) {
                        status = `<span style="color: #28a745; font-weight: 600;">Completed</span>`;
                    } else if (d.confirmed === undefined && new Date(d.date) < new Date(getTodayDateString())) {
                        // Older donations that somehow missed the check. Default to completed for reporting accuracy.
                        status = `<span style="color: #28a745; font-weight: 600;">Completed</span>`;
                    }
                    
                    tableHtml += `
                        <tr>
                            <td>${d.name}</td>
                            <td>${d.email}</td>
                            <td>${d.bloodType}</td>
                            <td>${d.hospital}</td>
                            <td>${d.date}</td>
                            <td>${status}</td>
                        </tr>`;
                });
                tableHtml += `</tbody></table>`;
                donationsContainer.innerHTML = tableHtml;
            }

            // 2. Render Requests Table (No change)
            const requestsContainer = document.getElementById('requests-table-container');
            if (allRequests.length === 0) {
                requestsContainer.innerHTML = '<p id="no-requests-message" style="text-align: center; color: #777;">No requests have been submitted yet.</p>';
            } else {
                let tableHtml = `
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Blood Type</th>
                                <th>City</th>
                                <th>Date Needed</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>`;
                allRequests.forEach(r => {
                    tableHtml += `
                        <tr>
                            <td>${r.name}</td>
                            <td>${r.email}</td>
                            <td>${r.bloodType}</td>
                            <td>${r.city}</td>
                            <td>${r.date}</td>
                            <td>${r.reason}</td>
                        </tr>`;
                });
                tableHtml += `</tbody></table>`;
                requestsContainer.innerHTML = tableHtml;
            }

            // 3. Show the page
            showSection('reports-page');
        }
        
        function renderAwards() {
            const grid = document.getElementById('awards-grid');
            grid.innerHTML = '';
            
            if (!user) return;

            // Filter donations by the current user and only count confirmed ones (confirmed !== false)
            const userDonations = allDonations.filter(d => d.email === user.email && d.confirmed !== false);
            const donationCount = userDonations.filter(d => d.confirmed === true).length; // Only count fully completed ones

            AWARDS.forEach(award => {
                let isUnlocked = false;

                if (award.customCheck) {
                    isUnlocked = award.customCheck(userDonations);
                } else {
                    isUnlocked = donationCount >= award.requiredDonations;
                }

                const card = document.createElement('div');
                card.className = `badge-card ${isUnlocked ? 'unlocked' : ''}`;
                card.innerHTML = `
                    <i class="${award.icon} badge-icon"></i>
                    <p class="badge-name">${award.name}</p>
                    <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">${award.description}</p>
                `;
                grid.appendChild(card);
            });
        }
        
        function showAwardsBadges() {
            renderAwards();
            showSection('awards-badges-page');
        }
        
        function showAccount() {
            showSection('account-page');
        }
        
        function showChangePassword() {
            document.getElementById('changePasswordForm').reset();
            showSection('change-password-page');
        }
        
        function changePassword(event) {
            event.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const btn = document.getElementById('change-password-btn');

            if (currentPassword !== userPassword) {
                showMessage('password-feedback', "Error: Current password is incorrect.");
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showMessage('password-feedback', "Error: New passwords do not match.");
                return;
            }

            if (newPassword.length < 6) {
                showMessage('password-feedback', "Error: Password must be at least 6 characters long.");
                return;
            }

            btn.innerHTML = '<i class="fas fa-spinner loading-icon"></i> Updating...';

            setTimeout(() => {
                userPassword = newPassword;
                saveData();
                showMessage('password-feedback', "Success: Password changed successfully!");
                btn.innerHTML = 'Change Password';
                document.getElementById('changePasswordForm').reset();
                setTimeout(() => showSection('account-page'), 1000); 
            }, 500);
        }
        
        function exportToExcel() {
            alert("Export to Excel feature is a placeholder. You can copy the data from the tables above.");
        }

        // Resets all Local Storage data
        function resetData() {
            if (confirm("Are you sure you want to clear ALL stored BLODO data (user, passwords, donations, requests, reviews, pending appointments)? This action cannot be undone.")) {
                localStorage.clear();
                // Re-initialize global variables
                user = null;
                userPassword = "password123";
                allDonations = [];
                allRequests = [];
                allReviews = [];
                hasDonatedOrRequested = false;
                unconfirmedDonation = null; // NEW
                
                alert("All data has been cleared. Reloading page to reset the environment.");
                location.reload(); 
            }
        }
        
        // --- END: NEW/FIXED SIDEBAR NAVIGATION FUNCTIONS ---
        
        // Home navigation logic
        function goToHome() {
            if (user) {
                // 1. Check if an attendance confirmation is needed. This MUST run first.
                if (checkForUnconfirmedAppointment()) {
                    return; // Stop here and show confirmation page
                }
                
                // 2. If no confirmation is needed, set the reminder for the upcoming appointment
                setAppointmentReminder();

                showSection('welcome-page');
            } else {
                showSection('main-page');
            }
        }

        // Helper function to navigate back
        function goBack() {
            if (pageHistory.length > 1) {
                pageHistory.pop();
                const previousPageId = pageHistory[pageHistory.length - 1];
                showSection(previousPageId, false);
            } else {
                goToHome();
            }
        }

        // Toggles the sidebar open and closed
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }

        // Toggle password visibility
        function togglePasswordVisibility(id, iconElement) {
            const input = document.getElementById(id);
            if (input.type === 'password') {
                input.type = 'text';
                iconElement.classList.remove('fa-eye');
                iconElement.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                iconElement.classList.remove('fa-eye-slash');
                iconElement.classList.add('fa-eye');
            }
        }

        // Handles the persistent login process
        function login(event) {
            event.preventDefault();
            const loginBtn = document.getElementById('login-btn');
            loginBtn.innerHTML = '<i class="fas fa-spinner loading-icon"></i> Processing...';
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (password !== userPassword) {
                showMessage('login-feedback', "Incorrect email or password.");
                loginBtn.innerHTML = 'Login';
                return;
            }

            setTimeout(() => {
                const storedUser = JSON.parse(localStorage.getItem('currentUser'));
                if (storedUser) {
                    user = storedUser;
                } else {
                    const fallbackName = email.split('@')[0];
                    const dynamicName = fallbackName.charAt(0).toUpperCase() + fallbackName.slice(1);
                    user = { name: dynamicName, email: email };
                    saveData();
                }
                
                isLoggedIn = true; 
                startSession();
                loginBtn.innerHTML = 'Login';
            }, 500);
        }
        
        function showLogin() {
             showSection('login-form');
        }
        
        function showSignup() {
             showSection('signup-form');
        }

        // Handles the persistent sign-up process
        function signUp(event) {
            event.preventDefault();
            const signupBtn = document.getElementById('signup-btn');
            signupBtn.innerHTML = '<i class="fas fa-spinner loading-icon"></i> Processing...';
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            setTimeout(() => {
                user = { name: name, email: email };
                userPassword = password;
                saveData();
                
                isLoggedIn = true; 
                startSession();
                signupBtn.innerHTML = 'Sign Up';
            }, 500);
        }
        
        function logout() {
            if (confirm("Are you sure you want to log out?")) {
                // Keep data but clear session state
                user = null;
                isLoggedIn = false;
                // Clear page history on logout
                pageHistory.length = 0;
                startSession(); 
            }
        }

        // After successful login/signup, show the welcome page and update the sidebar
        function startSession() {
            isLoggedIn = user !== null;

            const managedLinks = [
                'logout-sidebar-link', 'donate-sidebar-link', 'request-sidebar-link', 
                'reports-sidebar-link', 'account-sidebar-link', 'change-password-sidebar-link', 
                'review-sidebar-link', 'awards-sidebar-link'
            ];

            managedLinks.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });

            if (user) {
                document.getElementById('welcomeName').textContent = user.name;
                document.getElementById('accountName').textContent = user.name;
                document.getElementById('accountEmail').textContent = user.email;

                // Show basic logged-in links
                document.getElementById('logout-sidebar-link').style.display = 'flex';
                document.getElementById('donate-sidebar-link').style.display = 'flex';
                document.getElementById('request-sidebar-link').style.display = 'flex';
                document.getElementById('reports-sidebar-link').style.display = 'flex';
                document.getElementById('account-sidebar-link').style.display = 'flex';
                document.getElementById('change-password-sidebar-link').style.display = 'flex';
                document.getElementById('awards-sidebar-link').style.display = 'flex';

                
                const hasReviewed = allReviews.some(r => r.email === user.email && !r.isDummy);
                const reviewLink = document.getElementById('review-sidebar-link');

                if (hasDonatedOrRequested || hasReviewed) {
                    reviewLink.style.display = 'flex';
                } else {
                    reviewLink.style.display = 'none';
                }

                // 1. Check for unconfirmed attendance immediately upon login/session start
                if (checkForUnconfirmedAppointment()) {
                    return; // Stop here and wait for user confirmation
                }
                
                // 2. If all checks pass, show the home page with reminders
                setAppointmentReminder();
                showSection('welcome-page', false);
            } else {
                showSection('main-page', false);
            }
        }
        
        // --- NEW: APPOINTMENT MANAGEMENT LOGIC ---

        // Checks if an appointment from yesterday or earlier needs confirmation
        function checkForUnconfirmedAppointment() {
            if (!unconfirmedDonation || unconfirmedDonation.email !== user.email) {
                return false;
            }

            const todayDate = new Date(getTodayDateString()); // Midnight today
            const appointmentDate = new Date(unconfirmedDonation.date);

            // If appointment date is today or in the future, it's not time for the check yet.
            if (appointmentDate >= todayDate) {
                return false;
            }

            // If the date is past (yesterday or older), force the confirmation popup.
            document.getElementById('unconfirmed-date-display').textContent = formatReadableDate(unconfirmedDonation.date);
            document.getElementById('unconfirmed-hospital-display').textContent = unconfirmedDonation.hospital;
            
            showSection('confirm-attendance-page', false);
            return true;
        }

        // Handles user response from the confirmation page
        function confirmAttendance(attended) {
            if (!unconfirmedDonation) {
                goToHome();
                return;
            }
            
            const donationIndex = allDonations.findIndex(d => d.donationId === unconfirmedDonation.id);
            
            if (attended) {
                // User attended, mark as confirmed and update badge counter
                if (donationIndex !== -1) {
                    allDonations[donationIndex].confirmed = true;
                    alert(`Great job, ${user.name}! Your donation on ${formatReadableDate(unconfirmedDonation.date)} has been officially recorded as **COMPLETED**!`);
                }
                
            } else {
                // User missed it, remove the donation record completely
                if (donationIndex !== -1) {
                    // Remove the donation from allDonations
                    allDonations.splice(donationIndex, 1);
                    alert(`We understand! Your scheduled donation on ${formatReadableDate(unconfirmedDonation.date)} has been **REMOVED** from your records and badges.`);
                }
            }

            // Clear the unconfirmed donation tracker regardless of outcome
            unconfirmedDonation = null;
            saveData();
            
            // Re-render awards and go home
            startSession(); // Re-evaluates reminders and navigation
        }
        
        // Clears the unconfirmed donation tracker and the associated appointment if it's upcoming
        function clearUnconfirmedDonation() {
            if (!unconfirmedDonation) return;

            if (confirm(`Are you sure you want to clear your upcoming appointment for ${formatReadableDate(unconfirmedDonation.date)}? This will remove it from your records.`)) {
                
                const donationIndex = allDonations.findIndex(d => d.donationId === unconfirmedDonation.id);
                
                if (donationIndex !== -1) {
                     // Remove the donation from allDonations
                    allDonations.splice(donationIndex, 1);
                }
                
                unconfirmedDonation = null;
                saveData();
                startSession(); // Refresh
            }
        }
        
        // Displays the reminder banner and card on the welcome page
        function setAppointmentReminder() {
            const reminderBanner = document.getElementById('appointment-reminder');
            const upcomingCard = document.getElementById('upcoming-appointment-card');
            
            reminderBanner.style.display = 'none';
            upcomingCard.style.display = 'none';

            if (!unconfirmedDonation || unconfirmedDonation.email !== user.email) {
                return;
            }
            
            const appointmentDate = unconfirmedDonation.date;
            const todayDate = getTodayDateString();
            
            // Show Reminder Banner if appointment is TODAY or in the FUTURE
            if (new Date(appointmentDate) >= new Date(todayDate)) {
                
                let reminderText = `**REMINDER:** You have an appointment at **${unconfirmedDonation.hospital}** on **${formatReadableDate(appointmentDate)}**!`;
                
                if (appointmentDate === todayDate) {
                    reminderText = `**TODAY'S APPOINTMENT:** Please remember to go to **${unconfirmedDonation.hospital}**!`;
                }

                document.getElementById('reminder-text').innerHTML = reminderText;
                reminderBanner.style.display = 'flex';
                
                 // Show Upcoming Card if appointment is TODAY or in the FUTURE
                 document.getElementById('upcoming-date').textContent = formatReadableDate(unconfirmedDonation.date);
                 document.getElementById('upcoming-hospital').textContent = unconfirmedDonation.hospital;
                 upcomingCard.style.display = 'block';
            }
        }
        
        // --- END: NEW APPOINTMENT MANAGEMENT LOGIC ---
        
        // Donation Flow Functions
        function startDonation() {
            if (!user) {
                alert("Please log in to start a donation.");
                showSection('login-form');
                return;
            }
            
            // Allow the user to proceed, which will overwrite the old appointment in confirmDonation()
            donationData = { name: user.name, email: user.email };
            showSection('age-page');
        }

        function saveAge() {
            const age = document.getElementById('age').value;
            if (!age || age < 18) {
                alert("Please enter a valid age (18 or older).");
                return;
            }
            donationData.age = age;
            showSection('blood-type-page');
        }

        function saveBloodType() {
            const bloodType = document.querySelector('input[name="bloodType"]:checked');
            if (!bloodType) {
                alert("Please select your blood type.");
                return;
            }
            donationData.bloodType = bloodType.value;
            showSection('city-page');
        }

        function saveCity() {
            const city = document.getElementById('city').value;
            const otherCity = document.getElementById('otherCity').value;

            if (city === "" && otherCity.trim() === "") {
                alert("Please select or enter your city.");
                return;
            }
            donationData.city = (city === 'Other' ? otherCity.trim() : city);
            showSection('hospital-page');
        }

        function saveHospital() {
            const hospital = document.getElementById('hospital').value;
            const otherHospital = document.getElementById('otherHospital').value;

            if (hospital === "" && otherHospital.trim() === "") {
                alert("Please select or enter your hospital.");
                return;
            }
            donationData.hospital = (hospital === 'Other' ? otherHospital.trim() : hospital);
            showSection('date-page');
        }
        
        // Helper to find the date of the last WHOLE BLOOD DONATION for the current user
        function findLastDonationDate() {
            if (!user) return null;
            
            // Filter donations by the current user's email AND only confirmed ones
            const userDonations = allDonations.filter(d => d.email === user.email && d.confirmed === true);
            
            if (userDonations.length === 0) return null;
            
            // Sort by date descending and get the most recent one
            userDonations.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Return the Date object of the most recent donation
            return new Date(userDonations[0].date);
        }

        function saveDate() {
            const dateInput = document.getElementById('donationDate');
            const date = dateInput.value;
            
            if (!date) {
                alert("Please select a donation date.");
                return;
            }
            
            // 1. Store the selected date
            donationData.date = date;

            // 2. Check for the 56-day restriction
            const lastDonationDate = findLastDonationDate();
            
            if (lastDonationDate) {
                const selectedDate = new Date(date);
                const requiredWaitTime = 56 * 24 * 60 * 60 * 1000; // 56 days in milliseconds
                const requiredNextDate = new Date(lastDonationDate.getTime() + requiredWaitTime);
                
                // Check if the selected date is LESS than 56 days after the last donation
                if (selectedDate.getTime() < requiredNextDate.getTime()) {
                    // Show Warning Page
                    
                    // Format dates for display
                    const formatDate = (d) => d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    
                    document.getElementById('lastDonationDateDisplay').textContent = formatDate(lastDonationDate);
                    document.getElementById('selectedDonationDateDisplay').textContent = formatReadableDate(date);
                    document.getElementById('nextRecommendedDateDisplay').textContent = formatDate(requiredNextDate);

                    showSection('donation-warning-page');
                    return; // Stop the flow here, the user must decide on the warning page
                }
            }

            // 3. If no last donation or check passes, proceed to next step
            showSection('sickness-page');
        }

        // Function to skip the warning and continue the donation process
        function skipWarning() {
            // Proceed to the next step in the flow (sickness-page)
            showSection('sickness-page');
        }

        function saveSickness() {
            const sickness = document.getElementById('sickness').value.trim();
            if (sickness === "") {
                alert("Please enter any sicknesses, or 'None' if you have none.");
                return;
            }
            donationData.sickness = sickness;
            showReviewPage();
        }

        function showReviewPage() {
            document.getElementById('reviewAge').textContent = donationData.age;
            document.getElementById('reviewBloodType').textContent = donationData.bloodType;
            document.getElementById('reviewCity').textContent = donationData.city;
            document.getElementById('reviewHospital').textContent = donationData.hospital;
            document.getElementById('reviewDate').textContent = formatReadableDate(donationData.date);
            document.getElementById('reviewSickness').textContent = donationData.sickness;
            showSection('review-page');
        }

        // Confirms donation and saves to ALL DONATIONS (NEW BEHAVIOR)
        function confirmDonation() {
            
            // 1. Assign a unique ID and set confirmation state to PENDING (undefined)
            const donationId = Date.now(); 
            const newDonation = { 
                ...donationData, 
                donationId: donationId, 
                // confirmed is undefined by default, meaning scheduled but status TBD
            };

            // 2. Clear any existing unconfirmed/upcoming appointment
            if (unconfirmedDonation && unconfirmedDonation.email === user.email) {
                // If there was an old upcoming appointment, remove it before adding the new one
                const oldDonationIndex = allDonations.findIndex(d => d.donationId === unconfirmedDonation.id);
                if (oldDonationIndex !== -1) {
                    allDonations.splice(oldDonationIndex, 1);
                }
            }

            // 3. Add the new scheduled donation to allDonations (appears immediately in reports)
            allDonations.push(newDonation);
            
            // 4. Update the tracker for the 10 PM check
            unconfirmedDonation = { 
                id: donationId, 
                date: newDonation.date, 
                hospital: newDonation.hospital, 
                email: newDonation.email 
            };
            
            document.getElementById('confirmed-date').textContent = formatReadableDate(newDonation.date);
            
            // Flag that the user has scheduled an interaction
            hasDonatedOrRequested = true;
            saveData();
            
            // Update sidebar state (enables 'Submit Review' if not already done)
            startSession(); 
            
            showSection('thank-you-page');
        }
        
        // Request Blood Flow (No change)
        function startRequest() {
            if (user) {
                showSection('request-blood-page');
            } else {
                alert("Please log in to request blood.");
                showSection('login-form');
            }
        }

        // Submits request and saves to Local Storage (No change)
        function submitRequest() {
            const bloodType = document.getElementById('requestBloodType').value;
            const city = document.getElementById('requestCity').value;
            const otherCity = document.getElementById('otherRequestCity').value;
            const date = document.getElementById('requestDate').value;
            const reason = document.getElementById('requestReason').value.trim();

            if (!bloodType || (city === "" && otherCity.trim() === "") || !date || reason === "") {
                alert("Please fill in all required fields.");
                return;
            }

            const requestData = {
                name: user.name,
                email: user.email,
                bloodType: bloodType,
                city: (city === 'Other' ? otherCity.trim() : city),
                date: date,
                reason: reason
            };
            
            allRequests.push(requestData);
            
            // Flag that the user has completed an interaction
            hasDonatedOrRequested = true;
            saveData();
            
            // Update sidebar state (enables 'Submit Review' if not already done)
            startSession();
            
            showSection('request-thank-you-page');
        }
        
        // --- REVIEW FUNCTIONS (No change in core logic) ---
        
        // NEW FUNCTION: Initiates the review editing process
        function startReviewEdit(reviewIndex) {
            if (!user) {
                alert("Please log in to edit your review.");
                showSection('login-form');
                return;
            }
            
            const reviewToEdit = allReviews[reviewIndex];
            
            // Store the index to be edited in a form data attribute
            document.getElementById('reviewForm').dataset.editIndex = reviewIndex; 

            // Populate form fields
            // Clean up sticker if it's at the start of the comment for editing readability
            const cleanedComment = reviewToEdit.comment.replace(/^(❤️|👍|🌟|😊|🩸)\s*/, '').trim();
            document.getElementById('reviewComment').value = cleanedComment;
            document.getElementById('reviewRating').value = reviewToEdit.rating;

            // Update star display
            document.querySelectorAll('#rating-stars .fa-star').forEach(star => {
                if (parseInt(star.dataset.rating) <= reviewToEdit.rating) {
                    star.classList.add('checked');
                } else {
                    star.classList.remove('checked');
                }
            });

            // Change button text and title for edit mode
            document.querySelector('#review-form-page h2').textContent = "Edit Your Review";
            document.querySelector('#reviewForm button[type="submit"]').textContent = "Update Review";
            
            showSection('review-form-page');
        }
        
        // Handles showing the review form (now defaults to edit if a review exists)
        function showReviewForm() {
            if (!user) {
                alert("Please log in to submit a review.");
                showSection('login-form');
                return;
            }
            
            // Reset form/state for a potentially new review
            document.getElementById('reviewForm').removeAttribute('data-edit-index');
            document.getElementById('reviewForm').reset();
            document.getElementById('reviewRating').value = 0;
            document.querySelector('#review-form-page h2').textContent = "Submit a Review";
            document.querySelector('#reviewForm button[type="submit"]').textContent = "Submit Review";
            document.querySelectorAll('#rating-stars .fa-star').forEach(star => star.classList.remove('checked'));
            
            // Check if user has an existing review and pre-populate for editing
            const existingReviewIndex = allReviews.findIndex(r => r.email === user.email && !r.isDummy);

            if (existingReviewIndex !== -1) {
                // If they click 'Submit Review' and already have one, treat it as an implicit edit
                startReviewEdit(existingReviewIndex);
                return;
            }
            
            showSection('review-form-page');
        }

        // Submits new review or updates existing one
        function submitReview(event) {
            event.preventDefault();
            
            const rating = parseInt(document.getElementById('reviewRating').value);
            const commentInput = document.getElementById('reviewComment');
            let comment = commentInput.value.trim();
            
            if (rating === 0 || comment === "") {
                showMessage('review-feedback', "Please provide a rating and a comment.");
                return;
            }
            
            // Check for sticker to prepend
            const stickerMatch = comment.match(/^(❤️|👍|🌟|😊|🩸)\s*/);
            let sticker = stickerMatch ? stickerMatch[1] : '';

            // If a sticker was added via the click function, prepend it (only if not already there)
            if (!sticker && commentInput.dataset.stickerToPrepend) {
                sticker = commentInput.dataset.stickerToPrepend;
                comment = sticker + ' ' + comment;
            }
            
            // Clear sticker state
            delete commentInput.dataset.stickerToPrepend;
            
            const newReview = { 
                name: user.name, 
                email: user.email, 
                rating: rating, 
                comment: comment, 
                date: new Date().toLocaleDateString('en-US'),
                isDummy: false
            };
            
            const editIndex = document.getElementById('reviewForm').dataset.editIndex;
            let message = "Review submitted successfully!";
            
            if (editIndex !== undefined && editIndex !== '') {
                // EDIT MODE: Update existing review at the stored index
                allReviews[parseInt(editIndex)] = newReview;
                message = "Review updated successfully!";
            } else {
                // NEW REVIEW MODE: Check for existing non-dummy review and replace it (ensuring only one user review exists)
                const existingReviewIndex = allReviews.findIndex(r => r.email === user.email && !r.isDummy);
                if (existingReviewIndex !== -1) {
                    allReviews[existingReviewIndex] = newReview; // Replace old user review
                } else {
                    allReviews.push(newReview); // Add new user review
                }
            }

            saveData();
            startSession(); // Re-check sidebar visibility
            showMessage('review-feedback', message);
            
            // Navigate to thank you page
            showSection('review-thank-you-page');
        }
        
        function showReviewsHistoryPage() {
            renderReviews();
            showSection('reviews-history-page');
        }

        // Renders all reviews and includes the EDIT button for the current user's review
        function renderReviews() {
            const listContainer = document.getElementById('reviews-list-container');
            listContainer.innerHTML = ''; // Clear previous content

            // Sort non-dummy reviews first, then dummy ones, and newest user review first
            const sortedReviews = allReviews.sort((a, b) => {
                // Check if both are the current user's review (for stable sort among real reviews)
                const isAUser = user && a.email === user.email && !a.isDummy;
                const isBUser = user && b.email === user.email && !b.isDummy;
                
                if (isAUser && !isBUser) return -1; // Current user's review comes first
                if (!isAUser && isBUser) return 1;

                if (a.isDummy === b.isDummy) {
                    // Sort non-dummy reviews by date descending (newest first)
                    if (!a.isDummy) {
                        return new Date(b.date) - new Date(a.date);
                    }
                    // Keep dummy order stable
                    return 0; 
                }
                return a.isDummy ? 1 : -1; // Non-dummy reviews appear before dummy ones
            });

            if (sortedReviews.length === 0) {
                listContainer.innerHTML = '<p id="no-reviews-message" style="text-align: center; color: #777;">No reviews have been submitted yet.</p>';
                return;
            }

            sortedReviews.forEach((r, i) => {
                let stars = '';
                for (let j = 1; j <= 5; j++) {
                    stars += `<i class="fas fa-star ${j <= r.rating ? 'checked' : ''}"></i>`;
                }

                let reviewerName = r.name;
                let editButton = '';
                
                // ADD EDIT BUTTON next to the user's non-dummy review
                if (user && r.email === user.email && !r.isDummy) {
                    reviewerName += ' <strong>(You)</strong>';
                    // Pass the index of the review in the ALL_REVIEWS array
                    const reviewIndexInAllReviews = allReviews.findIndex(review => review.email === r.email && !review.isDummy);
                    editButton = `<button class="edit-btn" onclick="startReviewEdit(${reviewIndexInAllReviews})"><i class="fas fa-edit"></i> Edit</button>`;
                } else if (r.isDummy) {
                    // For display purposes, use a simplified name for dummy reviews
                    reviewerName = r.name.split(' ')[0] + ' ' + r.name.split(' ')[1].charAt(0) + '.';
                }
                
                const reviewHtml = `
                    <div class="review-card">
                        <p><strong>${reviewerName}</strong> ${editButton}</p>
                        <p class="card-rating">${stars}</p>
                        <p>${r.comment}</p>
                        <p style="font-size: 0.8rem; color: #999;">Reviewed on: ${r.date}</p>
                    </div>
                `;
                listContainer.innerHTML += reviewHtml;
            });
        }
        
        // Adds a sticker to a data attribute for use when submitting
        function addSticker(element) {
            const sticker = element.dataset.sticker;
            const commentInput = document.getElementById('reviewComment');
            
            // Store sticker to be prepended in submitReview
            commentInput.dataset.stickerToPrepend = sticker;
            
            // Also, update the display value immediately (non-sticky parts only)
            const currentComment = commentInput.value.replace(/^(❤️|👍|🌟|😊|🩸)\s*/, '').trim();
            commentInput.value = sticker + ' ' + currentComment;
            commentInput.focus();
        }


        // --- Star Rating Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const ratingStars = document.getElementById('rating-stars');
            const reviewRatingInput = document.getElementById('reviewRating');

            if (ratingStars) {
                ratingStars.addEventListener('click', (e) => {
                    if (e.target.classList.contains('fa-star')) {
                        const rating = parseInt(e.target.dataset.rating);
                        reviewRatingInput.value = rating;

                        document.querySelectorAll('#rating-stars .fa-star').forEach(star => {
                            if (parseInt(star.dataset.rating) <= rating) {
                                star.classList.add('checked');
                            } else {
                                star.classList.remove('checked');
                            }
                        });
                    }
                });
            }
            
            // Initialize visibility/logic for city/hospital fields
            const citySelect = document.getElementById('city');
            const otherCityInput = document.getElementById('otherCity').parentElement;
            if (citySelect) {
                citySelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        otherCityInput.style.maxHeight = otherCityInput.scrollHeight + "px";
                    } else {
                        otherCityInput.style.maxHeight = '0';
                    }
                });
            }

            const hospitalSelect = document.getElementById('hospital');
            const otherHospitalInput = document.getElementById('otherHospital').parentElement;
            if (hospitalSelect) {
                hospitalSelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        otherHospitalInput.style.maxHeight = otherHospitalInput.scrollHeight + "px";
                    } else {
                        otherHospitalInput.style.maxHeight = '0';
                    }
                });
            }

            const requestCitySelect = document.getElementById('requestCity');
            const otherRequestCityInput = document.getElementById('otherRequestCity').parentElement;
            if (requestCitySelect) {
                requestCitySelect.addEventListener('change', function() {
                    if (this.value === 'Other') {
                        otherRequestCityInput.style.maxHeight = otherRequestCityInput.scrollHeight + "px";
                    } else {
                        otherRequestCityInput.style.maxHeight = '0';
                    }
                });
            }

            // Start the session based on whether a user is loaded from local storage
            startSession();
        });
    </script>
</body>
</html>
